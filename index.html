<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>è—¤å¡šå¤ªé¼“ å‡ºæ¬ ãƒ»äºˆå®š</title>
  
<!-- ===== è¨­å®šï¼ˆå…±é€šï¼‰ v1ï¼šãƒšãƒ¼ã‚¸å…ˆé ­ã«å›ºå®š ===== -->
<script>

  // ãƒ†ã‚¹ãƒˆç”¨
  // å³ä¸‹ğŸ› ãƒœã‚¿ãƒ³ã§ã€ç¾åœ¨ã®ID/ç’°å¢ƒ/ã‚µãƒ¼ãƒå¿œç­”ã‚’å³ç¢ºèª
  (function attachDebugProbe(){
    const btn = document.createElement('button');
    btn.textContent = 'ğŸ› ';
    btn.style.cssText = 'position:fixed;right:8px;bottom:8px;z-index:99999;opacity:.7';
    btn.className = 'btn btn-ghost btn-sm';
    btn.title = 'Debug probe';

    btn.onclick = async () => {
      const idt = (window.liff && liff.getDecodedIDToken) ? liff.getDecodedIDToken() : null;
      const sub = idt?.sub || '(no sub)';
      const env = {
        origin: location.origin,
        LIFF_ID, API_ENDPOINT, ENV_NS,
        sub, name: idt?.name || '', aud: idt?.aud || '', iss: idt?.iss || ''
      };
      const q = s => fetch(API_ENDPOINT + s + '&_=' + Date.now())
                        .then(r=>r.json()).catch(e=>({error:String(e)}));
      const isA = await q(`?isAdmin=1&id=${encodeURIComponent(sub)}`);
      const who = await q(`?whoami=1&id=${encodeURIComponent(sub)}`);
      console.table(env);
      console.log('[isAdmin]', isA);
      console.log('[whoami]', who);
      alert(
        `sub=${sub}\n` +
        `isAdmin: ${isA?.status}/${isA?.isAdmin}\n` +
        `whoami.members: ${Array.isArray(who?.members)?who.members.length:'-'}`
      );
    };
    document.addEventListener('DOMContentLoaded', ()=>document.body.appendChild(btn), {once:true});
  })();

  // ä»¥å¾Œã€ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã ã‘ã‚’æ›´æ–°ã—ã¦ãã ã•ã„
  /* ===== è¨­å®š ===== */
  const FRONT_VERSION = "v1.0.1";  // stable verâ†’v1.0.0
  const LIFF_ID = "2008270687-9qV1G3yq";
  const API_ENDPOINT = "https://script.google.com/macros/s/AKfycbzH4uGB-IhDg5Z2a1FbnZMi42I5Qp0VLWRdXThT3QbYcf59XgVnuPlgwWMKF2n2KPjy/exec";     // GAS v1.0.0

  const ENV_NS = (() => {
    const raw = [location.origin, LIFF_ID, API_ENDPOINT].join('|');
    // çŸ­ã„ãƒãƒƒã‚·ãƒ¥ã§OKï¼ˆdjbx33aï¼‰
    let h = 5381;
    for (const c of raw) h = ((h << 5) + h) ^ c.charCodeAt(0);
    return 'env:' + (h >>> 0).toString(36);
  })();
   (function rememberEnvAndPurge(){
    const K = 'liff:env:current';
    const cur = `${LIFF_ID}|${API_ENDPOINT}`;
    const prev = localStorage.getItem(K);
    if (prev && prev !== cur) {
      Object.keys(localStorage).forEach(k=>{
        if (k.startsWith('liff:')) localStorage.removeItem(k);
      });
    }
    localStorage.setItem(K, cur);
  })();
  
  // ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰è¨­å®šãƒã‚§ãƒƒã‚¯ï¼šé‡è¤‡å®šç¾©ã‚„æœªè¨­å®šã‚’æ—©æœŸã«æ°—ã¥ã‘ã¾ã™
  (function(){
    if (!FRONT_VERSION || !LIFF_ID || !API_ENDPOINT) {
      console.warn("[config] è¨­å®šãŒæœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚FRONT_VERSION/LIFF_ID/API_ENDPOINT ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }
    // window.__APP_CONFIG__ ã¨ã—ã¦ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å‚ç…§ã‚‚å¯
    window.__APP_CONFIG__ = { FRONT_VERSION, LIFF_ID, API_ENDPOINT };
  })();
</script>
<!-- ===== /è¨­å®šï¼ˆå…±é€šï¼‰ v1 ===== -->
  
  <!-- Google Fontsï¼ˆæœ¬æ–‡=ã‚´ã‚·ãƒƒã‚¯ / è¦‹å‡ºã—=æ˜æœï¼‰ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=Noto+Serif+JP:wght@500;600;700&family=Shippori+Mincho:wght@500;700&display=swap"
    rel="stylesheet"
  />
  <!-- Tailwindï¼ˆpreflightç„¡åŠ¹ï¼‰ -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = {
      corePlugins: { preflight: false },
      theme: {
        extend: {
          colors: { primary: '#7f6aa5' },
          boxShadow: { card: '0 2px 10px rgba(0,0,0,0.04)' }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>

  <!-- ===== Base CSS ===== -->
  <style>
    :root{
      --c-bg:#f7f5fa; --c-panel:#fff; --c-border:#e8e2f0;
      --c-text:#202022; --c-muted:#6b6b6b;
      --c-primary:#7f6aa5; --c-primary-2:#6d5a93; --c-accent:#a678b0;
      --c-acc1:#d2e5b1; --c-acc2:#9ce78f; --c-acc2-dark:#6aa96a;
      --c-ok:#0a7; --c-err:#c33;
    }
    body{
      margin:0; color:var(--c-text);
      font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,"Hiragino Sans","Yu Gothic","Meiryo",sans-serif;
      letter-spacing:.02em;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(127,106,165,.05), transparent 40%),
        radial-gradient(900px 500px  at 80% 60%, rgba(127,106,165,.04), transparent 35%),
        var(--c-bg);
    }
    h1,h2,h3{
      font-family: "Shippori Mincho", "Noto Serif JP", "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho", serif;
      letter-spacing: 0.03em;
    }
    .sectionTitle{
      font-family: "Noto Sans JP","Hiragino Sans","Yu Gothic","Meiryo",sans-serif;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    .siteTitle{
      font-family: "Shippori Mincho","Noto Serif JP","Yu Mincho","Hiragino Mincho ProN","MS PMincho",serif !important;
      font-weight: 600; letter-spacing: 0.03em;
    }

    header{
      padding:14px 16px; font-size:18px;
      background:#fff; border-bottom:1px solid var(--c-border);
      display:flex; justify-content:space-between; align-items:center;
    }
    main{ padding:14px 16px; }
    .ver{ font-size:12px; color:#888; font-weight:500; }

    .card{ background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; margin:10px 0; }
    .muted{ color:var(--c-muted); font-size:13px; }
    .row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .row-space{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .right{ text-align:right; }
    .badge{ display:inline-block; font-size:12px; padding:2px 6px; background:var(--c-accent); color:#fff; border-radius:999px; margin-left:8px; }
    .small{ font-size:12px; color:var(--c-muted); }

    [data-view]{ display:none; }
    [data-view].show{ display:block; }

    .spinner{ width:18px; height:18px; border:2px solid #ddd; border-top-color:var(--c-primary); border-radius:50%; animation:spin 1s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    label{ display:block; font-size:14px; margin:6px 0 4px; }
    input[type="text"], input[type="date"], input[type="time"], select, textarea{
      width:100%; border:1px solid var(--c-border); border-radius:8px; padding:8px; font-size:15px; background:#fff;
    }
    .listEmpty{ color:#888; font-size:14px; }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:5px 8px; border-radius:999px; background:#f5f5f5; border:1px solid var(--c-border); }
    .pill.sm{ font-size:11px; padding:2px 6px; }

    .stat-ok{ background:#e8f8f3; border:1px solid #cdeee4; color:#0a7; }
    .stat-ng {
      background:#eef2f7;           /* very light blue-gray */
      border:1px solid #d2d9e3;     /* slightly darker outline */
      color:#334155;                 /* slate-700 ç›¸å½“ï¼ˆæ–‡å­—ã¯ååˆ†æ¿ƒãï¼‰ */
    }
    .stat-pd{ background:#fff7d6; border:1px solid #f3d27a; color:#7a5b00; }
    .stat-na{ background:#f5f5f5; border:1px solid var(--c-border); color:#666; }

    .adminGrid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:700px){ .adminGrid{ grid-template-columns:1fr; } }
    .hint{ font-size:12px; color:#777; }

    .tag{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--c-border); background:#f7f7f7; color:#444; }
    .tag.open{ background:#e8f8f3; border-color:#cdeee4; color:#0a7; }
    .tag.closed{ background:#fdeaea; border-color:#f6cccc; color:#c33; }

    header.is-sticky{ position:sticky; top:0; backdrop-filter:blur(6px); background:rgba(255,255,255,.9); z-index:50; }

    .warnBox{ background:#fff7d6; border:1px solid #f3d27a; padding:10px; border-radius:10px; color:#7a5b00; }

    a.btn, button.btn{
      display:inline-flex; align-items:center; justify-content:center;
      min-height:40px; padding:10px 14px; border-radius:12px;
      border:1px solid var(--c-border); background:#fff; color:var(--c-text);
      text-decoration:none; font-size:15px; font-weight:600; letter-spacing:.01em; line-height:1;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      transition:transform .08s ease, filter .12s ease, box-shadow .12s ease;
      cursor:pointer;
    }
    .btn-primary{
      color:#fff !important;
      border-color:color-mix(in srgb, var(--c-primary-2), #000 6%) !important;
      background-image:linear-gradient(to bottom right, var(--c-primary), var(--c-primary-2)) !important;
      background-color:var(--c-primary) !important;
    }
    .btn-outline{ background:#fff !important; color:var(--c-primary-2) !important; border-color:var(--c-primary-2) !important; }
    .btn-sm{ padding:8px 12px; min-height:36px; font-size:14px; border-radius:10px; }
    .btn-lg{ padding:12px 16px; min-height:44px; font-size:16px; border-radius:14px; }
    .btnRow{ display:flex; flex-wrap:wrap; gap:8px; align-items:stretch; margin:8px 0; }
    .btnRow .btn{ flex:1 1 100%; }
    @media (min-width:600px){
      .btnRow{ display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:10px; }
      .btnRow .btn{ width:100%; }
    }

    /* ===== å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ ===== */
    .fEvent{ border:1px solid var(--c-border); border-radius:12px; background:#fff; margin:10px 0; }
    .fHead{ padding:10px 12px; cursor:pointer; }
    .fHead:hover{ background:#faf8ff; }
    .fBody{ display:none; padding:0 12px 12px; }
    .fEvent.open .fBody{ display:block; }
    .fTitleRow{ display:flex; align-items:baseline; gap:6px; }
    .fTitleRow .t-date{ white-space:nowrap; }
    .fTitleRow .t-place{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; flex:1 1 auto; }
    .fStatusRow{ margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; }
    .fSub{ margin-top:4px; font-size:12px; color:var(--c-muted); }
    .badge-unsaved{
      display:inline-flex; align-items:center; justify-content:center;
      padding:2px 8px; height:22px; border-radius:999px;
      font-size:11px; font-weight:600;
      color:#b45309; border:1.5px solid #f59e0b; background:#fff8e6; white-space:nowrap;
    }
    /* ===== å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ  è¦‹ãŸç›®èª¿æ•´ ===== */
    /* â‘  æ—¥ä»˜ãƒ»æ™‚é–“ãƒ»@å ´æ‰€ ã‚’å¤ªå­—ã« */
    .fTitleRow .t-date,
    .fTitleRow .t-place{
      font-weight: 700;
    }
    
    /* â‘¡ ã‚¬ã‚¤ãƒ‰æ–‡ï¼ˆæ ãªã—ãƒ»èƒŒæ™¯ãªã—ãƒ»æ–‡å­—ã®ã¿ï¼‰ */
    #view-form #formEventsBox.guidePlain{
      background: transparent;
      border: 0;
      padding: 0;
      margin: 4px 0 8px;
    }
    
    /* â‘¢ ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šé¸æŠä¸­ã®è‰²ã‚’å°‘ã—æ¿ƒã„ç´«ã« */
    .fHead{ transition: background-color .12s ease; }
    .fHead:hover{ background: #f5efff; }
    .fEvent.open .fHead{ background: #efe7ff; } /* â†æ¿ƒã„ã‚ã« */
    /* åŒºåˆ†åˆ¥ï¼ˆé–‹ã„ãŸã¨ãï¼‰ */
    .fEvent[data-seg="child"].open .fHead { background:#ffecec; } /* è–„ã„èµ¤ */
    .fEvent[data-seg="adult"].open .fHead { background:#e6f0ff; } /* è–„ã„é’ */
    .fEvent[data-seg="both"].open  .fHead { background:#efe7ff; } /* è–„ã„ç´«ï¼ˆç¾çŠ¶ï¼‰ */
    /* â‘£ åå‰ã®ä¸¸ã„æ ã‚’å»ƒæ­¢ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã« */
    .nameLabel{
      font-weight: 600;
      color: #444;
      /* æ ãƒ»èƒŒæ™¯ãªã— */
      padding: 0;
      border: 0;
      background: transparent;
    }
    
    /* â‘¤ åå‰ã¨å°ã•ã‚ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’åŒä¸€è¡Œã«é…ç½® */
    .row-att{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .attSel{
      min-width: 120px;
      width: auto;
      height: 34px;
      font-size: 14px;
      padding: 6px 10px;
    }
    
    /* â‘¥ ã‚»ãƒ¬ã‚¯ãƒˆã‚’â€œãƒœã‚¿ãƒ³é¢¨â€ï¼ˆç´«æ ãƒ»ç™½èƒŒæ™¯ãƒ»ç´«æ–‡å­—ï¼‰ã« */
    .selectBtn{
      border: 1.5px solid var(--c-primary-2) !important;
      background: #fff !important;
      color: var(--c-primary-2) !important;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(127,106,165,0.14);
    }
    .selectBtn:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(127,106,165,.18);
    }
    /* === å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ  ãƒ˜ãƒƒãƒ€ãƒ¼2è¡ŒåŒ– === */
    .fRow1, .fRow2{ display:flex; align-items:baseline; gap:6px; }
    
    /* 1è¡Œç›®ï¼šå·¦=æ—¥ä»˜æ™‚åˆ» / å³=åŒºåˆ†ãƒãƒƒã‚¸ */
    .fRow1 .t-date{ white-space:nowrap; }
    .fRow1 .seg-badge{ margin-left:auto; }    /* å³ç«¯å¯„ã› */
    
    /* 2è¡Œç›®ï¼šå·¦=ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆçœç•¥å¯ï¼‰ / å³= @å ´æ‰€ï¼ˆ1è¡Œå›ºå®šï¼‰ */
    .fRow2 .t-title{
      min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .fRow2 .t-place{ white-space:nowrap; }
    
    /* æ—¢å­˜ã®å¤ªå­—æŒ‡å®šã‚’æ–°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«ã‚‚é©ç”¨ï¼ˆã‚µã‚¤ã‚ºå¤‰æ›´ãªã—ï¼‰ */
    .fRow1 .t-date,
    .fRow2 .t-place{ font-weight:700; }
    
    /* ===== ã‚¬ã‚¤ãƒ‰ã®èµ¤å¼·èª¿ ===== */
    .em-red{
      color: var(--c-err);
      font-weight: 700;
    }
    
    /* ===== é€ä¿¡ãƒœã‚¿ãƒ³ï¼šé€ä¿¡ä¸­ã¯è–„ã„ç´«ï¼†æ“ä½œä¸å¯ ===== */
    .btn-primary[disabled],
    .btn-primary:disabled{
      background: #ede7ff !important;          /* è–„ã„ç´« */
      border-color: #d6ccff !important;
      color: var(--c-primary-2) !important;
      cursor: not-allowed !important;
      pointer-events: none !important;          /* ã‚¿ãƒƒãƒ—ç„¡åŠ¹ï¼ˆå¤šé‡é€ä¿¡é˜²æ­¢ï¼‰ */
      box-shadow: none !important;
      filter: saturate(.85);
    }
    /* ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã® disabled è¦–è¦š */
    button[disabled],
    .btn[disabled],
    button:disabled,
    .btn:disabled{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* =========================================================
   Schedulesç”¨ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’å°‘ã—ä½ã‚ï¼ˆå‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ ã¨çµ±ä¸€ï¼‰
   â€» æ—¢å­˜ã® .selectBtn ã‚’ä¸Šæ›¸ãã—ã¾ã™ï¼ˆå…¨ãƒšãƒ¼ã‚¸å…±é€šOKï¼‰
   ========================================================= */
    .selectBtn{
      height: 36px;         /* é«˜ã•ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
      min-height: 36px;
      line-height: 34px;    /* ãƒ†ã‚­ã‚¹ãƒˆç¸¦ä½ç½®ã®ãƒãƒ©ãƒ³ã‚¹èª¿æ•´ */
      padding: 0 12px;      /* å·¦å³ã¯ãã®ã¾ã¾ */
      font-size: 14px;      /* å°‘ã—ã ã‘æ§ãˆã‚ */
    }
    
    /* iOS / Safari å¯¾å¿œï¼ˆçŸ¢å°ã®ã‚ºãƒ¬ã‚’æŠ‘åˆ¶ï¼šå¿…è¦ãªã‚‰ï¼‰ */
    .selectBtn::-ms-expand { display: none; }
    .selectBtn {
      -webkit-appearance: none;
      appearance: none;
    }

/* =========================================================
   ã‚´ãƒ¼ã‚¹ãƒˆãƒœã‚¿ãƒ³ï¼ˆ#btnFetchSchedules ãªã©ï¼‰ã‚’ç´«ãƒœãƒ¼ãƒ€ãƒ¼ã«çµ±ä¸€
   æ—¢å­˜ .btn, .btn-sm ã‚’æ´»ã‹ã—ã¦ã€Œè‰²å‘³ã€ã ã‘ã‚’åˆã‚ã›ã¾ã™
   ========================================================= */
    .btn.btn-ghost{
      background: #fff !important;
      color: var(--c-primary-2) !important;
      border: 1px solid color-mix(in srgb, var(--c-primary-2), #000 10%) !important;
      box-shadow: 0 1px 4px rgba(127,106,165, 0.08); /* ã”ãè–„ã„å½± */
      transition: background-color .12s ease, border-color .12s ease, color .12s ease, box-shadow .12s ease;
    }
    .btn.btn-ghost:hover{
      background: color-mix(in srgb, var(--c-primary), #fff 90%) !important; /* ã‚ãšã‹ã«ç´«ãŒä¹—ã‚‹ */
      border-color: var(--c-primary) !important;
      color: var(--c-primary-2) !important;
      box-shadow: 0 2px 8px rgba(127,106,165, 0.12);
    }
    .btn.btn-ghost:focus-visible{
      outline: 2px solid color-mix(in srgb, var(--c-primary), #000 0%) !important;
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary), #fff 80%) !important;
    }
    
    /* é€ä¿¡ä¸­ãªã©ã®ç„¡åŠ¹åŒ–è¦‹ãŸç›®ï¼ˆå…¨ãƒœã‚¿ãƒ³å…±é€šãƒ»å†æ²OKï¼‰ */
    button[disabled],
    .btn[disabled]{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* ================================
   ä»Šå¾Œã®äºˆå®šï¼šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨è¦‹ãŸç›®
   ================================ */
    
    /* 2åˆ—ã‚°ãƒªãƒƒãƒ‰ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æ¨ªä¸¦ã³ã€ä¸‹æ®µã«ãƒœã‚¿ãƒ³ */
    .schedControls{
      display: grid;
      grid-template-columns: auto auto;
      gap: 10px 14px;
      align-items: end;
      justify-content: start; /* æ¨ªå¹…ã‚’å†…å®¹ã‚µã‚¤ã‚ºã«åˆã‚ã›ã‚‹ */
    }
    .schedControls .field{
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .schedControls .span2{
      grid-column: 1 / -1; /* 2åˆ—ã¶ã¡æŠœãã§ä¸‹æ®µã«ãƒœã‚¿ãƒ³ */
    }
    
    /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’çŸ­ã‚å¹…ã«ï¼ˆå†…å®¹é‡ã«å¿œã˜ã¦èª¿æ•´å¯ï¼‰ */
    .schedSel{
      width: 160px;          /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆå¹…ï¼ˆã”å¸Œæœ›ã«å¿œã˜ã¦ 140ã€œ200pxã§å¾®èª¿æ•´å¯ï¼‰ */
      max-width: 100%;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«ã§åˆ—è½ã¡ã—ã¦ã‚‚ç¶ºéº—ã«è¦‹ã›ã‚‹ */
    @media (max-width: 420px){
      .schedControls{
        grid-template-columns: 1fr 1fr; /* 2åˆ—ã®ã¾ã¾ã§ã‚‚OKã€‚1åˆ—ã«ã—ãŸã‘ã‚Œã° 1fr ã« */
      }
      .schedSel{
        width: 100%; /* æ¥µç«¯ã«ç‹­ã„ç«¯æœ«ã§ã¯å…¨å¹…ã«ã—ã¦æ–‡å­—åˆ‡ã‚Œã‚’é˜²æ­¢ */
      }
    }
    
    /* æ–‡å­—ãŒè¦‹åˆ‡ã‚Œã‚‹å¯¾ç­–ï¼šé¸æŠè‚¢å‚ç›´ä½ç½®ã®ã‚¯ãƒªãƒƒãƒ—ã‚’ç·©å’Œ */
    .selectBtn{
      height: 36px;
      min-height: 36px;
      line-height: normal;  /* â† é‡è¦ï¼šiOSã§æ–‡å­—ãŒåˆ‡ã‚Œãªã„ã‚ˆã†å›ºå®šline-heightã‚’è§£é™¤ */
      padding: 6px 12px;    /* ç¸¦ã®ä½™ç™½ã§è¦–èªæ€§ã‚’ç¢ºä¿ */
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
    }
    /* ================================
   ä»Šå¾Œã®äºˆå®šï¼š2è¡Œã®ãƒ©ãƒ™ãƒ«ï½œãƒ—ãƒ«ãƒ€ã‚¦ãƒ³é…ç½®
   ================================ */
    /* ãƒ©ãƒ™ãƒ«ï½œã‚»ãƒ¬ã‚¯ãƒˆ ã®2åˆ—ã‚°ãƒªãƒƒãƒ‰ã€‚è¦ç´ ã¯ [label, select, label, select, span2...] ã®é † */
    .schedControls{
      display: grid;
      grid-template-columns: auto max-content; /* å·¦=ãƒ©ãƒ™ãƒ«ã€å³=ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ */
      gap: 10px 14px;
      align-items: center;
      justify-content: start;
    }    
    /* ãƒœã‚¿ãƒ³ã¯2åˆ—ã¶ã¡æŠœãã§ä¸‹æ®µã¸ */
    .schedControls .span2{
      grid-column: 1 / -1;
    }
    
    /* ãƒ©ãƒ™ãƒ«å´ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆä»»æ„ï¼‰ */
    .scLabel{
      font-size: 14px;
      color: var(--c-text);
      white-space: nowrap;
    }
    
    /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’çŸ­ã‚å¹…ã«ï¼ˆå‰å›ã‚ˆã‚Šâ€œåŠåˆ†â€å¯„ã‚Šã®ã‚µã‚¤ã‚ºï¼‰ */
    .schedSel.short{
      width: 120px;                  /* ç›®å®‰ï¼šå‰å›160px â†’ 120pxã€‚ã•ã‚‰ã«çŸ­ãã—ãŸã‘ã‚Œã° 96ã€œ110pxãªã©ã« */
      max-width: 100%;
    }
    
    /* ç«¯æœ«å¹…ãŒç‹­ã„æ™‚ã®ä¿é™ºï¼šæ–‡å­—ãŒè¦‹åˆ‡ã‚Œãªã„ã‚ˆã†ã« */
    @media (max-width: 420px){
      .schedSel.short{
        width: clamp(100px, 40vw, 128px); /* ç«¯æœ«ã«å¿œã˜ã¦å°‘ã—ä¼¸ç¸® */
      }
    }
    
    /* iOS æ–‡å­—æ¬ ã‘å¯¾ç­–ï¼ˆselectã®ç¸¦è©°ã¾ã‚Šã‚’é¿ã‘ã‚‹ï¼‰ */
    .selectBtn{
      height: 36px;
      min-height: 36px;
      line-height: normal;
      padding: 6px 12px;
      font-size: 14px;
      -webkit-appearance: none;
      appearance: none;
    }
    /* æ°åç·¨é›†(ç™»éŒ²)ãƒšãƒ¼ã‚¸ã®å¾®èª¿æ•´ */
    .regAddRow { 
      margin-top: 12px;               /* ä¸Šã¨è©°ã¾ã‚‰ãªã„ã‚ˆã†ã«ä½™ç™½ã‚’è¿½åŠ  */
    }
    #regNote {
      margin: 6px 0 8px;               /* ã‚¿ã‚¤ãƒˆãƒ«ç›´ä¸‹ã®æ³¨æ„æ›¸ãã®è¡Œé–“ */
      font-size: 12px;
      color: var(--c-muted);
    }
    /* ===== æ¼”å¥è€…è¡Œï¼ˆãƒ©ãƒ™ãƒ«ã¯1è¡Œã€ä¸‹æ®µã§å…¥åŠ›ã¨å‰Šé™¤ã‚’2åˆ—ã«ä¸¦ã¹ã‚‹ï¼‰ ===== */
    /* ===== æ¼”å¥è€…è¡Œï¼šåå‰ 7 / å³ã‚«ãƒ©ãƒ  3ï¼ˆåŒºåˆ†+å‰Šé™¤ï¼‰ ===== */
    .perfRow{
      display: grid;
      grid-template-columns: 7fr 3fr;     /* â† 7:3 */
      grid-auto-rows: auto;
      column-gap: 12px;
      row-gap: 8px;
      margin: 10px 0;
      align-items: center;
    }
    .perfRow .perfLabel{
      grid-column: 1 / -1;               /* ãƒ©ãƒ™ãƒ«ã¯2åˆ—ã¶ã¡æŠœã */
      font-size: 12px;
      color: var(--c-muted);
    }
    .perfRow .regPerf{
      grid-column: 1 / 2;                /* å·¦ï¼šåå‰ */
      width: 100%;
      height: 44px;
    }
    .perfRow .regPerfSeg{
      grid-column: 2 / 3;                /* å³ï¼ˆä¸Šæ®µï¼‰ï¼šåŒºåˆ†ã‚»ãƒ¬ã‚¯ãƒˆ */
      width: 100%;
      height: 44px;
    }
    .perfRow .btn-remove{
      grid-column: 2 / 3;                /* å³ï¼ˆä¸‹æ®µï¼‰ï¼šå‰Šé™¤ãƒœã‚¿ãƒ³ */
      width: 100%;
      min-height: 40px;
      height: 44px;
      padding: 0 12px;
      border-radius: 12px;
      justify-self: stretch;
      align-self: end;
    }
    /* ç‹­ã„ç«¯æœ«ã§ã‚‚ç¶­æŒï¼ˆå¿…è¦ãªã‚‰ 1åˆ—åŒ–ã«ã‚‚ã§ãã¾ã™ï¼‰ */
    @media (max-width: 420px){
      .perfRow{ column-gap: 10px; }
    }
    /* ç„¡åŠ¹ï¼ˆdisabledï¼‰ã®è¦‹ãŸç›®ã‚’çµ±ä¸€ï¼šé›†åˆå ´æ‰€ãƒ»å‡ºæ¬ å¯¾è±¡ãƒ»ç· åˆ‡æ—¥ãƒ»é…ä¿¡ãƒ•ãƒ©ã‚°ãªã© */
    .selectBtn:disabled,
    input[type="date"]:disabled,
    input[type="time"]:disabled,
    input[type="text"]:disabled {
      color: #888 !important;
      background: #f7f5ff !important;         /* ã”ãè–„ã„ç´« */
      border-color: #e6e0f0 !important;
      box-shadow: none !important;
      cursor: not-allowed !important;
    }
    /* ===== åŒºåˆ†ãƒãƒƒã‚¸ï¼ˆâ‘§ï¼‰ ===== */
    .seg-badge{
      display:inline-flex; align-items:center; justify-content:center;
      height:20px; padding:0 8px; border-radius:999px;
      font-size:11px; font-weight:700; white-space:nowrap;
      border:1.5px solid; margin-right:8px;
    }
    .seg-adult { 
      color:#1d4ed8; background:#e6f0ff; border-color:#60a5fa; /* é’ç³»(æ°´è‰²èƒŒæ™¯) */
    }
    .seg-child {
      color:#b91c1c; background:#ffecec; border-color:#f59e9e; /* è½ã¡ç€ã„ãŸèµ¤ */
    }
    .seg-both  {
      color:#6d5a93; background:#f1eaff; border-color:#bda8ea; /* ç´«ç³» */
    }
  </style>

  <!-- Tailwind ã®ä¸Šä¹—ã› -->
  <script type="text/tailwindcss">
    @layer components {
      header { @apply border-b border-[color:var(--c-border)] px-4 py-3 flex items-center justify-between; }
      .card { @apply rounded-xl border bg-[color:var(--c-panel)] p-4 shadow-card border-[color:var(--c-border)]; }
      .sectionTitle { @apply font-bold text-[17px] text-[color:var(--c-text)]; }
      .sectionTitle::after{ content:""; display:block; height:3px; width:72px; margin-top:6px; border-radius:999px;
                            background:linear-gradient(90deg, var(--c-primary) 0%, #c9b8e6 100%); }
      .line { @apply h-px my-3 bg-[color:var(--c-border)]; }
      input[type="text"], input[type="date"], input[type="time"], select, textarea {
        @apply rounded-lg border px-3 py-2 bg-white text-[15px] border-[color:var(--c-border)]
               focus:outline-none focus:ring-2 focus:ring-[color:var(--c-primary)]/25;
      }
      .pill { @apply inline-flex items-center gap-1.5 rounded-full border px-2 py-0.5 text-xs bg-slate-50 border-[color:var(--c-border)] text-slate-700; }
      .pill.sm { @apply text-[11px] px-2 py-0.5; }
      .badge { @apply ml-2 inline-block rounded-full px-2 py-0.5 text-xs text-white; @apply bg-[color:var(--c-accent)]; }
      .tag { @apply inline-block rounded-full px-2 py-0.5 text-xs border bg-slate-50 border-[color:var(--c-border)] text-slate-600; }
      .tag.open   { @apply bg-emerald-50 border-emerald-200 text-emerald-600; }
      .tag.closed { @apply bg-rose-50    border-rose-200    text-rose-600; }
      .stat-ok { @apply bg-emerald-50 border border-emerald-200 text-emerald-700; }
      .stat-ng { @apply bg-rose-50    border border-rose-200    text-rose-700; }
      .stat-pd { @apply bg-amber-50   border border-amber-200   text-amber-700; }
      .stat-na { @apply bg-slate-50   border border-slate-200   text-slate-500; }
      .spinner { border-top-color: rgb(79 70 229); }
    }
  </script>
  <!-- ===== Custom Overridesï¼ˆæœ€å¾Œã«è©•ä¾¡ã•ã‚Œã‚‹CSSï¼‰ ===== -->
  <style id="custom-overrides">
    :root{
      /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ¨ªå¹…ï¼ˆå¿…è¦ã«å¿œã˜ã¦å¾®èª¿æ•´ï¼‰ */
      --attSel-width: 180px;
    }

    /* åå‰ + ã‚»ãƒ¬ã‚¯ãƒˆã‚’åŒã˜è¡Œã«ã€‚å³å´ã®ã‚»ãƒ¬ã‚¯ãƒˆå¹…ã‚’å›ºå®š */
    .row-att{
      display: grid;
      grid-template-columns: 1fr var(--attSel-width);
      gap: 8px;
      align-items: center;
    }

    /* ãƒœã‚¿ãƒ³é¢¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®å¹…ã‚’çµ±ä¸€ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã¨é¸æŠå¾Œã§å¹…ãŒå¤‰ã‚ã‚‰ãªã„ã‚ˆã†ã«ï¼‰ */
    .selectBtn{
      width: var(--attSel-width);
      min-width: var(--attSel-width);
      box-sizing: border-box;
      white-space: nowrap;
      border: 1.5px solid var(--c-primary-2);
      color: var(--c-primary-2);
      background: #fff;
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 600;
    }

    /* ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€è¡Œï¼ˆvalue=""ï¼‰ã®è‰² */
    .selectBtn option[value=""]{
      color: #9aa;
    }

    /* ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã® disabled è¦–è¦šï¼ˆå‰ã«ã”æç¤ºã®ã‚‚ã®ã‚‚ã“ã“ã«ã¾ã¨ã‚ã¦OKï¼‰ */
    button[disabled],
    .btn[disabled]{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* ---- è»½ã„å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆè¦‹ãŸç›®ã‚’ä»–ãƒœã‚¿ãƒ³ã¨å·®åˆ¥åŒ–ï¼‰ ---- */
    .btn-remove{
      background:#fff !important;
      color:#222 !important;                         /* é»’ç³»æ–‡å­— */
      border:1px solid #dcd2ef !important;           /* ã”ãè–„ã„ç´«ã®æ  */
      box-shadow:
        0 2px 10px rgba(127,106,165,0.10),           /* è–„ã„ç´«ã®ã‚½ãƒ•ãƒˆã‚·ãƒ£ãƒ‰ã‚¦ */
        0 1px 0 rgba(0,0,0,0.02) inset;
      transition: transform .08s ease, filter .12s ease, box-shadow .12s ease;
    }
    .btn-remove:hover{
      filter: brightness(0.98);
      box-shadow:
        0 3px 12px rgba(127,106,165,0.16),
        0 1px 0 rgba(0,0,0,0.03) inset;
    }
    .btn-remove:active{
      transform: translateY(1px);
    }
    .btn-remove:focus-visible{
      outline: none;
      box-shadow:
        0 0 0 3px rgba(127,106,165,0.12),            /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«è–„ã„ãƒªãƒ³ã‚° */
        0 2px 10px rgba(127,106,165,0.10);
    }
    /* ç„¡åŠ¹æ™‚ã®è¦–è¦šï¼ˆå…¨ä½“ãƒ«ãƒ¼ãƒ«ã«æº–æ‹ ï¼‰ */
    .btn-remove[disabled]{
      opacity: .55;
      pointer-events: none;
      cursor: not-allowed;
      filter: saturate(.6);
    }
    /* === disabledãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®è¦‹ãŸç›®ã‚’selectã¨çµ±ä¸€ï¼ˆiOS/Safariå¯¾å¿œï¼‰ === */
    input[type="text"]:disabled,
    input[type="date"]:disabled,
    input[type="time"]:disabled,
    textarea:disabled {
      color: #888 !important;                     /* ãƒ†ã‚­ã‚¹ãƒˆè‰² */
      -webkit-text-fill-color: #888 !important;   /* iOS/Safariã§è–„ããªã‚‹ã®ã‚’é˜²ã */
      opacity: 1 !important;                      /* iOSã®é€æ˜åº¦ä½ä¸‹ã‚’æ‰“ã¡æ¶ˆã™ */
      background: #f7f5ff !important;             /* æ—¢å­˜ãƒ«ãƒ¼ãƒ«ã¨çµ±ä¸€ */
      border-color: #e6e0f0 !important;
    }
    
    /* placeholderã‚‚æ¿ƒã•ã‚’çµ±ä¸€ã™ã‚‹ */
    input[type="text"]:disabled::placeholder,
    input[type="date"]:disabled::placeholder,
    input[type="time"]:disabled::placeholder,
    textarea:disabled::placeholder {
      color: #888 !important;
      opacity: 1 !important;
    }
    
    /* Safariæ—§æŒ™å‹•ã®ä¿é™º */
    input[type="text"]:disabled::-webkit-input-placeholder,
    input[type="date"]:disabled::-webkit-input-placeholder,
    input[type="time"]:disabled::-webkit-input-placeholder,
    textarea:disabled::-webkit-input-placeholder {
      color: #888 !important;
      opacity: 1 !important;
    }
    /* ä¸Šéƒ¨ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¸¸æ™‚ã†ã™ç´«ã€openæ™‚ã¯å°‘ã—æ¿ƒã */
    #adminListAcc .fHead{
      background:#f5efff !important;
      border-radius:10px;
    }
    #adminListAcc.open .fHead{
      background:#efe7ff !important;
    }
    /* ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å†…ã®ç·¨é›†ãƒœã‚¿ãƒ³ã‚’å°ã•ã‚ï¼†è–„ã‚ãƒˆãƒ¼ãƒ³ã« */
    #adminListAcc .btn-edit{
      min-height: 32px;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 9px;
      background:#fff !important;
      color: color-mix(in srgb, var(--c-primary-2), #000 0%) !important; /* æ–‡å­—ã¯æ—¢å­˜ã¨åŒç³»è‰² */
      border: 1px solid color-mix(in srgb, var(--c-primary-2), #000 12%) !important; /* æ ã‚’ãƒ¯ãƒ³ãƒˆãƒ¼ãƒ³è–„ã */
      box-shadow: 0 1px 3px rgba(127,106,165,0.08);
    }
    #adminListAcc .btn-edit:hover{
      background:#f8f6ff !important;
      border-color: color-mix(in srgb, var(--c-primary-2), #000 20%) !important;
    }
    /* ç®¡ç†ãƒ•ã‚©ãƒ¼ãƒ ã®ã¿ï¼šæ³¨é‡ˆã®æ–‡å­—ã‚’ã•ã‚‰ã«å°ã•ãï¼ˆ10pxï¼‰ */
    #view-admin .hint{
      font-size: 10px !important;
      line-height: 1.55;
    }
    /* ===== å‡ºæ¬ çµæœä¸€è¦§ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®è¡Œï¼ˆãƒ©ãƒ™ãƒ«å³ã«ã‚»ãƒ¬ã‚¯ãƒˆï¼‰ ===== */
    .repControls{
      display: grid;
      grid-template-columns: auto max-content;
      gap: 10px 14px;
      align-items: center;
      justify-content: start;
    }
    .repLabel{
      font-size: 14px;
      color: var(--c-text);
      white-space: nowrap;
    }
    /* ===== å‡ºæ¬ çµæœä¸€è¦§ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®è¡Œï¼ˆãƒ©ãƒ™ãƒ«å³ã«ã‚»ãƒ¬ã‚¯ãƒˆï¼‰ ===== */
    .repControls{
      display: grid;
      grid-template-columns: auto max-content;
      gap: 10px 14px;
      align-items: center;
      justify-content: start;
    }
    .repLabel{
      font-size: 14px;
      color: var(--c-text);
      white-space: nowrap;
    }
    /* ä¸‹æ®µã«ã€Œå†å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’å·¦å¯„ã›ã§é…ç½® */
    .repControls .span2{
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-start;
      margin-top: 4px;
    }
    /* ===== å‡ºæ¬ ï¼šã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ç‹¬ç«‹è¡Œã«ã—ãŸã¨ãã®ä½™ç™½ï¼ˆæœ€å°CSSï¼‰ ===== */
    .fHead .seg-badge{ margin: 0 0 4px 0; }   /* ä¸Šæ®µãƒãƒƒã‚¸ã®ä¸‹ã«å°‘ã—ä½™ç™½ */
    /* ===== åŒºåˆ†åˆ¥ã®æ è‰²ï¼ˆã‚«ãƒ¼ãƒ‰/è¡Œã‚’å…±é€šã§ï¼‰ ===== */
    :root{
      --seg-child-border:#f59e9e;   /* å­ã©ã‚‚=è–„ã„èµ¤ */
      --seg-adult-border:#93c5fd;   /* å¤§äºº=è–„ã„é’  */
      --seg-both-border:#e8e2f0;    /* ä¸¡æ–¹=è–„ã„ç´«ï¼ˆæ—¢å­˜ï¼‰ */
    }
    /* ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰é¡ï¼ˆãƒˆãƒƒãƒ—/ãƒ•ã‚©ãƒ¼ãƒ /äºˆå®š/ç®¡ç†ä¸€è¦§ï¼‰ */
    .card[data-seg="child"], .fEvent[data-seg="child"], .eventRow[data-seg="child"]{
      border-color: var(--seg-child-border) !important;
    }
    .card[data-seg="adult"], .fEvent[data-seg="adult"], .eventRow[data-seg="adult"]{
      border-color: var(--seg-adult-border) !important;
    }
    .card[data-seg="both"], .fEvent[data-seg="both"], .eventRow[data-seg="both"]{
      border-color: var(--seg-both-border) !important;
    }
    
    /* ===== æ¬ å¸­ãƒãƒƒã‚¸ï¼ˆèµ¤â†’ãƒ–ãƒ«ãƒ¼ã‚°ãƒ¬ãƒ¼ï¼‰ ===== */
    .stat-ng{
      background:#eef2f7 !important;
      border:1px solid #d2d9e3 !important;
      color:#334155 !important;
    }
    
    /* ===== å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ ï¼šé–‹ã„ãŸæ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼è‰²ã‚’åŒºåˆ†åˆ¥ã« ===== */
    .fEvent[data-seg="child"].open .fHead { background:#ffecec !important; } /* å­ã©ã‚‚=æ·¡èµ¤ */
    .fEvent[data-seg="adult"].open .fHead { background:#e6f0ff !important; } /* å¤§äºº=æ·¡é’ */
    .fEvent[data-seg="both"].open  .fHead { background:#efe7ff !important; } /* ä¸¡æ–¹=æ—¢å­˜(ç´«) */
    /* ===== â‘  ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³è‰²ï¼šé–‰ã˜ãŸæ™‚/ãƒ›ãƒãƒ¼æ™‚/é–‹ã„ãŸæ™‚ã‚’åŒºåˆ†åˆ¥ã«çµ±ä¸€ ===== */
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆé–‰ã˜ã¦ã„ã‚‹æ™‚ï¼‰ã¯é€æ˜ã«ã—ã¦æ è‰²ã ã‘è¦‹ã›ã‚‹ */
    .fEvent[data-seg] .fHead{
      background: transparent !important;
    }
    
    /* ãƒ›ãƒãƒ¼æ™‚ */
    .fEvent[data-seg="child"] .fHead:hover { background:#fff5f5 !important; } /* æ·¡ã„èµ¤ */
    .fEvent[data-seg="adult"] .fHead:hover { background:#f2f7ff !important; } /* æ·¡ã„é’ */
    .fEvent[data-seg="both"]  .fHead:hover { background:#f5efff !important; } /* æ—¢å­˜ã®æ·¡ç´« */
    
    /* é–‹ã„ãŸæ™‚ï¼ˆæ—¢ã«è¨­å®šæ¸ˆã¿ã§ã‚‚OKã€‚ã“ã“ã§æœ€çµ‚ä¸Šæ›¸ãï¼‰ */
    .fEvent[data-seg="child"].open .fHead { background:#ffecec !important; }
    .fEvent[data-seg="adult"].open .fHead { background:#e6f0ff !important; }
    .fEvent[data-seg="both"].open  .fHead { background:#efe7ff !important; }
    
    /* ===== â‘¡ è§’ã®ã¯ã¿å‡ºã—å¯¾ç­–ï¼ˆèƒŒæ™¯ã‚’æ å†…ã§ä¸¸ã‚ã¦ã‚¯ãƒªãƒƒãƒ—ï¼‰ ===== */
    .fEvent{
      overflow: hidden;                 /* å­è¦ç´ ã®èƒŒæ™¯ãŒæ å¤–ã¸å‡ºãªã„ã‚ˆã†ã« */
    }
    .fEvent .fHead{
      border-top-left-radius:  inherit; /* ã‚³ãƒ³ãƒ†ãƒŠã®è§’ä¸¸ã«åˆã‚ã›ã‚‹ */
      border-top-right-radius: inherit;
      background-clip: padding-box;     /* Safariç­‰ã®ã«ã˜ã¿å¯¾ç­– */
    }
    
    /* ===== â‘¢ æ¬ å¸­ãƒãƒƒã‚¸ï¼šæ°´è‰²ç³»ã«å¤‰æ›´ï¼ˆæœªå›ç­”ã¨å·®åˆ¥åŒ–ï¼‰ ===== */
    .stat-ng{
      background:#e6f2ff !important;   /* æ·¡ã„æ°´è‰² */
      border:1px solid #bad7ff !important;
      color:#1e3a8a !important;        /* ã‚„ã‚„æ·±ã„é’æ–‡å­— */
    }
    
    /* æœªå›ç­”ï¼ˆç¾çŠ¶ã‚°ãƒ¬ãƒ¼ï¼‰ã®ã¾ã¾ã§OKã€‚å¿…è¦ãªã‚‰ã“ã“ã§å¾®èª¿æ•´ã§ãã¾ã™
    .stat-na{ ... }
    */
    /* === æ°åç·¨é›†ãƒšãƒ¼ã‚¸å°‚ç”¨ã®ä¸Šæ›¸ã === */
    #view-register .perfRow{
      display: grid;
      grid-template-columns: minmax(0, 7fr) minmax(0, 3fr); /* åå‰7 : å³3 */
      grid-auto-rows: auto;
      column-gap: 12px;
      row-gap: 8px;
      align-items: center;
    }
    
    /* ãƒ©ãƒ™ãƒ«ã¯2åˆ—ã¶ã¡æŠœã */
    #view-register .perfRow .perfLabel{ grid-column: 1 / -1; }
    
    /* å·¦ï¼šæ¼”å¥è€…åå…¥åŠ›ã¯å…¨å¹… */
    #view-register .perfRow .regPerf{
      grid-column: 1 / 2;
      width: 100%;
      height: 44px;
    }
    
    /* å³ï¼šåŒºåˆ†ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆä¸Šæ®µï¼‰ãƒ»å‰Šé™¤ï¼ˆä¸‹æ®µï¼‰ã‚’ç¸¦ç©ã¿ & å…¨å¹… */
    #view-register .perfRow .regPerfSeg{
      grid-column: 2 / 3;
      width: 100%;
      height: 44px;
      justify-self: stretch;
    }
    #view-register .perfRow .btn-remove{
      grid-column: 2 / 3;
      width: 100% !important;
      min-height: 40px;
      height: 44px;
      justify-self: stretch;
      align-self: end;
    }
    
    /* ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼šæ°åç·¨é›†ã§ã¯ â€œå›ºå®šå¹…Selectâ€ ã‚’è§£é™¤ã—ã¦å…¨å¹…åŒ– */
    #view-register .selectBtn{
      width: 100% !important;
      min-width: 0 !important;
      box-sizing: border-box;
    }
    
    /* ãƒ¢ãƒã‚¤ãƒ«å¾®èª¿æ•´ */
    @media (max-width: 420px){
      #view-register .perfRow{ column-gap: 10px; }
    }
    /* ===== å‡ºæ¬ çµæœãƒãƒƒã‚¸ï¼ˆç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆï¼‰ ===== */
    .repCard { background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; }
    .repHead { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px; }
    .repTitle { font-weight:700; }
    .repSub   { font-size:12px; color:var(--c-muted); }
    
    .repRow  { display:flex; align-items:baseline; gap:8px; padding:6px 0; border-top:1px dashed #eee; }
    .repRow:first-child { border-top:0; }
    .repName { font-weight:600; min-width:9em; }
    .repAt   { font-size:12px; color:var(--c-muted); }
    
    .badge-att {
      display:inline-flex; align-items:center; justify-content:center;
      height:22px; padding:0 8px; border-radius:999px; font-size:12px; font-weight:700;
      border:1.5px solid;
    }
    .badge-att.yes   { color:#047857; background:#ecfdf5; border-color:#a7f3d0; } /* å‚åŠ =ç·‘ */
    .badge-att.no    { color:#b91c1c; background:#fef2f2; border-color:#fecaca; } /* æ¬ å¸­=èµ¤ */
    .badge-att.maybe { color:#92400e; background:#fffbeb; border-color:#fde68a; } /* æœªå®š=é»„ */
    .badge-att.na    { color:#475569; background:#f1f5f9; border-color:#cbd5e1; } /* ãã®ä»–/ç©º */
    
    .repNA  { margin-top:10px; padding-top:8px; border-top:1px solid var(--c-border); font-size:13px; color:#475569; } 
    /* === ä»Šå¾Œã®äºˆå®šï¼šæ–°ã‚«ãƒ¼ãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆå¾®èª¿æ•´ï¼‰ === */
    .scheduleCard .row1{ display:flex; gap:8px; align-items:center; margin-bottom:4px; }
    .scheduleCard .row2{ font-weight:700; margin:2px 0 0; display:flex; gap:8px; flex-wrap:wrap; }
    .scheduleCard .row2 .date{ white-space:nowrap; }
    .scheduleCard .row2 .title{ min-width:0; }
    .scheduleCard .row3{ font-size:12px; color:#444; margin-top:4px; display:flex; gap:12px; flex-wrap:wrap; }
    
    /* åŒºåˆ†ãƒãƒƒã‚¸ï¼šå°ã•ã™ããŸã®ã§ â€œã‚„ã‚„å°ã•ã‚â€ ã« */
    .seg-badge.sm{
      height:20px;               /* â† 18px â†’ 20px */
      padding:0 8px;             /* â† 6px â†’ 8px */
      font-size:11px;            /* â† 10px â†’ 11px */
    }
    
    /* ç¨®åˆ¥ï¼ˆç™ºè¡¨/ç·´ç¿’/ãã®ä»–ï¼‰ãƒãƒƒã‚¸ï¼šåŒã˜ãâ€œã‚„ã‚„å°ã•ã‚â€ */
    .kind-badge{
      display:inline-flex; align-items:center; justify-content:center;
      height:20px; padding:0 8px; border-radius:999px; font-size:11px;
      border:1.5px solid var(--c-border); background:#f7f7f7; color:#444;
    }
    /* === ç¨®åˆ¥ãƒãƒƒã‚¸ã‚’å³ç«¯ã«ï¼†å››è§’å½¢ã« === */

    /* 1) 1è¡Œç›®ï¼ˆãƒãƒƒã‚¸è¡Œï¼‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ãã®ã¾ã¾Flexã€‚
          ç¨®åˆ¥ãƒãƒƒã‚¸ã ã‘å³ç«¯ã¸å¯„ã›ã‚‹ */
    .scheduleCard .row1 { display:flex; align-items:center; gap:8px; }
    .scheduleCard .row1 .kind-badge { margin-left:auto; }
    
    /* 2) â€œå››è§’ã„â€ç¨®åˆ¥ãƒãƒƒã‚¸ï¼ˆã‚„ã‚„å°ã•ã‚ã®ã¾ã¾ï¼‰
       - ä¸¸ pill â†’ è§’ä¸¸å°‘ãªã‚ã®çŸ©å½¢
       - æ—¢å­˜ã® .kind-badge ã‚’ä¸Šæ›¸ã */
    .kind-badge{
      display:inline-flex; align-items:center; justify-content:center;
      height:20px;               /* å°ã•ã‚ */
      padding:0 10px;            /* å°‘ã—ã ã‘å¹…ã«ã‚†ã¨ã‚Š */
      border-radius:6px;         /* â† 999px ã‹ã‚‰å¤‰æ›´ï¼ˆå››è§’ã„è¦‹ãŸç›®ï¼‰ */
      font-size:11px;
      border:1.5px solid var(--c-border);
      background:#f7f7f7;
      color:#444;
      line-height:1;             /* ç¸¦ä½ç½®ã‚’å®‰å®š */
      white-space:nowrap;        /* æŠ˜ã‚Šè¿”ã—é˜²æ­¢ï¼ˆâ€˜ç™ºè¡¨â€™ç­‰ã¯çŸ­ã„æƒ³å®šï¼‰ */
    }
    
    /* ï¼ˆå‚è€ƒï¼‰åŒºåˆ†ãƒãƒƒã‚¸ã¯â€œã‚„ã‚„å°ã•ã‚â€ã® pill ã®ã¾ã¾ */
    .seg-badge.sm{
      height:20px;
      padding:0 8px;
      font-size:11px;
    }
    /* 3è¡Œç›®ï¼š@å ´æ‰€ ã¨ã€Œé›†åˆâ€¦ã€ã‚’åŒä¸€è¡Œã«ä¿ã¤ */
    .scheduleCard .row3{
      display:flex;
      align-items:baseline;      /* ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’æƒãˆã‚‹ã¨ç¶ºéº— */
      gap:8px;
      flex-wrap:nowrap;          /* â† æŠ˜ã‚Šè¿”ã•ãªã„ */
    }
    
    .scheduleCard .row3 .place{
      flex:1 1 auto;             /* å·¦ã¯å¯å¤‰ */
      min-width:0;               /* â† iOS/Safariã§ellipsisã«å¿…é ˆ */
      overflow:hidden;
      text-overflow:ellipsis;    /* é•·ã„å ´æ‰€åã¯çœç•¥ */
      white-space:nowrap;
    }
    
    .scheduleCard .row3 .meet{
      flex:0 0 auto;             /* å³ã¯å›ºå®šå¹…ï¼ˆæŠ¼ã—å‡ºã•ã‚Œãªã„ï¼‰ */
      white-space:nowrap;        /* å¸¸ã«1è¡Œ */
      margin-left:auto;          /* å³ç«¯å¯„ã› */
    }
    /* ===== ä»Šå¾Œã®äºˆå®šï¼šæŠ˜ã‚ŠãŸãŸã¿ä»˜ãã‚«ãƒ¼ãƒ‰ ===== */
    .scheduleCard{ position:relative; }
    .scTop{ display:flex; align-items:center; gap:8px; margin-bottom:6px; }
    /* ç¨®åˆ¥ï¼å³ç«¯ãƒ»è§’ä¸¸å››è§’ãƒãƒƒã‚¸ */
    .scKind{
      margin-left:auto; display:inline-flex; align-items:center; height:22px;
      padding:0 10px; font-size:12px; font-weight:700;
      background:#f7f7fb; border:1px solid var(--c-border); border-radius:8px; color:#444;
    }
    .scTitleBtn{
      all:unset; display:flex; align-items:baseline; gap:8px; width:100%; cursor:pointer;
    }
    .scTitleBtn .scDate{ font-weight:700; }
    .scTitleBtn .scCaret{ margin-left:auto; transition:transform .12s ease; }
    .scTitleBtn[aria-expanded="true"] .scCaret{ transform:rotate(180deg); }
    /* ã‚¿ã‚¤ãƒˆãƒ«è¡Œï¼š1è¡Œå›ºå®šï¼‹æœ«å°¾â€¦ã€å³ç«¯ã«â–¾ */
    .scTitleBtn{
      all:unset; display:flex; align-items:baseline; gap:8px; width:100%; cursor:pointer;
    }
    .scTitleBtn .scDate{ flex:0 0 auto; font-weight:700; white-space:nowrap; }
    .scTitleBtn .scTitle{
      flex:1 1 auto; min-width:0;            /* â† ã“ã‚ŒãŒãªã„ã¨çœç•¥è¨˜å·ãŒåŠ¹ã‹ãªã„ */
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .scTitleBtn .scCaret{ flex:0 0 auto; margin-left:8px; transition:transform .12s ease; }    
    /* æŠ˜ã‚ŠãŸãŸã¿ãƒ‘ãƒãƒ«ï¼ˆãƒ•ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ï¼ãƒ¡ãƒ¢ï¼å ´æ‰€ï¼‹é›†åˆæƒ…å ±ã‚’ã“ã“ã«ï¼‰ */
    .scPanel{ margin-top:8px; }
    .scFullTitle{ font-weight:700; margin-bottom:6px; }
    .scMemo{
      margin: 6px 0 2px;
      padding: 0;                 /* â† æ å†…ä½™ç™½ã‚‚ä¸è¦ãªã‚‰ 0 ã®ã¾ã¾ */
      border: 0;                  /* â† æ ç·šãªã— */
      background: transparent;    /* â† èƒŒæ™¯ãªã— */
      border-radius: 0;
      font-size: 13px; color:#444;
    }
    .scMeta{ font-size:13px; color:var(--c-text); margin-top:6px; }
    
    /* ç¨®åˆ¥ï¼å³ç«¯ãƒ»å››è§’ãƒãƒƒã‚¸ï¼ˆæ—¢å­˜ï¼‰ */
    .scKind{
      margin-left:auto; display:inline-flex; align-items:center; height:22px;
      padding:0 10px; font-size:12px; font-weight:700;
      background:#f7f7fb; border:1px solid var(--c-border); border-radius:8px; color:#444;
    }   
    /* ã‚«ãƒ¼ãƒ‰å…¨ä½“ãŒã‚¿ãƒƒãƒ—å¯¾è±¡ã¨åˆ†ã‹ã‚‹ã‚ˆã†ã« */
    .scheduleCard{ cursor: pointer; }
    
    /* ã‚¿ã‚¤ãƒˆãƒ«è¡Œã®çŸ¢å°ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã§å¤§ãã‚ï¼‰ */
    .scTitleBtn .scCaret{
      flex:0 0 auto; margin-left:8px;
      font-size: 16px; line-height: 1;   /* è¦‹ã‚„ã™ã */
    }
    /* ===== å‡ºæ¬ çµæœä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰ãƒ»1æšã‚«ãƒ¼ãƒ‰ç‰ˆ ===== */
    .repCard { background:#fff; border:1px solid var(--c-border); border-radius:12px; padding:12px; }
    .repHeader { margin-bottom:6px; }
    .repLine { display:flex; align-items:baseline; gap:8px; }
    .repLeft { display:flex; align-items:baseline; gap:8px; flex-wrap:wrap; min-width:0; }
    .repRight{ margin-left:auto; display:flex; align-items:center; gap:8px; }
    .repTitle { font-weight:700; }
    .repId    { font-size:12px; color:var(--c-muted); }
    .repPlace { white-space:nowrap; }
    .repSep   { color:#cbd5e1; }
    .repHeadRow { padding-bottom:6px; border-bottom:1px dashed #eee; }
    
    .repGroup { margin-top:10px; padding-top:8px; border-top:1px dashed #eee; }
    .repGroupHead{ display:flex; align-items:center; gap:8px; font-weight:700; }
    .repCount{ font-size:12px; color:var(--c-muted); }
    
    .repPersonRow{ display:flex; align-items:baseline; justify-content:space-between; gap:8px; padding:4px 0; }
    .repName{ font-weight:600; min-width:0; overflow-wrap:anywhere; }
    .repAt{ font-size:12px; color:var(--c-muted); white-space:nowrap; }
    
    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/åŒºåˆ†ãƒãƒƒã‚¸ï¼ˆ@apply ã‚’ä½¿ã‚ãšç´”CSSã«ï¼‰ */
    .badge-status{
      display:inline-block;
      border-radius:9999px;
      padding:2px 6px;
      font-size:12px;
      line-height:1;
    }
    .badge-status.open{ background:#ecfdf5; border:1px solid #a7f3d0; color:#047857; }
    .badge-status.closed{ background:#fef2f2; border:1px solid #fecaca; color:#b91c1c; }
    
    /* æ—¢å­˜ã® .badge-att ã‚’ãã®ã¾ã¾è¦‹å‡ºã—ã«ä½¿ã† */
    .badge-att { display:inline-flex; align-items:center; justify-content:center;
      height:22px; padding:0 8px; border-radius:999px; font-size:12px; font-weight:700; border:1.5px solid; }
    .badge-att.yes   { color:#047857; background:#ecfdf5; border-color:#a7f3d0; }
    .badge-att.no    { color:#b91c1c; background:#fef2f2; border-color:#fecaca; }
    .badge-att.maybe { color:#92400e; background:#fffbeb; border-color:#fde68a; }
    .badge-att.na    { color:#475569; background:#f1f5f9; border-color:#cbd5e1; }
    /* ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šé–‹é–‰ã‚’IDã§å¼·åˆ¶è¡¨ç¤º */
    #adminListAcc .fBody { display: none; }
    #adminListAcc.open .fBody { display: block; }
    /* ===== ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šãƒ©ãƒ™ãƒ«ï½œãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®2åˆ—ã‚°ãƒªãƒƒãƒ‰ ===== */
    .adminControls{
      display: grid;
      grid-template-columns: auto max-content; /* å·¦=ãƒ©ãƒ™ãƒ« / å³=ã‚»ãƒ¬ã‚¯ãƒˆ */
      gap: 10px 14px;
      align-items: center;
      justify-content: start;
    }
    .adminControls .span2{
      grid-column: 1 / -1;         /* 2åˆ—ã¶ã¡æŠœãï¼ˆä¸‹æ®µãƒœã‚¿ãƒ³ï¼‰ */
      display: flex;
      justify-content: flex-start;  /* å·¦å¯„ã› */
      margin-top: 4px;
    }
    .admLabel{
      font-size: 14px;
      color: var(--c-text);
      white-space: nowrap;
    }
    
    /* ç«¯æœ«å¹…ãŒç‹­ã„ã¨ãã®ä¿é™ºï¼šã‚»ãƒ¬ã‚¯ãƒˆã¯å…¨å¹…ã«ä¼¸ã°ã™ */
    @media (max-width: 420px){
      .adminControls{
        grid-template-columns: 1fr 1fr;
      }
      .adminControls select{
        width: 100%;
      }
    }
    /* ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³å¹…ã‚’ã•ã‚‰ã«åŠåˆ†ãã‚‰ã„ã« */
    #adminListAcc .schedSel.short{
      width: 100px;      /* 120px â†’ 100pxï¼ˆã€Œ60æ—¥ã€ã€Œï¼ˆã™ã¹ã¦ï¼‰ã€ãŒåã¾ã‚‹å®Ÿç”¨å¹…ï¼‰ */
      max-width: 100%;
    }
    @media (max-width: 420px){
      #adminListAcc .schedSel.short{
        width: clamp(96px, 40vw, 120px);  /* ç«¯æœ«ãŒç‹­ã„æ™‚ã®ä¿é™º */
      }
    }
    /* æ±ç”¨ï¼šã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒœã‚¿ãƒ³ */
    .btn-compact{
      min-height: 30px;    /* æ—¢å­˜ã® .btn-sm(36px) ã‚ˆã‚Šä½ã */
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 9px;
    }
    
    /* ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆè‰²å‘³ã¯æ—¢å­˜ã®ã¾ã¾ã€ã‚µã‚¤ã‚ºã ã‘ï¼‰ */
    #adminListAcc .btn-edit{
      min-height: 30px;
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 9px;
    }
    /* â–¼ ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’â€œåŠåˆ†ã®å¹…â€ã«å›ºå®šï¼ˆå°ç”»é¢ã§ã‚‚å´©ã‚Œãªã„ï¼‰ */
    #adminListAcc .adminControls .schedSel.short{
      width: 100px !important;      /* åŠåˆ†ãã‚‰ã„ã®å®Ÿç”¨å¹… */
      min-width: 100px !important;
    }
    
    /* ä»¥å‰ã®ã€Œ@media (max-width:420px) .adminControls select{ width:100% }ã€ã‚ˆã‚Šã‚‚
       å¼·ã„æŒ‡å®šã§ã€ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³å†…ã ã‘ã¯ 100% ã«åºƒãŒã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    @media (max-width: 420px){
      #adminListAcc .adminControls .schedSel.short{
        width: 100px !important;
        min-width: 100px !important;
      }
    }
    
    /* â–¼ å†å–å¾—ãƒœã‚¿ãƒ³ã‚’â€œç·¨é›†â€ãƒœã‚¿ãƒ³ã¨åŒã˜ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚µã‚¤ã‚ºã« */
    #adminListAcc #btnAdminFetch{
      min-height: 30px;             /* ç·¨é›†ãƒœã‚¿ãƒ³ã¨åŒã˜é«˜ã• */
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 9px;
    }
    /* ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šãƒ˜ãƒƒãƒ€ãƒ¼ã¨æœ€åˆã®è¡Œã®é–“ã«ä½™ç™½ã‚’è¿½åŠ  */
    #adminListAcc .fBody{
      padding-top: 12px !important;   /* â† 10ã€œ14pxã§ãŠå¥½ã¿èª¿æ•´OK */
    }
    
    /* ã•ã‚‰ã«å°‘ã—ä¸‹ã’ãŸã„å ´åˆã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¡Œè‡ªä½“ã«ã‚‚ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ  */
    #adminListAcc .adminControls{
      margin-top: 4px;                 /* å¿…è¦ã«å¿œã˜ã¦ 6ã€œ8px ã« */
    }
    /* ãƒˆãƒƒãƒ—ã®æœªå®š/æœªå›ç­”ã®ã¿è¡¨ç¤ºï¼šãƒãƒƒã‚¸é¢¨ã‚’ã‚„ã‚ã¦ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤º */
    #homeOnlyNALabel{
      display:inline-flex;
      align-items:center;
      gap:6px;
      background:#fff !important;   /* èƒŒæ™¯ã¯ç™½ */
      border:0 !important;           /* æ ãªã— */
      padding:0 !important;          /* ä½™ç™½ã‚‚ãƒ•ãƒ©ãƒƒãƒˆã« */
      box-shadow:none !important;
      font-size:13px;
      color:var(--c-text);
    }
    #homeOnlyNALabel input{
      width:16px; height:16px;
    }
    /* ç®¡ç†ç”¨ã‚«ãƒ¼ãƒ‰ã®3ãƒœã‚¿ãƒ³ã‚’ç·¨é›†ãƒœã‚¿ãƒ³ã¨åŒã‚µã‚¤ã‚ºã«å¼·åˆ¶ */
    #adminMenu a.btn,
    #adminMenu button.btn{
      min-height: 30px !important;
      padding: 6px 10px !important;
      font-size: 13px !important;
      border-radius: 9px !important;
      box-shadow: 0 1px 3px rgba(127,106,165,0.08);
    }

    /* ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆï¼šåå‰â‡”ã‚³ãƒ¡ãƒ³ãƒˆã®é–“ã‚’å›ºå®šã‚®ãƒ£ãƒƒãƒ—ã§ */
    #view-admin-report .repPersonRow{
      display: flex;
      align-items: baseline;
      justify-content: flex-start; /* space-between ã‚’ã‚„ã‚ã‚‹ */
      gap: 16px;                   /* â† ãŠå¥½ã¿ã§ 12â€“20px */
    }
    
    /* å·¦ï¼ˆåå‰ï¼‰ã¯å†…å®¹å¹…ã®ã¾ã¾ / å³ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã¯ä¼¸ç¸®ï¼†æŠ˜ã‚Šè¿”ã— */
    #view-admin-report .repPersonRow .repName { flex: 0 0 auto; }
    #view-admin-report .repPersonRow .repAt   { flex: 1 1 auto; min-width: 0; overflow-wrap: anywhere; }
    
    /* å³ãŒç©ºãªã‚‰éè¡¨ç¤ºï¼ˆè¦‹ãŸç›®ã®ã‚ºãƒ¬é˜²æ­¢ï¼‰ */
    #view-admin-report .repPersonRow .repAt:empty { display:none; }
    /* ã‚³ãƒ¡ãƒ³ãƒˆã®å‰ã«è–„ã„ã€Œï½œã€ã‚’è¡¨ç¤º */
    #view-admin-report .repPersonRow .repAt{
      display:flex;              /* æ—¢ã«æŒ‡å®šæ¸ˆã¿ãªã‚‰ä¸è¦ */
      align-items:baseline;
    }
    
    #view-admin-report .repComment{
      position:relative;
    }
    
    #view-admin-report .repComment::before{
      content: "ï½œ";             /* å…¨è§’ãƒãƒ¼ */
      color: var(--c-muted);     /* è–„ã„è‰²ã§ */
      margin-right: .5em;        /* ãƒãƒ¼ã¨æ–‡å­—ã®é–“éš” */
      opacity: .7;               /* ã•ã‚‰ã«è–„ãã—ãŸã„æ™‚ã¯ 0.5ã€œ0.7 ã§èª¿æ•´ */
    }
    /* 1è¡Œç›®ï¼šå·¦=æ—¥ä»˜æ™‚åˆ»ï¼å³=åŒºåˆ†ãƒãƒƒã‚¸ */
    .fRow1 { display:flex; align-items:baseline; gap:6px; }
    .fRow1 .t-date { white-space:nowrap; }
    /* â† ã‚³ãƒ¬ãŒæ±ºã‚æ‰‹ï¼šåŒºåˆ†ãƒãƒƒã‚¸ã‚’å³ç«¯ã¸ */
    .fRow1 .seg-badge { margin-left:auto !important; }
    /* æœ€å¾Œã«ç½®ãï¼ˆ!important ã§ç¢ºå®Ÿã«ï¼‰ */
    .fRow2{ display:flex; align-items:baseline; gap:6px; }
    /* 2è¡Œç›®ï¼šã‚¿ã‚¤ãƒˆãƒ«ã®ä¼¸é•·ã‚’æ­¢ã‚ã¦ã€@å ´æ‰€ã‚’å³ç«¯ã¸æŠ¼ã—å‡ºã•ãªã„ */
    .fRow2 .t-title{
      flex: 0 1 auto !important;   /* â† ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆï¼ˆgrow ã•ã›ãªã„ï¼‰ */
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .fRow2 .t-place{
      flex: 0 0 auto !important;
      white-space: nowrap;
      margin-left: .5em;            /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ã®é–“ã«å°‘ã—ä½™ç™½ï¼ˆãŠå¥½ã¿ã§ï¼‰ */
    }
    /* === å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ è¦‹å‡ºã—ï¼ˆ2è¡Œç›®ï¼‰ï¼šã‚¿ã‚¤ãƒˆãƒ«ã¨ @å ´æ‰€ã®èª¿æ•´ === */
    .fRow2 .t-title{
      /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’å°‘ã—å°ã•ãï¼‹å¤ªå­— */
      font-size: 15px !important;   /* ãŠå¥½ã¿ã§ 14ã€œ16px ã«èª¿æ•´OK */
      font-weight: 700 !important;  /* å¤ªå­— */
    }
    
    .fRow2 .t-place{
      /* @å ´æ‰€ã¯å°‘ã—å°ã•ãï¼‹å¤ªå­—ã«ã—ãªã„ï¼ˆå‰ã®700æŒ‡å®šã‚’ä¸Šæ›¸ãï¼‰ */
      font-size: 14px !important;   /* ãŠå¥½ã¿ã§ 13ã€œ15px ã«èª¿æ•´OK */
      font-weight: 400 !important;  /* â† normal ã«æˆ»ã™ */
      margin-left: .5em;            /* ã‚¿ã‚¤ãƒˆãƒ«ã¨ã®é–“ã‚’å°‘ã—ç©ºã‘ã‚‹ï¼ˆä»»æ„ï¼‰ */
    }
  </style>
  
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>

<body>
  <header class="is-sticky">
    <div class="siteTitle">è—¤å¡šå¤ªé¼“ å‡ºæ¬ ãƒ»äºˆå®š</div>
    <div class="ver" id="ver"></div>
  </header>

  <main>
    <!-- å‹ã ã¡æœªè¿½åŠ ã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div id="friendAlert" class="card warnBox" style="display:none;">
      ã“ã®LIFFã®BotãŒã€Œå‹ã ã¡è¿½åŠ ã€ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚é€šçŸ¥ã‚’å—ã‘å–ã‚‹ã«ã¯å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
    </div>

    <!-- ===== HOME ===== -->
    <section id="view-home" data-view class="show">
      <div id="hello" class="muted"></div>

      <!-- ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆç®¡ç†è€…ã®ã¿è¡¨ç¤ºï¼‰ -->
     <div id="adminMenu" class="card" style="display:none;">
      <div class="sectionTitle">ç®¡ç†ç”¨</div>
      <div class="row" style="gap:8px;">
        <button id="btnAdminMenuSchedules" class="btn btn-outline btn-sm btn-compact" data-view-target="view-admin">äºˆå®šç™»éŒ²/ç·¨é›†</button>
        <button id="btnAdminMenuReport"    class="btn btn-outline btn-sm btn-compact" data-view-target="view-admin-report">å‡ºæ¬ çµæœä¸€è¦§</button>
        <a href="https://your-domain.github.io/your-repo/summary.html" target="_blank" class="btn btn-outline btn-sm btn-compact">ã‚µãƒãƒª</a>
      </div>
      <div class="small muted" style="margin-top:6px;">â€» ç®¡ç†è€…ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

      <!-- â˜… ãƒˆãƒƒãƒ—æ“ä½œãƒœã‚¿ãƒ³ -->
      <div class="btnRow" aria-label="ä¸»æ“ä½œ">
        <button id="btnPrimary" class="btn btn-primary btn-lg" data-view-target="view-form" disabled>èª­ã¿è¾¼ã¿ä¸­â€¦</button>
        <button id="btnSchedules" class="btn btn-outline btn-lg" data-view-target="view-schedules">ä»Šå¾Œã®äºˆå®š</button>
        <button id="btnEditNames" class="btn btn-outline btn-lg" data-view-target="view-register" style="display:none;">ç™»éŒ²æ°åç·¨é›†</button>
      </div>

      <!-- äº’æ›æ€§ç¶­æŒã®ãŸã‚ã®ãƒ€ãƒŸãƒ¼ -->
      <button id="btnReload" type="button" style="display:none;"></button>

      <!-- å›ç­”å—ä»˜ä¸­ã®å…¬æ¼”ï¼ˆå¯†ãƒªã‚¹ãƒˆï¼‹ãƒãƒƒã‚¸ï¼‰ -->
      <div class="card">
        <div class="row-space">
          <div class="sectionTitle">å›ç­”å—ä»˜ä¸­ã®å…¬æ¼”</div>
          <label id="homeOnlyNALabel" style="margin-left:auto;">
            <input type="checkbox" id="homeOnlyNA" checked>
            æœªå®š/æœªå›ç­”ã®ã¿è¡¨ç¤º
          </label>
        </div>
        <div id="eventsBox"><div class="muted">èª­ã¿è¾¼ã¿ä¸­â€¦ <span class="spinner"></span></div></div>
      </div>

      <!-- ã‚ãªãŸã®ç™»éŒ²çŠ¶æ³ï¼ˆãƒˆãƒƒãƒ—ã§ã¯éè¡¨ç¤ºï¼‰ -->
      <div class="card" style="display:none;">
        <div class="sectionTitle">ã‚ãªãŸã®ç™»éŒ²çŠ¶æ³</div>
        <div id="answersBox" class="muted">ä¼šå“¡æƒ…å ±ç…§ä¼šä¸­â€¦ <span class="spinner"></span></div>
      </div>

      <div id="homeLog" class="muted" style="margin-top:8px;"></div>
    </section>
    <!-- HOME end -->

    <!-- ===== ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆå‡ºæ¬ ï¼‰ ===== -->
    <section id="view-form" data-view>
      <div class="row-space">
        <div class="sectionTitle">å‡ºæ¬ å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </div>
        <button id="btnBackFromForm" class="btn btn-ghost btn-sm" data-view-target="view-home">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>

      <div id="formEventsBox" class="muted guidePlain">å…¬æ¼”èª­ã¿è¾¼ã¿ä¸­â€¦ <span class="spinner"></span></div>
      <div id="formFields"></div>

      <div class="line"></div>
      <div class="row right">
        <button id="btnSubmit" class="btn btn-primary" disabled>ã¾ã¨ã‚ã¦é€ä¿¡</button>
      </div>
      <div id="formLog" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- ===== åˆå›ç™»éŒ²/æ°åç·¨é›† ===== -->
    <section id="view-register" data-view>
      <div class="row-space">
        <div class="sectionTitle" id="regTitle">åˆå›ç™»éŒ²ï¼ˆå…¥åŠ›è€… & æ¼”å¥è€…ï¼‰</div>
        <button id="btnBackFromReg" class="btn btn-ghost btn-sm" data-view-target="view-home">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>

      <div class="card">
        <label for="regInputName">å…¥åŠ›è€…æ°åï¼ˆã‚ãªãŸã®åå‰ï¼‰</label>
        <input type="text" id="regInputName" placeholder="ä¾‹ï¼šå±±ç”° å¤ªéƒ"/>
        <label class="row" style="gap:6px; align-items:center; margin-top:6px;">
          <input type="checkbox" id="regNotify" />
          <span class="small">ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå®›ã¦ã«é€šçŸ¥ï¼ˆé…ä¿¡ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ‰ï¼‰ã‚’é€ã‚‹</span>
        </label>
        <div class="small muted" style="margin:2px 0 8px 24px;">
        â€»é€šçŸ¥ã‚’ã‚ªãƒ•ã«ã™ã‚‹ã¨ã€é…ä¿¡ãƒ»ãƒªãƒã‚¤ãƒ³ãƒ‰ã¯å±Šãã¾ã›ã‚“ï¼ˆäºˆå®šã®é–²è¦§ã¯å¯èƒ½ã§ã™ï¼‰
        </div>
        <div class="line"></div>
        <div class="line"></div>

        <!-- ã‚¿ã‚¤ãƒˆãƒ« + è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆä½™ç™½ã‚’ã¨ã‚‹ãŸã‚ regAddRow ã‚’ä»˜ä¸ï¼‰ -->
        <div class="row-space regAddRow">
          <div class="sectionTitle" style="margin:0;">æ¼”å¥è€…ï¼ˆå®¶æ—ã‚‚è¿½åŠ å¯ï¼‰</div>
          <button id="btnAddPerf" class="btn btn-ghost btn-sm" type="button">ï¼‹ æ¼”å¥è€…ã‚’è¿½åŠ </button>
        </div>
        
        <!-- â€»æ³¨æ„æ›¸ãï¼šã‚¿ã‚¤ãƒˆãƒ«ç›´ä¸‹ã¸ç§»å‹• -->
        <div id="regNote" class="small muted">
          â€» ã‚ãªãŸè‡ªèº«ãŒæ¼”å¥ã™ã‚‹å ´åˆã¯ã€æ¼”å¥è€…ã¨ã—ã¦ã‚ãªãŸã®åå‰ã‚‚è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
        </div>
        
        <!-- æ¼”å¥è€…å…¥åŠ›ãƒªã‚¹ãƒˆ -->
        <div id="perfList"></div>
      </div>

      <div class="row right">
        <button id="btnRegister" class="btn btn-primary">ç™»éŒ²ã™ã‚‹</button>
      </div>
      <div id="regLog" class="muted" style="margin-top:8px;"></div>
    </section>

    <!-- ===== ä»Šå¾Œã®äºˆå®š ===== -->
    <section id="view-schedules" data-view>
      <div class="row-space">
        <div class="sectionTitle">ä»Šå¾Œã®äºˆå®š</div>
        <div class="row" style="gap:8px;">
          <button id="btnBackFromSchedules" class="btn btn-ghost btn-sm" data-view-target="view-home">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
        </div>
      </div>

     <div class="card">
      <div class="schedControls">
        <!-- 1è¡Œç›®ï¼šè¡¨ç¤ºæœŸé–“ï¼ˆæ—¥æ•°ï¼‰ | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
        <label for="selDays" class="scLabel">è¡¨ç¤ºæœŸé–“ï¼ˆæ—¥æ•°ï¼‰</label>
        <select id="selDays" class="selectBtn schedSel short">
          <option value="30">30æ—¥</option>
          <option value="60" selected>60æ—¥</option>
          <option value="90">90æ—¥</option>
        </select>
    
        <!-- 2è¡Œç›®ï¼šç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ | ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
        <label for="selKind" class="scLabel">ç¨®åˆ¥ãƒ•ã‚£ãƒ«ã‚¿</label>
        <select id="selKind" class="selectBtn schedSel short">
          <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
          <option value="ç™ºè¡¨">ç™ºè¡¨</option>
          <option value="ç·´ç¿’">ç·´ç¿’</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
        <!-- 2.5è¡Œç›®ï¼šâ˜… åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä¸¡æ–¹æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºï¼‰ -->
          <label for="selSeg" class="scLabel" id="labSeg" style="display:none;">åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿</label>
          <select id="selSeg" class="selectBtn schedSel short" style="display:none;">
            <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option value="adult">å¤§äººã®éƒ¨</option>
            <option value="child">å­ã©ã‚‚ã®éƒ¨</option>
          </select>
        <!-- ä¸‹æ®µï¼šå†å–å¾—ãƒœã‚¿ãƒ³ï¼ˆ2åˆ—ã¶ã¡æŠœãï¼‰ -->
        <div class="span2">
          <button id="btnFetchSchedules" class="btn btn-ghost btn-sm">æ›´æ–°</button>
        </div>
      </div>
    
      <div id="schedulesBox" class="muted" style="margin-top:8px;">èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­</div>
    </div>    
    </section>

    <!-- ===== äºˆå®šç™»éŒ²ï¼ˆç®¡ç†è€…ï¼‰ ===== -->
    <section id="view-admin" data-view>
      <div class="row-space">
        <div class="sectionTitle">äºˆå®šç™»éŒ²ï¼ˆç®¡ç†è€…ï¼‰</div>
        <button id="btnAdminBack" class="btn btn-ghost btn-sm" data-view-target="view-home">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>
     <!-- â˜… ä¸Šæ®µã®ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼šç¾åœ¨ç™»éŒ²ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§ -->
    <div class="card fEvent" id="adminListAcc">
      <div class="fHead" style="display:flex; align-items:center; justify-content:space-between;">
        <div class="sectionTitle" style="margin:0;">ç¾åœ¨ç™»éŒ²ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§</div>
        <span class="small muted">ã‚¿ãƒƒãƒ—ã§é–‹é–‰</span>
      </div>
    
      <div class="fBody">
        <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼šãƒ©ãƒ™ãƒ«ï½œãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ Ã—2ï¼ˆä¸‹æ®µã«å†å–å¾—ï¼‰ -->
        <div class="adminControls">
          <label for="ad_days" class="admLabel">ä¸€è¦§ã®è¡¨ç¤ºæœŸé–“ï¼ˆæ—¥æ•°ï¼‰</label>
          <select id="ad_days" class="selectBtn schedSel short">
            <option value="30">30æ—¥</option>
            <option value="60" selected>60æ—¥</option>
            <option value="90">90æ—¥</option>
          </select>
    
          <label for="ad_seg_filter" class="admLabel">å¯¾è±¡åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿</label>
          <select id="ad_seg_filter" class="selectBtn schedSel short">
            <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option value="adult">å¤§äºº</option>
            <option value="child">å­ã©ã‚‚</option>
            <option value="both">ä¸¡æ–¹</option>
          </select>
    
          <!-- ä¸‹æ®µï¼š2åˆ—ã¶ã¡æŠœã -->
          <div class="span2">
            <button id="btnAdminFetch" class="btn btn-ghost btn-sm btn-compact" type="button">å†å–å¾—</button>
          </div>
        </div>
    
        <!-- â˜… ä¸€è¦§ã®æç”»å…ˆã¯ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã®ã€ä¸­ã€ -->
        <div id="adminListBoxTop" class="muted" style="margin-top:8px;">èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­</div>
      </div>
    </div>
    <!-- â˜… ã“ã“ã¾ã§ãŒã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ -->
      <div class="card">
        <div class="row-space">
          <div class="sectionTitle" id="adminFormTitle">æ–°è¦ç™»éŒ²</div>
          <div class="small muted"><span id="adminEditingId" style="display:none;"></span></div>
        </div>

        <div class="adminGrid">
          <div><label>ã‚¿ã‚¤ãƒˆãƒ« *</label><input id="ad_title" type="text" placeholder="ä¾‹ï¼šç§‹ç¥­ã‚Šæ¼”å¥ä¼š"></div>
         <!-- ç¨®åˆ¥ *ï¼š "(é¸æŠ)" ã‚’å‰Šé™¤ã—ã€ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ã«ã€‚ã‚¯ãƒ©ã‚¹ selectBtn ã‚’ä»˜ä¸ -->
        <div>
          <label>ç¨®åˆ¥ *</label>
          <select id="ad_type" class="selectBtn" required>
            <option value="" disabled hidden selected>ï¼ˆé¸æŠï¼‰</option>
            <option value="ç™ºè¡¨">ç™ºè¡¨</option>
            <option value="ç·´ç¿’">ç·´ç¿’</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
          </select>
        </div>
          <div><label>æ—¥ä»˜ *</label><input id="ad_ymd" type="date"></div>
          <div><label>æ™‚é–“ï¼ˆé–‹å§‹ï¼‰</label><input id="ad_hm" type="time" placeholder="HH:mm"></div>
          <div><label>å ´æ‰€</label><input id="ad_place" type="text" placeholder="ä¾‹ï¼šè—¤å¡šå°ä½“è‚²é¤¨"></div>
          <div><label>é›†åˆæ™‚é–“ï¼ˆç™ºè¡¨ãƒ»ãã®ä»–ã®ã¿ï¼‰</label><input id="ad_meetAt" type="time" placeholder="HH:mm"></div>
          <div><label>é›†åˆå ´æ‰€</label><input id="ad_meetPlace" type="text" placeholder="ä¾‹ï¼šè—¤å¡šå°å­¦æ ¡"></div>
          <!-- ãƒ•ã‚©ãƒ¼ãƒ ã®å¯¾è±¡é …ç›®è¿½åŠ  -->
          <div>
            <label>å¯¾è±¡åŒºåˆ† *</label>
            <select id="ad_segment" class="selectBtn" required>
              <option value="å­ã©ã‚‚" selected>å­ã©ã‚‚</option>
              <option value="å¤§äºº">å¤§äºº</option>
              <option value="ä¸¡æ–¹">ä¸¡æ–¹</option>
            </select>
          </div>
          <div>
            <label>å‡ºæ¬ å¯¾è±¡ï¼ˆç™ºè¡¨ã®ã¿ï¼‰</label>
            <select id="ad_attendTarget" class="selectBtn">
              <option value="Y">Y</option>
              <option value="N">N</option>
            </select>
          </div>
          <div><label>ç· åˆ‡æ—¥</label><input id="ad_deadline" type="date"></div>
          <div>
            <label>å…¬é–‹</label>
            <select id="ad_publish" class="selectBtn">
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>
          <div>
            <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="ad_status" class="selectBtn">
              <option value="active" selected>active</option>
              <option value="archived">archived</option>
            </select>
          </div>
          <div>
            <label>é…ä¿¡ãƒ•ãƒ©ã‚°ï¼ˆå¿…é ˆï¼šç™ºè¡¨ã®ã¿ï¼‰</label>
            <select id="ad_flag" class="selectBtn"><!-- å‹•çš„ã«å·®ã—æ›¿ãˆ --></select>
          </div>
        </div>

        <div class="hint" style="margin-top:6px;">
          * å¿…é ˆã€‚IDã¯è‡ªå‹•æ¡ç•ªã§ã™ã€‚<br>
          ç¨®åˆ¥ãŒã€Œç·´ç¿’ã€ã®å ´åˆã¯é›†åˆæ™‚é–“/é›†åˆå ´æ‰€/ç· åˆ‡æ—¥/é…ä¿¡ãƒ•ãƒ©ã‚°ç„¡åŠ¹åŒ–ã€‚<br>
          ç¨®åˆ¥ãŒã€Œç™ºè¡¨ã€ä»¥å¤–ã§ã¯ã€Œå‡ºæ¬ å¯¾è±¡ã€ã¯è‡ªå‹•ã§ N å›ºå®šã«ãªã‚Šã¾ã™ã€‚<br>
          ã€Œç™ºè¡¨ã€ã®é…ä¿¡ãƒ•ãƒ©ã‚°ã¯ <b>æ–°è¦ç™»éŒ²æ™‚ã¯ Y/N ã®ã¿</b>ã€<b>ç·¨é›†æ™‚ã¯ Y/S/D/N</b> ãŒé¸æŠå¯èƒ½ã§ã™ã€‚
        </div>

        <div class="row right" style="margin-top:10px;">
          <button id="btnAdminReset"  class="btn btn-ghost btn-sm" type="button">æ–°è¦ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™</button>
          <button id="btnAdminSubmit" class="btn btn-primary">æ–°è¦ç™»éŒ²</button>
        </div>
        <div id="adminFormLog" class="muted" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- ===== å‡ºæ¬ çµæœä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰ ===== -->
    <section id="view-admin-report" data-view>
      <div class="row-space">
        <div class="sectionTitle">å‡ºæ¬ çµæœä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰</div>
        <!-- â‘  ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ã‚’å³å¯„ã› -->
        <button id="btnReportBack" class="btn btn-ghost btn-sm" data-view-target="view-home">ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</button>
      </div>
    
      <div class="card">
        <!-- ãƒ©ãƒ™ãƒ«å³ã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ -->
        <div class="repControls">
          <label for="repEvent" class="repLabel">å…¬æ¼”ã‚’é¸æŠ</label>
          <select id="repEvent" class="selectBtn schedSel short">
            <option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>
          </select>
    
          <label for="repAttend" class="repLabel">å‡ºæ¬ ãƒ•ã‚£ãƒ«ã‚¿</label>
          <select id="repAttend" class="selectBtn schedSel short">
            <option value="">ï¼ˆã™ã¹ã¦ï¼‰</option>
            <option value="å‚åŠ ">å‚åŠ </option>
            <option value="æ¬ å¸­">æ¬ å¸­</option>
            <option value="æœªå®š">æœªå®š</option>
            <option value="æœªå›ç­”">æœªå›ç­”</option>
          </select>
    
          <!-- â˜… å·¦ä¸‹ã«å†å–å¾—ãƒœã‚¿ãƒ³ï¼ˆ2åˆ—ã¶ã¡æŠœãï¼‰ -->
          <div class="span2">
            <button id="btnReportReload" class="btn btn-ghost btn-sm" type="button">æ›´æ–°</button>
          </div>
        </div>
      </div>
    
      <div id="repBox" class="muted">å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    </section>
  </main>

  <!-- ===== å…±é€šï¼šSPAåˆ‡æ›¿ ===== -->
  <script>
    function showView(id){
      document.querySelectorAll('[data-view]').forEach(v => {
        v.classList.toggle('show', v.id === id);
      });
      window.scrollTo({ top: 0, behavior: 'auto' });
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-view-target]').forEach(el => {
        el.addEventListener('click', (ev) => {
          ev.preventDefault();
          const target = el.getAttribute('data-view-target');
          if (target) showView(target);
        });
      });
      document.getElementById('btnReload')?.addEventListener('click', () => location.reload());
      // â† èµ·å‹•ï¼ˆã“ã‚Œã‚’è¿½åŠ ï¼‰
      init();
    });
  </script>

  <!-- ===== HomeEventsUI v7 ===== -->
  <script>
  (function(){
    if (window.HomeEventsUI && window.HomeEventsUI.__v === 7) return;
  
    /* çŠ¶æ…‹ */
    const S = {
      events: [],          // [{id, ymd, hm, place, deadline, isNew, segment}]
      ansMap: {},          // { eventId: [{name, answer}] }
      names : [],          // ç™»éŒ²æ¼”å¥è€…
      onlyNA: true,
      nameSegMap: {}       // { [name]: 'adult'|'child' }
    };
  
    /* å‚ç…§ */
    const E = {
      box : () => document.getElementById('eventsBox'),
      ckN : () => document.getElementById('homeOnlyNA'),
    };
  
    /* è¿½åŠ CSSï¼ˆæœ€å°å¤‰æ›´ï¼‰ */
    const css = document.createElement('style');
    css.textContent = `
      .evList { margin-top: 6px; }
      .eventRow{
        display:block;border:1px solid var(--c-border);border-radius:12px;background:#fff;
        padding:10px 12px;margin:8px 0;
      }
      .eventHead{
        display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px;
      }
      .eventHead-left{ display:flex; align-items:center; gap:6px; }
      .eventHead-right{ display:flex; align-items:center; gap:6px; margin-left:auto; }
      .badge-new{
        display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;height:22px;
        border-radius:999px;font-size:11px;font-weight:600;color: var(--c-primary-2);
        border:1.5px solid var(--c-primary-2);background:#fff;white-space:nowrap;
      }
      .eventTitle{ display:flex; align-items:baseline; gap:4px; font-weight:700; font-size:15px; line-height:1.45; }
      .eventTitle .title-date{ white-space:nowrap; flex:0 0 auto; }
      .eventTitle .title-place{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; min-width:0; flex:1 1 auto; }
      .eventSub{ font-size:12px; color:var(--c-muted); margin-top:2px; }
      .deadline{ color:#666; } .deadline-soon{ color:#c33; font-weight:600; }
      /* åŒºåˆ†ãƒãƒƒã‚¸ã¯æ—¢å­˜ .seg-badge / .seg-adult / .seg-child / .seg-both ã‚’åˆ©ç”¨ */
    `;
    document.head.appendChild(css);
  
    /* Util */
    function parseYmd(s){
      if (!s) return null;
      const m = String(s).match(/(\d{4})[\/\-](\d{2})[\/\-](\d{2})/);
      if (!m) return null;
      const d = new Date(+m[1], +m[2]-1, +m[3]); d.setHours(0,0,0,0);
      return isNaN(d) ? null : d;
    }
    function deadlineClass(deadlineStr){
      const d = parseYmd(deadlineStr); if (!d) return '';
      const today = new Date(); today.setHours(0,0,0,0);
      const diff = Math.floor((d - today)/86400000);
      return (diff <= 3) ? 'deadline-soon' : '';
    }
    function ansClass(v){
      if (!v || v === 'æœªå›ç­”') return 'stat-na';
      if (v === 'æœªå®š')        return 'stat-pd';
      if (v === 'å‚åŠ ')        return 'stat-ok';
      if (v === 'æ¬ å¸­')        return 'stat-ng';
      return 'stat-na';
    }
  
    function summarizeForEvent(ev){
    const evSeg = normSeg(ev.segment || ev.targetSegment || ev.attendSegment || '');
    const answers = Array.isArray(S.ansMap[ev.id]) ? S.ansMap[ev.id] : [];
    const byName = new Map(answers.map(a => [String(a?.name || a?.member || ''), a]));

    const eligible = S.names.filter(n => matchSeg(S.nameSegMap[n], evSeg));

    const total = eligible.length;
    if (total === 0) return { label:'æœªå›ç­”', cls:'stat-na', key:'na' }; // å¿µã®ãŸã‚

    let missing = 0, hasPending = false, decidedCnt = 0;
    for (const n of eligible){
      const rec = byName.get(n);
      if (!rec){ missing++; continue; }
      const v = (rec.answer || '').trim();
      if (v === 'æœªå®š') hasPending = true;
      if (v === 'å‚åŠ ' || v === 'æ¬ å¸­') decidedCnt++;
    }

   if (missing > 0)        return { label:'ä¸€éƒ¨æœªå›ç­”', cls:'stat-pd', key:'partial' };
    if (hasPending)         return { label:'æœªå®šã‚ã‚Š',   cls:'stat-pd', key:'pending' };
    if (decidedCnt === 0)   return { label:'æœªå›ç­”',     cls:'stat-na', key:'na' };
    if (decidedCnt === total) return { label:'å›ç­”æ¸ˆ',   cls:'stat-ok', key:'done' };
    return { label:'ä¸€éƒ¨æœªå›ç­”', cls:'stat-pd', key:'partial' };
  }
  
    function rowHtml(ev, sum){
      const dateStr  = ev.ymd || ev.date || '';
      const hm       = ev.hm || '';
      const place    = ev.place || ev.venue || '';
      const newBadge = (ev.isNew || ev.is_new) ? '<span class="badge-new">NEW</span>' : '';
      const dl       = ev.deadline || ev.limit || ev.deadlineYmd || '';
      const dlCls    = `deadline ${deadlineClass(dl)}`;
      const atMark   = place ? ' @' : '';
      // åŒºåˆ†ï¼ˆå·¦ï¼‰ãƒãƒƒã‚¸
      const segNorm  = normSeg(ev.segment || '');
      const segLbl   = dispSeg(segNorm);
      const segCls   = segNorm==='adult' ? 'seg-adult' : segNorm==='child' ? 'seg-child' : 'seg-both';
      const segBadge = segLbl ? `<span class="seg-badge ${segCls}">${segLbl}</span>` : '';
  
      return `
        <div class="eventRow" data-evt="${ev.id}" data-seg="${segNorm || 'both'}">
          <div class="eventMeta">
            <!-- 1è¡Œç›®ï¼šå·¦=åŒºåˆ† / å³=å›ç­”ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ + NEW -->
            <div class="eventHead">
              <div class="eventHead-left">${segBadge}</div>
              <div class="eventHead-right">
                <span class="pill sm ${sum.cls}">${sum.label}</span>
                ${newBadge}
              </div>
            </div>
  
            <!-- 2è¡Œç›®ï¼šæ—¥ä»˜ æ™‚åˆ» @ å ´æ‰€ -->
            <div class="eventTitle" title="${dateStr}${hm ? ` ${hm}` : ''}${atMark} ${place}">
              <span class="title-date">${dateStr}${hm ? ` <small>${hm}</small>` : ''}${atMark}</span>
              <span class="title-place">${place}</span>
            </div>
  
            <!-- 3è¡Œç›®ï¼šç· åˆ‡ -->
            <div class="eventSub">ç· åˆ‡ï¼š<span class="${dlCls}">${dl || 'â€”'}</span></div>
          </div>
        </div>
        <div class="eventDetail" data-detail="${ev.id}"></div>
      `;
    }
  
    function render(){
      const box = E.box(); if (!box) return;
      const list = (S.events || []).slice().sort((a,b) => {
        const da = parseYmd(a.ymd || a.date) || new Date(8640000000000000);
        const db = parseYmd(b.ymd || b.date) || new Date(8640000000000000);
        return da - db;
      });
      const rows = [];
      for (const ev of list){
        const sum = summarizeForEvent(ev);
        if (S.onlyNA && !(sum.key === 'na' || sum.key === 'partial' || sum.key === 'pending')) continue;
        rows.push(rowHtml(ev, sum));
      }
      box.innerHTML = rows.length ? `<div class="evList">${rows.join('')}</div>`
                                  : '<div class="listEmpty">è©²å½“ã™ã‚‹å…¬æ¼”ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  
      // è©³ç´°: å®¶æ—åˆ¥ãƒãƒƒãƒ—
      box.querySelectorAll('.eventRow').forEach(row => {
        row.addEventListener('click', (e) => {
          if (e.target.closest('.pill, .badge-new, .seg-badge')) return;
          const id  = row.getAttribute('data-evt');
          const det = box.querySelector(`.eventDetail[data-detail="${id}"]`);
          if (!det) return;
          if (det.dataset.loaded !== '1'){
            const arr = S.ansMap[id] || [];
            det.innerHTML = `
              <div class="row" style="gap:6px; flex-wrap:wrap; padding:4px 2px 0 2px;">
                ${arr.map(m => {
                  const name = m?.name || m?.member || '';
                  const v    = m?.answer || 'æœªå›ç­”';
                  return `<span class="pill sm ${ansClass(v)}" title="${v}">${name}</span>`;
                }).join('')}
              </div>`;
            det.dataset.loaded = '1';
          }
          row.classList.toggle('open');
          det.style.display = (det.style.display === 'block') ? 'none' : 'block';
        });
      });
    }
  
    // æœªå›ç­”ã®ã¿ãƒã‚§ãƒƒã‚¯
    document.addEventListener('DOMContentLoaded', () => {
      const n = E.ckN();
      if (n){
        n.checked = true;
        S.onlyNA  = true;
        n.addEventListener('change', () => { S.onlyNA = !!n.checked; render(); });
      }
    });
  
    /* å…¬é–‹API */
    const API = {
      __v: 7,
      mount({events = [], myAnswersMap = {}, performers = [], nameSegMap = {}} = {}){
        S.events = Array.isArray(events) ? events : [];
        S.ansMap = myAnswersMap || {};
        S.names  = Array.isArray(performers) ? performers : [];
        S.nameSegMap = nameSegMap || {};
        const n = E.ckN(); if (n) S.onlyNA = !!n.checked;
        render();
      },
      setEvents(e){ S.events = e || []; render(); },
      setAnswers(a){ S.ansMap = a || {}; render(); },
      setPerformers(arr){ S.names = Array.isArray(arr) ? arr : []; render(); },
      render
    };
    window.HomeEventsUI = API;
    window.renderEventsDense = API.mount;
  
    // è‡ªå‹•ãƒ–ãƒ¼ãƒˆï¼ˆæ—¢å­˜äº’æ›ã¯ãã®ã¾ã¾ï¼‰
    function tryMountFromGlobals(){
      const ev = window.__HOME_EVENTS__;
      const mp = window.__HOME_ANSWERS__;
      const nm = window.__HOME_MEMBERS__ || [];
      if (Array.isArray(ev) && mp && typeof mp === 'object'){
        API.mount({ events: ev, myAnswersMap: mp, performers: nm });
        return true;
      }
      return false;
    }
    window.addEventListener('home:data', (e)=>{
      const d = e.detail || {};
      API.mount({ events: d.events||[], myAnswersMap: d.myAnswersMap||{}, performers: d.performers||[] });
    });
    if (!tryMountFromGlobals()){
      let waited = 0;
      const iv = setInterval(()=>{
        if (tryMountFromGlobals()) { clearInterval(iv); }
        else if ((waited += 300) > 5000) { clearInterval(iv); }
      }, 300);
    }
  
    // ãƒ–ãƒªãƒƒã‚¸é–¢æ•°ï¼ˆäº’æ›ï¼‰
    window.renderHomeFromRaw = function(openList, myFamilyAnswers, membersArray){
      try {
        const events = (openList || []).map(x => ({
          id      : x.id ?? x.eventId ?? x.eid ?? '',
          ymd     : x.ymd ?? x.date ?? '',
          hm      : x.hm ?? x.time ?? '',
          place   : x.place ?? x.venue ?? x.location ?? '',
          deadline: x.deadline ?? x.limit ?? x.deadlineYmd ?? '',
          isNew   : (x.isNew === true) || (x.is_new === 'Y') || (x.new === true),
          segment : x.segment || x.targetSegment || x.attendSegment || x.segmentCode || ""
        }));
  
        const map = {};
        for (const a of (myFamilyAnswers || [])){
          const eid = a.eventId ?? a.id ?? a.eid ?? '';
          if (!eid) continue;
          if (!map[eid]) map[eid] = [];
          map[eid].push({ name: a.name ?? a.member ?? '', answer: (a.answer ?? '').trim() || 'æœªå›ç­”' });
        }
  
        const members = membersArray || (window.state && Array.isArray(window.state.members) ? window.state.members : []);
        const performers = Array.from(new Set(members.map(m => m.performerName).filter(Boolean)));
        const nameSegMap = {};
        members.forEach(m=>{
          const n = (m.performerName||'').trim();
          const s = normSeg(m.segment || m.åŒºåˆ† || '');
          if (n && s) nameSegMap[n] = s;
        });
  
        window.__HOME_EVENTS__   = events;
        window.__HOME_ANSWERS__  = map;
        window.__HOME_MEMBERS__  = performers;
        window.renderEventsDense({ events, myAnswersMap: map, performers, nameSegMap });
      } catch (err){
        console.error('renderHomeFromRaw failed:', err);
      }
    };
  })();
  </script>
  <!-- ===== HomeEventsUI v7 END ===== -->

<script>
/* ===== çŠ¶æ…‹ ===== */
let state = {
  lineId: "",
  name: "",
  isAdmin: false,
  members: [],       // [{lineId,inputName,performerName}]
  events:  [],       // [{eventId,date,time,place,deadline,initialAt,isNew}]
  answers: {},       // { eventId: [...] }
  schedules: [],     // ä»Šå¾Œã®äºˆå®š
  report:   [],      // ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆï¼ˆattendanceReportï¼‰
  schedulesRaw: [],   // â† APIç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å†æç”»ã§ä½¿ç”¨ï¼‰
  adminItemsRaw: [],  // â† ä¸€è¦§ã®ç”Ÿãƒ‡ãƒ¼ã‚¿
  submitting: false, 
  notify: true,        // â˜… è¿½åŠ ï¼šæ—¢å®šã¯ ON
  reportMeta: [],          // ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆç”¨ï¼šè»½é‡ãƒ¡ã‚¿ä¸€è¦§ï¼ˆmeta=1ï¼‰
  reportDetailMap: {},     // { [eventId]: è©³ç´°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ } ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
};

let registerMode = "create"; // "create" | "edit"
let adminMode = "create";    // "create" | "edit"ï¼ˆäºˆå®šç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼‰
let adminEditingId = "";     // ç·¨é›†å¯¾è±¡ID
let adminItemsMap = {};      // ç®¡ç†ä¸€è¦§ã®è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ãƒãƒƒãƒ—ï¼ˆç·¨é›†ãƒœã‚¿ãƒ³ã‹ã‚‰å‚ç…§ï¼‰

/* ===== ãƒ‰ãƒ©ãƒ•ãƒˆï¼ˆä¸€æ™‚ä¿å­˜ï¼‰ ===== */
/* ä¿å­˜ã‚¹ã‚³ãƒ¼ãƒ—ã¯ lineId å˜ä½ã€‚localStorage ã«æ°¸ç¶šåŒ–ã—ã¾ã™ */
let draft = { byEvent: {} }; // { [eventId]: { members: { [name]: "å‚åŠ |æ¬ å¸­|æœªå®š|"" }, comment: "" } }

function draftStorageKey(){
  return `attDraft:${state.lineId || 'guest'}`;
}
function draftLoad(){
  try {
    const raw = localStorage.getItem(draftStorageKey());
    draft = raw ? JSON.parse(raw) : { byEvent:{} };
  } catch(_){
    draft = { byEvent:{} };
  }
}
function draftSave(){
  try { localStorage.setItem(draftStorageKey(), JSON.stringify(draft)); } catch(_){}
}
function draftClear(){
  draft = { byEvent:{} };
  draftSave();
}
function draftEnsure(evId){
  if (!draft.byEvent[evId]) {
    draft.byEvent[evId] = { members:{}, comment:"", commentTouched:false };
  } else {
    // æ—§ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒç„¡ã„å ´åˆã«è£œå®Œï¼‰
    if (!('commentTouched' in draft.byEvent[evId])) {
      draft.byEvent[evId].commentTouched = false;
    }
  }
  return draft.byEvent[evId];
}
function draftSetAttend(evId, name, attend){
  const d = draftEnsure(String(evId));
  if (attend) d.members[name] = attend; else delete d.members[name];
  draftSave();
}
function draftSetComment(evId, comment){
  const d = draftEnsure(String(evId));
  d.comment = comment || "";
  d.commentTouched = true;   // â˜… ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§¦ã£ãŸï¼ˆå‰Šé™¤å«ã‚€ï¼‰ã“ã¨ã‚’è¨˜éŒ²
  draftSave();
}
function draftGetAttend(evId, name){
  const d = draft.byEvent[String(evId)];
  return d && d.members ? (d.members[name] || "") : "";
}
function draftGetComment(evId){
  const d = draft.byEvent[String(evId)];
  return d ? (d.comment || "") : "";
}

// ç¾åœ¨ã® state.events ã‹ã‚‰ã€Œå­˜åœ¨ã™ã‚‹ eventId é›†åˆã€ã‚’ä½œã‚‹
function getOpenEventIdSet(){
  return new Set((state.events||[]).map(e => String(e.eventId ?? e.id ?? "")));
}

// ç”»é¢ã«å­˜åœ¨ã—ãªã„ï¼ˆ=çµ‚äº†/å‰Šé™¤ã•ã‚ŒãŸï¼‰ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‰ãƒ©ãƒ•ãƒˆã‚’æƒé™¤ã™ã‚‹
function pruneDraftAgainstCurrentEvents(){
  const allow = getOpenEventIdSet();
  const byEv = draft.byEvent || {};
  let removed = 0;
  for (const k of Object.keys(byEv)){
    if (!allow.has(String(k))){
      delete byEv[k];
      removed++;
    }
  }
  if (removed > 0){
    draftSave();
    updateSubmitButton();
    console.info(`[draft] pruned ${removed} stale drafts`);
  }
  return removed;
}
  
function draftBuildPayloads(){
  // é€ä¿¡ç›´å‰ã«ã€Œä»Šã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆIDä»¥å¤–ã¯é€ã‚‰ãªã„ã€äºŒé‡å®‰å…¨ç­–
  const allowed = getOpenEventIdSet();

  const result = [];
  for (const [eventId, block] of Object.entries(draft.byEvent || {})){
    if (!allowed.has(String(eventId))) continue;     // â† çµ‚äº†/å‰Šé™¤ã•ã‚ŒãŸIDã¯ç ´æ£„

    const names   = Object.keys(block.members || {});
    const touched = !!block.commentTouched;
    if (names.length === 0 && !touched) continue;    // ä½•ã‚‚å¤‰æ›´ãªã—ã¯é€ã‚‰ãªã„

    const com = block.comment || "";
    names.forEach((name, idx) => {
      const payload = { eventId, performerName: name, attend: block.members[name] || "" };
      if (touched && idx === 0) payload._eventComment = com; // ã‚³ãƒ¡ãƒ³ãƒˆã¯å…ˆé ­1ä»¶ã ã‘
      result.push(payload);
    });
  }
  return result;
}

/* ===== é€ä¿¡ç”¨è£œåŠ©ï¼ˆæœªä¿å­˜ãƒãƒƒã‚¸/é€ä¿¡ãƒœã‚¿ãƒ³æ´»æ€§ï¼‰ ===== */
function hasAnyDraft(){
  const b = draft.byEvent || {};
  return Object.values(b).some(block =>
    (Object.keys(block.members || {}).length > 0) ||
    ((block.comment || "").trim() !== "")
  );
}
function markUnsavedBadge(eventId){
  const card = document.querySelector(`.fEvent[data-evt="${eventId}"]`);
  if (!card) return;
  const headRow = card.querySelector(".fTitleRow");
  if (!headRow) return;
  const cur = headRow.querySelector(".badge-unsaved");
  const dblock = draft.byEvent[String(eventId)];
  const need = !!dblock && (Object.keys(dblock.members||{}).length > 0 || (dblock.comment||"").trim() !== "");
  if (need && !cur){
    headRow.insertAdjacentHTML("beforeend", `<span class="badge-unsaved">æœªä¿å­˜</span>`);
  }else if (!need && cur){
    cur.remove();
  }
}
function updateSubmitButton(){
  const btn = document.getElementById("btnSubmit");
  if (!btn) return;
  const has = hasAnyDraft();      // ä½•ã‹1ã¤ã§ã‚‚æœªé€ä¿¡ãƒ‰ãƒ©ãƒ•ãƒˆãŒã‚ã‚‹ã‹
  btn.disabled = !has;            // ãªã„å ´åˆã¯æŠ¼ã›ãªã„ï¼ˆç©ºé€ä¿¡é˜²æ­¢ï¼‰
  btn.textContent = "ã¾ã¨ã‚ã¦é€ä¿¡"; // ãƒ©ãƒ™ãƒ«ã¯å¸¸ã«çµ±ä¸€
}

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const $ = s => document.querySelector(s);
/* ===== åŒºåˆ†(ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ) æ­£è¦åŒ– & åˆ¤å®šãƒ˜ãƒ«ãƒ‘ãƒ¼ ===== */
const INCLUDE_BOTH_FOR_ALL = true;
// â†‘â‘¡ã®ä»•æ§˜ã«åˆã‚ã›ã¦ falseï¼ˆï¼å¸¸ã«ã€ä¸¡æ–¹ã€ã¯è¡¨ç¤ºå¯¾è±¡ã‹ã‚‰é™¤å¤–ï¼‰
// é‹ç”¨ã§æ–¹é‡å¤‰æ›´ã™ã‚‹å ´åˆã¯ true ã«ã™ã‚‹ã¨ã€å¸¸ã«ã€ä¸¡æ–¹ã€ã‚’è¡¨ç¤ºã«å«ã‚ã‚‰ã‚Œã¾ã™ã€‚
function show(id){ document.querySelectorAll("[data-view]").forEach(v=>v.classList.remove("show")); $(id).classList.add("show"); }
function logHome(t){ $("#homeLog").textContent = t||""; }
function logForm(t){ $("#formLog").textContent = t||""; }
function logReg(t){ $("#regLog").textContent = t||""; }
function logAdmin(t){ $("#adminFormLog").textContent = t||""; }

function z(n){ return String(n).padStart(2,"0"); }
function ymdDow(d){
  if (!(d instanceof Date) || isNaN(d)) return "";
  const yo = "æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[d.getDay()];
  return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())}ï¼ˆ${yo}ï¼‰`;
}
function hmFromTimeCell(v){
  const s = String(v||"").trim();
  const tryDate = new Date(s);
  if (!isNaN(tryDate)) return `${z(tryDate.getHours())}:${z(tryDate.getMinutes())}`;
  const m = s.match(/^(\d{1,2}):(\d{2})$/); 
  if (m) return `${z(m[1])}:${m[2]}`;
  return "";
}
function normSeg(raw){
  const s = String(raw||"").trim().toLowerCase();
  if (!s) return "";
  if (s === "adult" || s.includes("å¤§äºº")) return "adult";
  if (s === "child" || s.includes("å­ã©ã‚‚") || s.includes("å­ä¾›")) return "child";
  if (s === "both"  || s.includes("ä¸¡æ–¹")) return "both";
  return "";
}
function dispSeg(n){ // è¡¨ç¤ºç”¨ãƒ©ãƒ™ãƒ«
  if (n==="adult") return "å¤§äººã®éƒ¨";
  if (n==="child") return "å­ã©ã‚‚ã®éƒ¨";
  if (n==="both")  return "ä¸¡æ–¹";
  return "";
}
// åå‰ã®åŒºåˆ†ï¼ˆadult/child/both/""ï¼‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆã®åŒºåˆ†ã‚’çªãåˆã‚ã›ã‚‹å…±é€šé–¢æ•°
function matchSeg(nameSegRaw, eventSegRaw){
  const ns = normSeg(nameSegRaw);
  const es = normSeg(eventSegRaw);
  if (!es || es === 'both') return true;  // ã‚¤ãƒ™ãƒ³ãƒˆ=ä¸¡æ–¹ â†’ å…¨å“¡å¯¾è±¡
  if (!ns) return true;                   // åå‰å´ãŒä¸æ˜ â†’ é™¤å¤–ã—ãªã„
  return ns === es || ns === 'both';      // åå‰=both â†’ å­/å¤§ã©ã¡ã‚‰ã«ã‚‚åˆè‡´
}
function getMemberSegSet(){
  const segs = new Set();
  (state.members||[]).forEach(m=>{
    const n = normSeg(m.segment || m.åŒºåˆ†);
    if (n) segs.add(n);
  });
  return segs;
}
function userHasBoth(){
  const s = getMemberSegSet();
  return s.has("adult") && s.has("child");
}
  /* --- åŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ --- */
function updateSegFilterUI(){
  // ã€ŒåŒã˜LINEã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§å¤§äºº/å­ã©ã‚‚ä¸¡æ–¹ã®åç°¿ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹ã‹ï¼Ÿã€
  const showIt = userHasBoth();
  const lab = document.getElementById('labSeg');
  const sel = document.getElementById('selSeg');
  if (!lab || !sel) return; // HTMLãŒã¾ã ãªã„å ´åˆã§ã‚‚å®‰å…¨ã«ã‚¹ã‚­ãƒƒãƒ—

  lab.style.display = showIt ? '' : 'none';
  sel.style.display = showIt ? '' : 'none';

  // éè¡¨ç¤ºã«ã—ãŸã¨ãã¯å€¤ã‚’ã‚¯ãƒªã‚¢ï¼ˆï¼å…¨äºˆå®šè¡¨ç¤ºï¼‰
  if (!showIt) {
    sel.value = '';
    // Schedulesãƒ–ãƒ­ãƒƒã‚¯å†…ã®é–¢æ•°ã¯ã‚¯ãƒ­ãƒ¼ã‚¸ãƒ£å†…ãªã®ã§ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«çµŒç”±ã§â€œã‚ã‚Œã°â€å‘¼ã¶
    if (typeof window.__schedSaveFilters === 'function') {
      window.__schedSaveFilters();
    }
  }
}
// ä¿®æ­£å¾Œï¼šincludeBoth ã§ â€œä¸¡æ–¹â€ ã‚’å«ã‚ã‚‹ã‹é¸ã¹ã‚‹ã‚ˆã†ã«
function eventVisibleForUser(eventSegRaw, userSegSet, includeBoth=true){
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒºåˆ†æƒ…å ±ãŒãªã„ â†’ å…¨è¡¨ç¤º
  if (!userSegSet || userSegSet.size === 0) return true;

  const e = normSeg(eventSegRaw);

  // ä¸¡æ–¹æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼
  if (userSegSet.has("adult") && userSegSet.has("child")){
    if (e === "adult" || e === "child") return true;
    if (includeBoth && e === "both")     return true;
    return false;
  }
  // ç‰‡å´æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼
  if (userSegSet.has("adult")){
    return (e === "adult") || (includeBoth && e === "both");
  }
  if (userSegSet.has("child")){
    return (e === "child") || (includeBoth && e === "both");
  }
  return true;
}
function buildNameSegMap(){
   const map = {};
   (state.members||[]).forEach(m=>{
     const n = (m.performerName||"").trim();
     const s = normSeg(m.segment || m.åŒºåˆ†);
     if (!n || !s) return;
     if (!map[n]) { map[n] = s; }
     else if (map[n] !== s) { map[n] = 'both'; } // å­ã¨å¤§ãŒæ··åœ¨ â†’ both
   });
   return map;
 }
// å³å¯†ã«æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
function parseYmdStrict(s){
  const m = String(s||"").match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
  if (!m) {
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }
  const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
  const dt = new Date(y, mo-1, d);
  return isNaN(dt) ? null : dt;
}
function esc(s){ return encodeURIComponent(String(s||"")); }
function toYmdSlashFromDateInput(v){ // "yyyy-mm-dd" -> "yyyy/MM/dd"
  if (!v) return "";
  const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  return m ? `${m[1]}/${m[2]}/${m[3]}` : "";
}
function toDateInputFromYmdSlash(v){ // "yyyy/MM/dd" -> "yyyy-mm-dd"
  const m = String(v||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  return m ? `${m[1]}-${m[2]}-${m[3]}` : "";
}
function hasPerformers(){
  return (state.members||[]).some(m => !!String(m.performerName||'').trim());
}
function isViewer(){
  // ã‚µãƒ¼ãƒãŒ viewerOnly ã‚’è¿”ã—ã¦ãã‚Œã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
  if (typeof state.viewerOnly === 'boolean') return state.viewerOnly;
  // ãã‚ŒãŒç„¡ã„å ´åˆã¯ã€Œæ¼”å¥è€…ã‚¼ãƒ­ ã‹ã¤ é€šçŸ¥OFFã€ã§æ¨å®š
  return !hasPerformers() && state.notify === false;
}
/* Google Calendar è¿½åŠ URL */
const DFLT_MIN = { "ç™ºè¡¨":90, "ç·´ç¿’":150, "ãã®ä»–":60 };
function toDatesParam(ymdStr, hmStr, kind){
  const m = String(ymdStr||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
  if (!m) return "";
  const H = hmStr ? Number(hmStr.split(":")[0]) : 0;
  const M = hmStr ? Number(hmStr.split(":")[1]) : 0;
  const st = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]), H, M, 0);
  const mins = DFLT_MIN[kind] || 60;
  const ed = new Date(st.getTime() + mins*60000);
  const fmt = (d)=>`${d.getFullYear()}${z(d.getMonth()+1)}${z(d.getDate())}T${z(d.getHours())}${z(d.getMinutes())}00`;
  return `${fmt(st)}/${fmt(ed)}`;
}
function makeGoogleCalUrl(title, ymd, hm, place, kind, memo){
  const base = "https://calendar.google.com/calendar/render?action=TEMPLATE";
  const dates = toDatesParam(ymd, hm, kind);
  const params = [
    `text=${esc(title)}`,
    dates ? `dates=${dates}` : "",
    place ? `location=${esc(place)}` : "",
    memo  ? `details=${esc(memo)}` : "",
    `ctz=${esc("Asia/Tokyo")}`
  ].filter(Boolean).join("&");
  return `${base}&${params}`;
}

/* ===== API ===== */
async function api(path, { signal } = {}){
  const ctrl = new AbortController();
  const t = setTimeout(()=> ctrl.abort("timeout"), 15000); // 15s
  try{
    const r = await fetch(API_ENDPOINT + path, { signal: signal || ctrl.signal });
    clearTimeout(t);
    return await r.json();
  }catch(e){
    clearTimeout(t);
    // 1å›ã ã‘å³ãƒªãƒˆãƒ©ã‚¤ï¼ˆçŸ­ã‚ï¼‰
    await new Promise(res => setTimeout(res, 400));
    const r2 = await fetch(API_ENDPOINT + path);
    return await r2.json();
  }
}

/* ===== åˆæœŸåŒ– ===== */
async function init(){
  try{
    $("#ver").textContent = FRONT_VERSION;

    try {
   await liff.init({ liffId: LIFF_ID });
 } catch (e) {
   console.error('[LIFF init failed]', e);
   const msg = (e && e.message) ? e.message : String(e);
   document.getElementById('eventsBox').innerHTML =
     `<span class="err">LIFFåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${msg}</span>`;
   return; // ã“ã“ã§ä¸­æ–­
 }
    if (!liff.isLoggedIn()){ liff.login(); return; }

    if (liff.getFriendship){
      try{
        const fr = await liff.getFriendship();
        if (fr && fr.friendFlag===false) $("#friendAlert").style.display="";
      }catch(_){}
    }

    const idt = liff.getDecodedIDToken();
    state.lineId = idt ? idt.sub : "";
    state.name   = idt && idt.name ? idt.name : "";
    $("#hello").textContent = state.name ? `ã“ã‚“ã«ã¡ã¯ã€${state.name} ã•ã‚“` : "";

    /* â˜… lineIdãŒç¢ºå®šã—ãŸã‚‰ã€ãƒ‰ãƒ©ãƒ•ãƒˆã‚’å¾©å…ƒ */
    draftLoad();

    bindHandlers();
    resetRegisterForm();

    // Admin åˆ¤å®š
    try{
      const j = await api(`?isAdmin=1&id=${esc(state.lineId)}`);
      state.isAdmin = (j.status==="ok" && !!j.isAdmin);
      // ç®¡ç†ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ‡æ›¿
      $("#adminMenu").style.display = state.isAdmin ? "" : "none";
    }catch(_){ state.isAdmin = false; $("#adminMenu").style.display="none"; }

    await refreshData();
  }catch(err){
    $("#eventsBox").innerHTML = `<span class="err">åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message||err}</span>`;
  }
}

/* ===== ã‚¯ãƒªãƒƒã‚¯ãƒã‚¤ãƒ³ãƒ‰ ===== */
function bindHandlers(){
  $("#btnReload").onclick      = async ()=>{ logHome("å†èª­ã¿è¾¼ã¿ä¸­â€¦"); await refreshData(); logHome(""); };
  $("#btnPrimary").onclick     = onPrimary;
  $("#btnEditNames").onclick   = onEditNames;
  $("#btnBackFromForm").onclick = () => {
    if (state.submitting) return;       // é€ä¿¡ä¸­ã¯é·ç§»ã•ã›ãªã„
    show("#view-home");
  };
  $("#btnBackFromReg").onclick = ()=> show("#view-home");
  $("#btnSubmit").onclick      = onSubmit;

  $("#btnAddPerf").onclick     = ()=> addPerformerField("");
  $("#btnRegister").onclick    = onRegister;

  $("#btnSchedules").onclick   = ()=>{ 
     show("#view-schedules"); 
     updateSegFilterUI(); 
     window.__schedLoadFilters?.();   // â† è¿½åŠ ï¼šå‰å›ã®é¸æŠã‚’å¾©å…ƒ
     window.renderSchedules(true); 
   };
  $("#btnBackFromSchedules").onclick = ()=> show("#view-home");
  $("#btnFetchSchedules").onclick    = ()=> window.renderSchedules(true);
  // ç®¡ç†ï¼šã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´ã§å³ãƒ­ãƒ¼ã‚«ãƒ«æç”»
  document.getElementById('ad_days')?.addEventListener('change', adminListRenderLocal);
  document.getElementById('ad_seg_filter')?.addEventListener('change', adminListRenderLocal);
  // ã€Œä¸€è¦§ã‚’å–å¾—ã€ã¯æœ¬å½“ã«ã‚µãƒ¼ãƒãƒ¼å†å–å¾—
  $("#btnAdminFetch").onclick = ()=> adminListFetch();
  // ãƒ¬ãƒãƒ¼ãƒˆ
  $("#btnReportBack").onclick = ()=> show("#view-home");
  $("#btnReportReload").onclick = ()=> reportReload();
  $("#repAttend").addEventListener("change", renderReport);
  document.getElementById('repEvent')?.addEventListener('change', renderReport);
  
  // ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆHOMEï¼‰
  $("#btnAdminMenuSchedules").onclick = ()=>{
    if (!state.isAdmin){ alert("ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™"); return; }
    show("#view-admin");
    window.setupAdminAccordion?.();
    enterAdminCreateMode();
    adminListFetch();
  };
  $("#btnAdminMenuReport").onclick = ()=>{
    if (!state.isAdmin){ alert("ç®¡ç†è€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™"); return; }
    show("#view-admin-report");
    reportReload();
  };

  // ç®¡ç†ç”»é¢
  $("#btnAdminBack").onclick = ()=> show("#view-home");
  document.getElementById('btnAdminReload')
    ?.addEventListener('click', ()=> adminListFetch());
  $("#btnAdminFetch").onclick = ()=> adminListFetch();
  $("#btnAdminSubmit").onclick = ()=> adminSubmit();
  $("#btnAdminReset").onclick = ()=> enterAdminCreateMode();
  $("#ad_type").addEventListener("change", adminTypeChangeAdapt);
  
  // ç®¡ç†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã«ç›´æ¥ï¼šclick/Enter/Spaceã€ã‚­ãƒ£ãƒ—ãƒãƒ£ã§ç¢ºå®Ÿã«æ‹¾ã†ï¼‰
   function setupAdminAccordion(){
    const acc  = document.getElementById('adminListAcc');
    if (!acc) return;
    if (acc.__bound) return;           // â˜… ã‚‚ã†çµã‚“ã§ãŸã‚‰ä½•ã‚‚ã—ãªã„
    acc.__bound = true;
  
    const head = acc.querySelector('.fHead');
    const body = acc.querySelector('.fBody');
    if (!head || !body) return;
  
    const sync = () => {
      const open = acc.classList.contains('open');
      head.setAttribute('role', 'button');
      head.setAttribute('tabindex', '0');
      head.setAttribute('aria-expanded', open ? 'true' : 'false');
      body.style.display = open ? 'block' : 'none';
    };

    acc.__sync = sync; 
     
    const toggle = (e) => { acc.classList.toggle('open'); sync(); };
  
    head.addEventListener('click', toggle, { capture: true });
    head.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(e); }
    });
    sync();
  }
  // â˜… è¿½åŠ ï¼šã©ã“ã‹ã‚‰ã§ã‚‚é–‰ã˜ã‚‰ã‚Œã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  window.closeAdminAccordion = function(){
  const acc  = document.getElementById('adminListAcc');
  if (!acc) return;
  acc.classList.remove('open');
  // inline style ã‚’ç¢ºå®Ÿã«åæ˜ ã—ã¦é–‰ã˜ã‚‹
  const head = acc.querySelector('.fHead');
  const body = acc.querySelector('.fBody');
  if (head) head.setAttribute('aria-expanded', 'false');
  if (body) body.style.display = 'none';
  // äºˆå‚™ï¼šå…¬é–‹ã•ã‚ŒãŸåŒæœŸé–¢æ•°ãŒã‚ã‚Œã°å‘¼ã¶
  if (typeof acc.__sync === 'function') acc.__sync();
};
  // â˜… ã“ã‚Œã‚’è¿½åŠ ï¼ˆå¤–ã‹ã‚‰å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
  window.setupAdminAccordion = setupAdminAccordion;
  
  // èµ·å‹•æ™‚ã«ä¸€åº¦ã ã‘ï¼ˆæ—¢å­˜ã®ã“ã‚Œã‚‚æ®‹ã™ï¼‰
  setupAdminAccordion();
}

/* ===== ä½“æ„Ÿé«˜é€ŸåŒ–ç‰ˆï¼šãƒ‡ãƒ¼ã‚¿èª­ã¿ç›´ã— ===== */

/* --- è»½é‡ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆSWRç”¨ï¼‰ --- */
const CACHE_TTL_MS = 5 * 60 * 1000; // 5åˆ†
function _cacheKey(k){ return `liff:${ENV_NS}:${k}`; }
function cacheGet(k){
  try{
    const raw = localStorage.getItem(_cacheKey(k));
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || typeof obj.ts !== 'number') return null;
    if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
    return obj.data;
  }catch(_){ return null; }
}
function cacheSet(k, data){
  try{
    localStorage.setItem(_cacheKey(k), JSON.stringify({ ts: Date.now(), data }));
  }catch(_){}
}

// ===== ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆï¼šãƒ¡ã‚¿å–å¾—ã ã‘ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œï¼ˆrenderReportã¯è§¦ã‚‰ãªã„ï¼‰ =====
const REP_META_KEY = "report:meta:v1";

// #repEvent ã® <option> ã‚’æç”»ï¼ˆæ—¢å­˜renderReportã¯ãã®ã¾ã¾ï¼‰
function renderRepEventOptions(meta){
  const sel = document.getElementById('repEvent');
  if (!sel) return;
  const cur = sel.value; // ç¾åœ¨é¸æŠã‚’ä¿æŒ

  const toLabel = (x)=>{
    const seg   = dispSeg(normSeg(x.segment || x.segmentCode || x.targetSegment || x.attendSegment || ""));
    const d     = x.ymd || x.date || "";
    const hm    = x.hm || x.time || "";
    const place = x.place || x.venue || "";
    const title = x.title || x.name || "";
    const dt    = d && hm ? `${d} ${hm}` : (d || hm);
    const left  = [dt, place].filter(Boolean).join(" @ ");
    return [seg, left, title].filter(Boolean).join(" / ");
  };

  const opts = ['<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>']
    .concat((meta||[]).map(m => {
      const id = String(m.eventId ?? m.id ?? "");
      return `<option value="${id}">${toLabel(m)}</option>`;
    }))
    .join("");

  sel.innerHTML = opts;

  // ä»¥å‰ã®é¸æŠIDãŒã¾ã å­˜åœ¨ã™ã‚‹ãªã‚‰ç¶­æŒ
  if (cur && (meta || []).some(m => String(m.eventId ?? m.id ?? "") === cur)) {
    sel.value = cur;
  }
}

// èµ·å‹•æ™‚/ãƒ¡ãƒ‹ãƒ¥ãƒ¼é·ç§»æ™‚ãªã©ã€ã€Œã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘å³æ™‚åæ˜ ã€
function loadReportMetaFromCache(){
  const meta = cacheGet(REP_META_KEY);
  if (Array.isArray(meta) && meta.length){
    state.reportMeta = meta;
    renderRepEventOptions(meta);
  }
}

// ãƒãƒƒãƒˆå†å–å¾—ï¼ˆæˆåŠŸã—ãŸã‚‰ä¸Šæ›¸ãï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼‰
async function fetchReportMetaFresh(){
  try{
    // ã‚µãƒ¼ãƒãƒ¼å´ãŒ lineId ã‚’è¦æ±‚ã™ã‚‹æ§‹æˆã«å‚™ãˆã¦å¸¸ã«ä»˜ä¸ï¼ˆä¸è¦ãªã‚‰ç„¡è¦–ã•ã‚Œã¾ã™ï¼‰
    const q = `?attendanceReport=1&meta=1&id=${esc(state.lineId)}`;
    const j = await fetchJsonWithTimeout(q, 15000);
    const meta = j?.meta || j?.list || j?.data || [];
    if (j?.status === "ok" && Array.isArray(meta)){
      state.reportMeta = meta;
      renderRepEventOptions(meta);
      cacheSet(REP_META_KEY, meta);
    }
  }catch(_){}
}

// æ—¢å­˜ãƒã‚¤ãƒ³ãƒ‰ã‚’ãã®ã¾ã¾æ´»ã‹ã™ãŸã‚ã€reportReload ã‚’â€œä¸Šæ›¸ãå®šç¾©â€
// - å…ˆã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å³æ™‚è¡¨ç¤º
// - ç¶šã‘ã¦ãƒãƒƒãƒˆã§æœ€æ–°åŒ–
window.reportReload = async function(){
  loadReportMetaFromCache();
  await fetchReportMetaFresh();
};

// ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã ã‘å…ˆã«è¦‹ã›ã‚‹ï¼ˆåˆå›ä½“æ„Ÿã‚’ã•ã‚‰ã«æ”¹å–„ï¼‰
document.getElementById('repEvent')?.addEventListener('focus', loadReportMetaFromCache, { once:true });

/* --- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ããƒ•ã‚§ãƒƒãƒï¼ˆå¤±æ•—æ™‚ã¯1å›ã ã‘ãƒªãƒˆãƒ©ã‚¤ï¼‰ --- */
async function fetchJsonWithTimeout(path, ms=15000){
  const ctrl = new AbortController();
  const timer = setTimeout(()=> ctrl.abort("timeout"), ms);
  try{
    const r = await fetch(API_ENDPOINT + path, { signal: ctrl.signal });
    clearTimeout(timer);
    return await r.json();
  }catch(_){
    clearTimeout(timer);
    // ãƒ¯ãƒ³ãƒ¢ã‚¢ï¼ˆçŸ­ã‚å¾…æ©Ÿï¼‰
    await new Promise(res=> setTimeout(res, 300));
    const r2 = await fetch(API_ENDPOINT + path);
    return await r2.json();
  }
}

/* --- å…ˆã«ã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã§æç”»ï¼ˆå›ç­”ã¯ç©ºã§OKï¼‰ --- */
function bootHomeQuickRender(){
  const userSegSet = getMemberSegSet();

  let filteredEvents = (state.events||[]).filter(e=>{
   const evSeg = e.segment || e.targetSegment || e.attendSegment || e.segmentRaw || e.segmentCode || "";
   return eventVisibleForUser(evSeg, userSegSet, INCLUDE_BOTH_FOR_ALL);
 });
 if (userSegSet.size === 0) filteredEvents = (state.events||[]).slice(); // æœªç™»éŒ²ï¼å…¨è¡¨ç¤º

  // performersï¼ˆå®¶æ—åï¼‰ã¯ä¼šå“¡æƒ…å ±ãŒã¾ã ç„¡ãã¦ã‚‚ç©ºé…åˆ—ã§OK
  const performers = Array.from(
    new Set((state.members||[]).map(m=>m.performerName).filter(Boolean))
  );
  const nameSegMap = buildNameSegMap(); // æ—¢å­˜ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’åˆ©ç”¨

  const events = filteredEvents.map(x => ({
    id      : String(x.eventId ?? x.id ?? ''),
    ymd     : ymdDow(parseYmdStrict(x.date)) || String(x.date || x.ymd || ''),
    hm      : hmFromTimeCell(x.time ?? x.hm ?? ''),
    place   : x.place ?? x.venue ?? x.location ?? '',
    deadline: String(x.deadline ?? x.limit ?? x.deadlineYmd ?? ''),
    isNew   : (x.isNew === true) || (x.is_new === 'Y') || (x.new === true),
    segment : x.segment || x.targetSegment || x.attendSegment || x.segmentCode || ""
  }));

  window.HomeEventsUI?.mount({ events, myAnswersMap: {}, performers, nameSegMap });
  // ãƒ•ã‚©ãƒ¼ãƒ å´ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ä¿æŒ
  state._filteredEventsForViews = filteredEvents;
}

/* --- å›ç­”ãŒå±Šã„ãŸã‚‰å·®ã—æ›¿ãˆæç”» --- */
function mountHomeWithFilters(){
  const filteredEvents = (state._filteredEventsForViews && state._filteredEventsForViews.length)
   ? state._filteredEventsForViews : (state.events || []);
  const events = filteredEvents.map(x => ({
    id      : String(x.eventId ?? x.id ?? ''),
    ymd     : ymdDow(parseYmdStrict(x.date)) || String(x.date || x.ymd || ''),
    hm      : hmFromTimeCell(x.time ?? x.hm ?? ''),
    place   : x.place ?? x.venue ?? x.location ?? '',
    deadline: String(x.deadline ?? x.limit ?? x.deadlineYmd ?? ''),
    isNew   : (x.isNew === true) || (x.is_new === 'Y') || (x.new === true),
    segment : x.segment || x.targetSegment || x.attendSegment || x.segmentCode || ""
  }));

  const myAnswersMap = {};
  for (const [eid, list] of Object.entries(state.answers || {})){
    myAnswersMap[String(eid)] = (list || []).map(r => ({
      name  : r.performerName,
      answer: (r.attend || '').trim() || 'æœªå›ç­”'
    }));
  }

  const performers = Array.from(
    new Set((state.members||[]).map(m=>m.performerName).filter(Boolean))
  );
  const nameSegMap = buildNameSegMap();

  window.HomeEventsUI?.mount({ events, myAnswersMap, performers, nameSegMap });
}

/* ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿ç›´ã—ï¼ˆæ®µéšè¡¨ç¤º & ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾å¿œï¼‰ ===== */
async function refreshData(){
  // 1) ã¾ãšã‚¹ãƒ”ãƒŠãƒ¼ã‚’å‡ºã™
  $("#eventsBox").innerHTML  = `èª­ã¿è¾¼ã¿ä¸­â€¦ <span class="spinner"></span>`;
  $("#answersBox").innerHTML = `ä¼šå“¡æƒ…å ±ç…§ä¼šä¸­â€¦ <span class="spinner"></span>`;
  $("#btnPrimary").textContent = "èª­ã¿è¾¼ã¿ä¸­..."; $("#btnPrimary").disabled = true;
  $("#btnEditNames").style.display = "none";

  // 2) ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°â€œå³è¡¨ç¤ºâ€
  const cachedEvents  = cacheGet("events");
  const cachedMembers = cacheGet(`whoami:${state.lineId}`);
  const cachedAnswers = cacheGet(`answers:${state.lineId}`);

  if (cachedEvents){
    state.events = cachedEvents;
    if (cachedMembers) state.members = cachedMembers;
    bootHomeQuickRender();
    if (cachedAnswers){
      state.answers = cachedAnswers;
      mountHomeWithFilters();
    }
  }

  // 3) ã‚¤ãƒ™ãƒ³ãƒˆ & ä¼šå“¡ã‚’ä¸¦åˆ—ã«å–å¾—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
  let eventsResp = null, whoResp = null;
  try{
    const [evRes, whoRes] = await Promise.allSettled([
      fetchJsonWithTimeout("?events=1", 15000),
      fetchJsonWithTimeout(`?whoami=1&id=${esc(state.lineId)}`, 15000)
    ]);
    if (evRes.status === "fulfilled")  eventsResp = evRes.value;
    if (whoRes.status === "fulfilled")  whoResp   = whoRes.value;
  }catch(_){}

  state.events  = (eventsResp?.status==="ok" && Array.isArray(eventsResp.events)) ? eventsResp.events : (state.events||[]);
  // â˜… å–å¾—æ¸ˆã¿ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ‰ãƒ©ãƒ•ãƒˆã‚’å‰ªå®š
  pruneDraftAgainstCurrentEvents();
  state.members = (whoResp?.status==="ok" ? (whoResp.members||[]) : (state.members||[]));
  // â˜… notify ã‚’åŒæœŸï¼ˆå€¤ãŒç„¡ã„æ™‚ã¯ true ã‚’æ—¢å®šã«ï¼‰
  state.notify  = (whoResp?.status==="ok" && typeof whoResp.notify === "boolean")
                 ? whoResp.notify : (typeof state.notify === "boolean" ? state.notify : true);
  state.viewerOnly = (whoResp?.status==="ok" && typeof whoResp.viewerOnly === "boolean")
                   ? whoResp.viewerOnly : state.viewerOnly;
  updateSegFilterUI();

  // 3-Î±) å–å¾—ã§ããŸæ®µéšã§ä¸€æ—¦ã€Œã‚¤ãƒ™ãƒ³ãƒˆã ã‘ã€å†æç”»ã—ã¦ä½“æ„Ÿã‚’ä¸Šã’ã‚‹
  bootHomeQuickRender();

  // 4) å›ç­”ã¯ã‚¤ãƒ™ãƒ³ãƒˆIDãŒåˆ†ã‹ã£ã¦ã‹ã‚‰å–å¾—ï¼ˆé…ã‚Œã¦ã‚‚OKï¼‰
  state.answers = state.answers || {};
  try{
    const ids = (state.events||[]).map(e=>e.eventId).filter(Boolean);
    if (ids.length){
      const r = await fetchJsonWithTimeout(`?getAttendanceAll=1&lineId=${esc(state.lineId)}&eventIds=${esc(JSON.stringify(ids))}`, 15000);
      if (r.status === "ok" && r.map) {
        state.answers = r.map;
        // å›ç­”ãŒæ¥ãŸã‚‰å·®ã—æ›¿ãˆ
        mountHomeWithFilters();
        cacheSet(`answers:${state.lineId}`, state.answers);
      }
    }
  }catch(_){ /* ç„¡è¦–ï¼šç”»é¢ã¯è¡¨ç¤ºæ¸ˆã¿ */ }

  // 5) ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ï¼ˆæ¬¡å›èµ·å‹•ã‚’é«˜é€Ÿã«ï¼‰
  if (state.events?.length)  cacheSet("events", state.events);
  if (state.members)         cacheSet(`whoami:${state.lineId}`, state.members);

  // 6) ãƒœã‚¿ãƒ³ã®å¾©å¸°
   const hasPerf = hasPerformers();
   const viewer  = isViewer();
   $("#btnPrimary").textContent = viewer
     ? "ç™»éŒ²æ°åã®ç·¨é›†"
     : (hasPerf ? "å‡ºæ¬ ã‚’å…¥åŠ› / å¤‰æ›´ã™ã‚‹" : "åˆå›ç™»éŒ²ã«é€²ã‚€");
   $("#btnPrimary").disabled = false;
   // ã‚µãƒ–ã®ã€Œç™»éŒ²æ°åã®ç·¨é›†ã€ã¯â€œé–²è¦§è€…ã§ã¯å‡ºã•ãªã„â€
   const showEditSubBtn = hasPerf && !viewer; // æ¼”å¥è€…ãŒ1ä»¶ä»¥ä¸Š ã‹ã¤ é–²è¦§è€…ã§ãªã„
   $("#btnEditNames").style.display = showEditSubBtn ? "" : "none";
}

/* ===== HOMEæç”» ===== */
function renderHome(){
  const hasMembers = state.members.length > 0;
  $("#btnPrimary").textContent = hasMembers ? "å‡ºæ¬ ã‚’å…¥åŠ› / å¤‰æ›´ã™ã‚‹" : "åˆå›ç™»éŒ²ã«é€²ã‚€";
  $("#btnPrimary").disabled = false;
  $("#btnEditNames").style.display = (hasMembers && !isViewer()) ? "" : "none";

  // ãƒˆãƒƒãƒ—ã§ã¯ answersBox éè¡¨ç¤ºä»•æ§˜ã®ã¾ã¾ï¼ˆå¿…è¦ãªã‚‰è¡¨ç¤ºå¯èƒ½ï¼‰
  const perfs = Array.from(new Set(state.members.map(m => m.performerName))).filter(Boolean);
  if (!hasMembers){
    $("#answersBox").innerHTML = `
      <div>ã¾ã ã€Œåˆå›ç™»éŒ²ã€ãŒæ¸ˆã‚“ã§ã„ã¾ã›ã‚“ã€‚</div>
      <div class="small">å‡ºæ¬ ã®å‰ã«ã€å…¥åŠ›è€…åã¨æ¼”å¥è€…ï¼ˆå®¶æ—åˆ†ã‚‚å¯ï¼‰ã®ç™»éŒ²ã‚’ã—ã¦ãã ã•ã„ã€‚</div>`;
    return;
  }
  if (state.events.length === 0){
    $("#answersBox").innerHTML = `<div class="muted">é…ä¿¡ä¸­ã®å…¬æ¼”ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
    return;
  }
  // ï¼ˆã“ã“ã¯éè¡¨ç¤ºã‚«ãƒ¼ãƒ‰ãªã®ã§æœ€å°é™ã®ã¾ã¾ã«ã—ã¦ã„ã¾ã™ï¼‰
  $("#answersBox").innerHTML = "";
}

/* ===== ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ ===== */
function onPrimary(){
  if (isViewer() || !hasPerformers()){
    // é–²è¦§è€… â†’ æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç·¨é›†ã«å…¥ã‚Œã‚‹
    registerMode = isViewer() ? "edit" : "create";
    if (registerMode === "edit") {
      buildRegisterFormFromMembers();
      $("#regTitle").textContent = "æ°åç·¨é›†ï¼ˆå…¥åŠ›è€… & æ¼”å¥è€…ï¼‰";
      $("#btnRegister").textContent = "ä¿å­˜";
    } else {
      resetRegisterForm();
      $("#regTitle").textContent = "åˆå›ç™»éŒ²ï¼ˆå…¥åŠ›è€… & æ¼”å¥è€…ï¼‰";
      $("#btnRegister").textContent = "ç™»éŒ²ã™ã‚‹";
    }
    show("#view-register");
  } else {
    buildFormView();
    show("#view-form");
  }
}
function onEditNames(){
  registerMode = "edit";
  buildRegisterFormFromMembers();
  $("#regTitle").textContent = "æ°åç·¨é›†ï¼ˆå…¥åŠ›è€… & æ¼”å¥è€…ï¼‰";
  $("#btnRegister").textContent = "ä¿å­˜";
  show("#view-register");
}
/* ===== å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‹ãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ ===== */
// â–¼ ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆå‚åŠ /æ¬ å¸­/æœªå®š + åˆå›ã®ã¿placeholderï¼‰ã‚’ç”Ÿæˆã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function renderAttendSelectHTML(evId, name, current){
  // current === "" ã®ã¨ãã ã‘ placeholder ã‚’è¡¨ç¤ºï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«ã¯å‡ºã•ãªã„ï¼‰
  const placeholderOpt = (current === "")
    ? `<option value="" disabled hidden selected>ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>` : "";

  return `
    <select class="attSel selectBtn" data-event="${evId}" data-name="${name}">
      ${placeholderOpt}
      <option value="å‚åŠ " ${current==="å‚åŠ "?"selected":""}>å‚åŠ </option>
      <option value="æ¬ å¸­" ${current==="æ¬ å¸­"?"selected":""}>æ¬ å¸­</option>
      <option value="æœªå®š" ${current==="æœªå®š"?"selected":""}>æœªå®š</option>
    </select>
  `;
}
/* ===== å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‹ãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ ===== */
(() => {
  if (window.__AttendBlockV__ && window.__AttendBlockV__ >= 3) return;
  window.__AttendBlockV__ = 3;

  // 1ä»¶åˆ†ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚«ãƒ¼ãƒ‰HTMLã‚’è¿”ã™ï¼ˆãƒãƒƒã‚¸ã¯1æ®µä¸Šã«ç‹¬ç«‹è¡Œã§è¡¨ç¤ºï¼‰
  window.renderAttendEvent = function(ev, ctx){
    // ctx: { uniqueNamesAll, ansMap, nameSegMap, userSegSet }
    const dateDisp = ymdDow(parseYmdStrict(ev.date));
    const timeDisp = hmFromTimeCell(ev.time);
    const place    = ev.place || "";
    // â˜… è¿½åŠ ï¼šã‚¿ã‚¤ãƒˆãƒ«ã‚’å®‰å…¨ã«å–å¾—ï¼ˆAPIå·®ç•°ã®å¸åï¼‰
    const titleStr = String(ev.title ?? ev.name ?? ev.eventName ?? ev.subject ?? "").trim();
    const evSegNorm = normSeg(ev.segment || ev.targetSegment || ev.attendSegment || "");
    const segBadgeLabel = dispSeg(evSegNorm);
    const segBadgeCls = evSegNorm==="adult" ? "seg-adult" : evSegNorm==="child" ? "seg-child" : "seg-both";

    // è¡¨ç¤ºå¯¾è±¡ã®æ¼”å¥è€…ã‚’æ±ºå®šï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼/åå‰å´ã®åŒºåˆ†ãŒæ¬ è½ã—ã¦ã„ã‚Œã°é™¤å¤–ã—ãªã„ï¼å…¨è¡¨ç¤ºï¼‰
     const performers = (ctx.uniqueNamesAll||[]).filter(n=>{
        if (!ctx.userSegSet || ctx.userSegSet.size===0) return true;
        return matchSeg(ctx.nameSegMap[n], evSegNorm);
      });

    // æœªä¿å­˜ãƒãƒƒã‚¸åˆ¤å®š
    const dblock = (draft.byEvent||{})[String(ev.eventId)];
    const hasUnsaved = !!dblock && (
      Object.keys(dblock.members || {}).length > 0 ||
      (dblock.comment||"").trim() !== ""
    );

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡Œï¼ˆpillï¼‰è¡¨ç¤ºã®ãŸã‚ã€ç¾åœ¨å€¤ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆå„ªå…ˆï¼‰ã‚’å–å¾—
    const pills = performers.map(name=>{
      const current = draftGetAttend(ev.eventId, name) || (ctx.ansMap[name]?.attend || "");
      let cls="stat-na", label="æœªå›ç­”";
      if (current==="å‚åŠ ") cls="stat-ok", label="å‚åŠ ";
      else if (current==="æ¬ å¸­") cls="stat-ng", label="æ¬ å¸­";
      else if (current==="æœªå®š") cls="stat-pd", label="æœªå®š";
      return `<span class="pill sm ${cls}">${name}:${label}</span>`;
    }).join(" ");

    // ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆåˆå›ã ã‘placeholderã‚’å‡ºã™ï¼‰
    const rows = performers.map(name=>{
      const current = draftGetAttend(ev.eventId, name) || (ctx.ansMap[name]?.attend || "");
      const placeholderOpt = (current === "")
        ? `<option value="" disabled hidden selected>ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>` : "";
      return `
        <div class="row-att" style="border-top:1px dashed var(--c-border); padding-top:8px; margin-top:8px;">
          <span class="nameLabel">${name}</span>
          <select class="attSel selectBtn" data-event="${ev.eventId}" data-name="${name}">
            ${placeholderOpt}
            <option value="å‚åŠ " ${current==="å‚åŠ "?"selected":""}>å‚åŠ </option>
            <option value="æ¬ å¸­" ${current==="æ¬ å¸­"?"selected":""}>æ¬ å¸­</option>
            <option value="æœªå®š" ${current==="æœªå®š"?"selected":""}>æœªå®š</option>
          </select>
        </div>
      `;
    }).join("");

    const initComment = draftGetComment(ev.eventId)
      || ((ctx.ansList||[]).find(x => (x.comment||"").trim())?.comment || "");

    return `
      <div class="fEvent" data-evt="${ev.eventId}" data-seg="${evSegNorm || 'both'}">
        <div class="fHead">
          <div class="fTitle">
            <!-- 1è¡Œç›®ï¼šæ—¥ä»˜ æ™‚é–“ ï¼ å³ç«¯=åŒºåˆ†ãƒãƒƒã‚¸ -->
            <div class="fRow1" title="${dateDisp} ${timeDisp}">
              <span class="t-date">${dateDisp}${timeDisp ? ` <small>${timeDisp}</small>` : ``}</span>
              ${hasUnsaved ? `<span class="badge-unsaved" style="margin-left:8px;">æœªä¿å­˜</span>` : ``}
              ${segBadgeLabel ? `<span class="seg-badge ${segBadgeCls}">${segBadgeLabel}</span>` : ``}
            </div>
    
            <!-- 2è¡Œç›®ï¼šã‚¿ã‚¤ãƒˆãƒ« ï¼ å ´æ‰€ -->
            <div class="fRow2" title="${titleStr}${place?` @ ${place}`:''}">
            <span class="t-title">${titleStr || 'ï¼ˆç„¡é¡Œï¼‰'}</span>
              ${place ? `<span class="t-place">@ ${place}</span>` : ``}
            </div>
          </div>
    
          <!-- â†“ã“ã“ä»¥é™ã¯å¤‰æ›´ãªã—ï¼ˆå›ç­”ãƒãƒƒãƒ—è¡Œãƒ»ç· åˆ‡ï¼‰ -->
          <div class="fStatusRow">${pills}</div>
          <div class="fSub">${ev.deadline ? `ç· åˆ‡ï¼š${ev.deadline}` : "ç· åˆ‡ï¼šâ€”"}</div>
        </div>
    
        <div class="fBody">
          ${rows}
          <div class="line"></div>
          <label>ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ãƒ»100æ–‡å­—ã¾ã§ï¼‰</label>
          <input type="text" maxlength="100" class="evComment" data-event="${ev.eventId}" value="${initComment}">
        </div>
      </div>
    `;
  };

  // ===== æ—¢å­˜ã® buildFormView ã‚’ç½®æ›ï¼ˆrenderAttendEvent ã‚’ä½¿ç”¨ï¼‰ =====
  window.buildFormView = function(){
    // â† è¿½åŠ ï¼šã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ â€œä»Šã‚ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆä»¥å¤–ã®ãƒ‰ãƒ©ãƒ•ãƒˆâ€ ã‚’æƒé™¤
    pruneDraftAgainstCurrentEvents();
    
    const boxHeader = $("#formEventsBox");
    const box = $("#formFields");
    box.innerHTML = "";
    boxHeader.innerHTML = `
      <span class="muted">
        ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¿ãƒƒãƒ—ã—ã¦å‡ºæ¬ ã‚’å…¥åŠ›å¾Œã€
        <span class="em-red">é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</span>
      </span>`;

    const eventsForForm = state._filteredEventsForViews || [];
    if (!eventsForForm.length){
      box.innerHTML = `<div class="muted">ç¾åœ¨ã€ã‚ãªãŸã®åŒºåˆ†å‘ã‘ã®å…¬æ¼”ã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
      updateSubmitButton();
      return;
    }

    const nameSegMap = buildNameSegMap();
    const uniqueNamesAll = Array.from(new Set((state.members||[]).map(m => m.performerName))).filter(Boolean);
    const userSegSet = getMemberSegSet();

    // ã¾ã¨ã‚ã¦ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆHTMLçµ„ã¿ç«‹ã¦ï¼‰
    const html = eventsForForm.map(e=>{
      const ansList = state.answers[e.eventId] || [];
      const ansMap  = {}; ansList.forEach(r => ansMap[r.performerName] = r);
      return window.renderAttendEvent({
        eventId : e.eventId,
        date    : e.date,
        time    : e.time,
        place   : e.place || "",
        deadline: e.deadline || "",
        segment : e.segment || e.targetSegment || e.attendSegment || "",
        title   : e.title || e.eventTitle || e.name || e.eventName || ""
      }, {
        uniqueNamesAll, ansMap, ansList, nameSegMap, userSegSet
      });
    }).join("");

    box.innerHTML = html;

    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    box.querySelectorAll(".fEvent .fHead").forEach(h=>{
      h.addEventListener("click", () => h.closest(".fEvent")?.classList.toggle("open"));
    });

    // å…¥åŠ›ç›£è¦–ï¼ˆãƒ‡ãƒªã‚²ãƒ¼ãƒˆï¼‰
    box.addEventListener("change", (ev)=>{
      const sel = ev.target.closest("select.attSel");
      if (!sel) return;
      const eid = sel.dataset.event;
      const name = sel.dataset.name;
      const val  = sel.value;
      draftSetAttend(eid, name, val || "");
      markUnsavedBadge(eid);
      updateSubmitButton();
    });

    box.addEventListener("input", (ev)=>{
      const c = ev.target.closest("input.evComment");
      if (!c) return;
      const eid = c.dataset.event;
      draftSetComment(eid, c.value);
      markUnsavedBadge(eid);
      updateSubmitButton();
    });

    updateSubmitButton();
  };
})();
/* ===== å‡ºæ¬ ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‹ãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ END ===== */

/* ===== å‡ºæ¬ é€ä¿¡ï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆä¸€æ‹¬é€ä¿¡ï¼‰ ===== */
async function onSubmit(){
  if (state.submitting) return;
  state.submitting = true;
  const btn = $("#btnSubmit");
  const backBtn = $("#btnBackFromForm");
  btn.disabled = true; btn.textContent = "é€ä¿¡ä¸­â€¦"; logForm("");
  if (backBtn) backBtn.disabled = true;

  const navGuard = (e) => {
    if (state.submitting) {
      e.preventDefault();
      e.returnValue = "";
    }
  };
  window.addEventListener("beforeunload", navGuard);

  try{
    // â˜… å¿µã®ãŸã‚ã“ã“ã§ã‚‚å¤ã„ãƒ‰ãƒ©ãƒ•ãƒˆã¯æƒé™¤
    pruneDraftAgainstCurrentEvents();
    
    const payloads = draftBuildPayloads();
    if (!payloads.length){ alert("é€ä¿¡ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå‡ºæ¬ ã®é¸æŠãŒæœªå…¥åŠ›ã§ã™ï¼‰"); return; }

    // ã‚¤ãƒ™ãƒ³ãƒˆIDã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆï¼‹ã‚³ãƒ¡ãƒ³ãƒˆè§¦ã£ãŸã‹ã©ã†ã‹ã‚’è¨˜éŒ²ï¼‰
    const grouped = {};
    const eventCommentMap = {};          // eventId -> ã‚³ãƒ¡ãƒ³ãƒˆæ–‡å­—åˆ—
    const touchedEventSet = new Set();   // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§¦ã£ãŸ eventId

    for (const p of payloads) {
      if (!grouped[p.eventId]) grouped[p.eventId] = [];
      grouped[p.eventId].push({ performerName: p.performerName, attend: p.attend });

      if (Object.prototype.hasOwnProperty.call(p, '_eventComment')) {
        // â˜… ã‚³ãƒ¡ãƒ³ãƒˆã‚’ã€Œè§¦ã£ãŸã€ã‚¤ãƒ™ãƒ³ãƒˆã ã‘æ‹¾ã†
        eventCommentMap[p.eventId] = (p._eventComment || "");
        touchedEventSet.add(p.eventId);
      }
    }
    
    // â˜… è¿½åŠ ï¼šé›†è¨ˆç”¨
    let closedCleaned = [];   // å—ä»˜çµ‚äº†ã§æƒé™¤ã—ãŸ eventId
    let successCount  = 0;    // æ­£å¸¸é€ä¿¡ã§ããŸã‚¤ãƒ™ãƒ³ãƒˆæ•°
    
    // ã‚¤ãƒ™ãƒ³ãƒˆå˜ä½ã§é€ä¿¡ï¼ˆmerge=1 ã‚’ä»˜ã‘ã‚‹ï¼‰
    for (const [eventId, list] of Object.entries(grouped)) {
      const eCom    = String(eventCommentMap[eventId] || "");
      const touched = touchedEventSet.has(eventId);           // ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’è§¦ã£ãŸã‚¤ãƒ™ãƒ³ãƒˆã ã‘é€ã‚‹
    
      const bulk = list.map((it, idx) => {
        const row = { performerName: it.performerName, attend: it.attend };
        if (touched && idx === 0) row.comment = eCom;         // å…ˆé ­ãƒ¬ã‚³ãƒ¼ãƒ‰ã ã‘ comment ã‚­ãƒ¼ã‚’ä»˜ä¸
        return row;
      });
    
      const url = `${API_ENDPOINT}?submitBulk=1`
                + `&eventId=${esc(eventId)}`
                + `&lineId=${esc(state.lineId)}`
                + `&merge=1`
                + `&bulk=${esc(JSON.stringify(bulk))}`;
    
      const r = await fetch(url);
      const j = await r.json();
      if (j.status !== "ok") {
        // â˜… ã“ã“ã§ã€Œå—ä»˜çµ‚äº†ã€ã‚’æ¤œçŸ¥ã—ã¦ã€ãã®ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ‰ãƒ©ãƒ•ãƒˆã ã‘æƒé™¤ã—ã¦ç¶šè¡Œ
        const msg = String(j.message || j.error || "");
        if (/å—ä»˜.*çµ‚äº†|ç· åˆ‡.*éã|å…¬é–‹.*çµ‚äº†|closed/i.test(msg)) {
          if (draft.byEvent && draft.byEvent[eventId]) {
            delete draft.byEvent[eventId];
            closedCleaned.push(String(eventId));
          }
          // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã¸ï¼ˆthrowã—ãªã„ï¼‰
          continue;
        }
        // ãã‚Œä»¥å¤–ã®å¤±æ•—ã¯å¾“æ¥é€šã‚Šã‚¨ãƒ©ãƒ¼æ‰±ã„
        throw new Error(`é€ä¿¡å¤±æ•—ï¼ˆ${eventId}ï¼‰: ${j.message || "unknown"}`);
      }
      successCount++;
    }
    
    if (closedCleaned.length){
        draftSave();           // â† å‰Šé™¤ã®æ°¸ç¶šåŒ–
        updateSubmitButton();  // â† é€ä¿¡ãƒœã‚¿ãƒ³ã®æ´»æ€§/éæ´»æ€§ã‚’åæ˜ 
        logForm(`ç· åˆ‡æ¸ˆã¿ã®æœªä¿å­˜ãƒ‡ãƒ¼ã‚¿ï¼ˆ${closedCleaned.length}ä»¶ï¼‰ã‚’è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
      }
    
    // â˜… å…¨ä»¶ã€Œå—ä»˜çµ‚äº†ã€ã§é€ã‚Œãªã‹ã£ãŸå ´åˆ
    if (successCount === 0){
      alert("ã™ã¹ã¦å—ä»˜çµ‚äº†ã®ãŸã‚é€ä¿¡ã§ãã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      buildFormView(); // è¡¨ç¤ºã‚’æœ€æ–°åŒ–
      return;
    }

    alert("é€ä¿¡ã—ã¾ã—ãŸ");
    draftClear(); // â˜… é€ä¿¡æˆåŠŸã§ä¸‹æ›¸ãã‚’ç ´æ£„
    show("#view-home");
    logHome("æ›´æ–°ä¸­â€¦");
    await refreshData();
    logHome("");

  }catch(err){
    logForm(err.message || String(err));
  } finally {
    window.removeEventListener("beforeunload", navGuard);
    state.submitting = false;
    btn.disabled = false;
    btn.textContent = "ã¾ã¨ã‚ã¦é€ä¿¡";
    backBtn && (backBtn.disabled = false);
    updateSubmitButton();
  }
}

/* ===== åˆå›ç™»éŒ² ===== */
function resetRegisterForm(){
  $("#regInputName").value = state.name || "";
  $("#perfList").innerHTML = "";
  addPerformerField("");
  $("#regNotify").checked = (state.notify !== false); // â˜… è¿½åŠ ï¼šåˆæœŸå€¤
}
function buildRegisterFormFromMembers(){
  const inputName = (state.members[0]?.inputName || state.name || "");
  $("#regInputName").value = inputName;
  $("#perfList").innerHTML = "";
  // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹è¡Œã‚’ãã®ã¾ã¾å±•é–‹ï¼ˆåŒåã§ã‚‚å­/å¤§ã¯åˆ¥è¡Œï¼‰
   const list = (state.members||[]).map(m => ({
     name: (m.performerName||"").trim(),
     seg : (m.segment || m?.åŒºåˆ† || "å­ã©ã‚‚ã®éƒ¨")
   })).filter(x => x.name);
   if (list.length===0){
     addPerformerField("", "å­ã©ã‚‚ã®éƒ¨");
   } else {
     list.forEach(x => addPerformerField(x.name, x.seg));
   }
    $("#regNotify").checked = (state.notify !== false); // â˜… è¿½åŠ ï¼šåˆæœŸå€¤
}
function addPerformerField(value="", segValue="å­ã©ã‚‚ã®éƒ¨"){
  const id = "perf_" + Math.random().toString(36).slice(2);
  const row = document.createElement("div");

  // ã“ã“ã‚’ perfRowï¼ˆGrid ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼‰ã«å¤‰æ›´
  row.className = "perfRow";

  row.innerHTML = `
    <label for="${id}" class="perfLabel">æ¼”å¥è€…å</label>
    <input type="text" id="${id}" class="regPerf" value="${value||""}" placeholder="ä¾‹ï¼šè—¤å¡š å¤ªéƒ">
    <select class="regPerfSeg selectBtn">
     <option value="å­ã©ã‚‚ã®éƒ¨" ${segValue==="å­ã©ã‚‚ã®éƒ¨"?"selected":""}>å­ã©ã‚‚ã®éƒ¨</option>
     <option value="å¤§äººã®éƒ¨"   ${segValue==="å¤§äººã®éƒ¨"  ?"selected":""}>å¤§äººã®éƒ¨</option>
   </select>
    <button type="button" class="btn btn-remove btn-sm"
            onclick="this.closest('.perfRow').remove()"
            aria-label="ã“ã®æ¼”å¥è€…ã‚’å‰Šé™¤">å‰Šé™¤</button>
  `;
  document.getElementById("perfList").appendChild(row);
}
async function onRegister(){
  try{
    logReg("");
    const inputName = $("#regInputName").value.trim();
    if (!inputName) throw new Error("å…¥åŠ›è€…æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    const notify = !!$("#regNotify")?.checked;

    // {name, segment} ã®é…åˆ—ï¼ˆç©ºæ–‡å­—ã¯é™¤å¤–ï¼‰
    const items = Array.from(document.querySelectorAll(".perfRow")).map(row=>{
      const name = row.querySelector(".regPerf")?.value.trim();
      const seg  = row.querySelector(".regPerfSeg")?.value || "å­ã©ã‚‚ã®éƒ¨";
      return name ? { name, segment: seg } : null;
    }).filter(Boolean);

    // é–²è¦§ã®ã¿ï¼šæ¼”å¥è€…0ä»¶ ã‹ã¤ é€šçŸ¥OFFï¼ˆãƒã‚§ãƒƒã‚¯å¤–ã—ï¼‰
    const isViewerOnly = (items.length === 0) && !notify;

    // ã“ã‚Œã¾ã§ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã€Œé–²è¦§ã®ã¿ã€ã®ã¨ãã ã‘å…é™¤
    if (!isViewerOnly && items.length === 0){
      throw new Error("æ¼”å¥è€…ã‚’1åä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„");
    }

    $("#btnRegister").disabled = true;
    $("#btnRegister").textContent = (registerMode==="edit" ? "ä¿å­˜ä¸­â€¦" : "ç™»éŒ²ä¸­â€¦");

    // list2 ã¯ç©ºé…åˆ—ã®ã¾ã¾é€ã‚‹ã€‚viewerOnly=1 ã‚’ä»˜ä¸
    const listJson = JSON.stringify(items);

    let url = "";
    if (registerMode === "edit") {
      url = `${API_ENDPOINT}?replaceMembers=1`
          + `&lineId=${esc(state.lineId)}`
          + `&inputName=${esc(inputName)}`
          + `&list2=${esc(listJson)}`
          + `&purge=0`
          + `&notify=${notify?1:0}`
          + `&viewerOnly=${isViewerOnly?1:0}`;
    } else {
      url = `${API_ENDPOINT}?registerBulk=1`
          + `&lineId=${esc(state.lineId)}`
          + `&inputName=${esc(inputName)}`
          + `&list2=${esc(listJson)}`
          + `&notify=${notify?1:0}`
          + `&viewerOnly=${isViewerOnly?1:0}`;
    }

    const r = await fetch(url);
    const j = await r.json();
    if (j.status !== "ok") throw new Error(j.message || "ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");

    state.notify = notify; // ã‚µãƒ¼ãƒä¿å­˜æˆåŠŸã§ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚åæ˜ 
    alert(registerMode==="edit" ? "æ°åã‚’ä¿å­˜ã—ã¾ã—ãŸ" : (isViewerOnly ? "é–²è¦§è€…ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ" : "åˆå›ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ"));

    show("#view-home");
    logHome("æ›´æ–°ä¸­â€¦");
    await refreshData();
    logHome("");

  }catch(err){
    logReg(err.message || String(err));
  }finally{
    $("#btnRegister").disabled = false;
    $("#btnRegister").textContent = (registerMode==="edit" ? "ä¿å­˜" : "ç™»éŒ²ã™ã‚‹");
  }
}
// ===== ä»Šå¾Œã®äºˆå®šï¼ˆSchedulesï¼‰ v5 =====
(() => {
  if (window.__SchedulesBlockV__ && window.__SchedulesBlockV__ >= 6) return;
  window.__SchedulesBlockV__ = 6;
  // --- ãƒ•ã‚£ãƒ«ã‚¿ä¿å­˜/å¾©å…ƒï¼ˆlocalStorageï¼‰ ---
  const FILTER_KEY = 'sched:filters:v1';
  function saveFilters(){
    try{
      const o = {
        days: document.getElementById('selDays')?.value || '60',
        kind: document.getElementById('selKind')?.value || '',
        seg : document.getElementById('selSeg') ?.value || '',
      };
      localStorage.setItem(FILTER_KEY, JSON.stringify(o));
    }catch(_){}
  }
  function loadFilters(){
    try{
      const o = JSON.parse(localStorage.getItem(FILTER_KEY) || '{}');
      if (o.days && document.getElementById('selDays')) document.getElementById('selDays').value = o.days;
      if (o.kind && document.getElementById('selKind')) document.getElementById('selKind').value = o.kind;
      // seg ã¯ã€Œä¸¡æ–¹æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã®ã¿æœ‰åŠ¹
      if (o.seg && document.getElementById('selSeg') && userHasBoth()){
        document.getElementById('selSeg').value = o.seg;
      }
    }catch(_){}
  }
  // ä»–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‹ã‚‰å®‰å…¨ã«å‘¼ã¹ã‚‹ã‚ˆã†ã«å…¬é–‹
  window.__schedSaveFilters = saveFilters;
  window.__schedLoadFilters = loadFilters;
  window.__schedSaveFilters  = window.__schedSaveFilters  || function(){};
  window.__schedLoadFilters  = window.__schedLoadFilters  || function(){};

  // æ—§ã‚³ãƒ¼ãƒ‰ãŒç´ ã® saveFilters()/loadFilters() ã‚’å‘¼ã‚“ã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹
  window.saveFilters = function(){ return window.__schedSaveFilters.apply(null, arguments); };
  window.loadFilters = function(){ return window.__schedLoadFilters.apply(null, arguments); };
  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function parseYmdStrictLocal(s){
    const m = String(s||"").match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
    if (!m) return null;
    const d = new Date(+m[1], +m[2]-1, +m[3]); d.setHours(0,0,0,0);
    return isNaN(d) ? null : d;
  }
  function addDays(d, n){ const x = new Date(d.getTime()); x.setDate(x.getDate()+n); x.setHours(0,0,0,0); return x; }

  // ===== ã‚«ãƒ¼ãƒ‰æç”» =====
  function renderScheduleCard(it){
    const segNorm = normSeg(it.segment || it.segmentCode || it.targetSegment || it.attendSegment || "");
    const segLabel = dispSeg(segNorm);
    const dateText = ymdDow(parseYmdStrictLocal(it.ymd || it.date)) || (it.date || "");
    const kindText = String(it.kind || "").trim();
    const memoText = String(it.memo || "").trim();
  
    const meetTxt  = [
      (it.meetAt ? `é›†åˆ ${it.meetAt}` : ""),
      (it.meetPlace || "")
    ].filter(Boolean).join(" ");
    const placeTxt = it.place ? `@${it.place}` : "";
  
    // æŠ˜ã‚ŠãŸãŸã¿å†…ã®ä¸­èº«ï¼ˆãƒ•ãƒ«ã‚¿ã‚¤ãƒˆãƒ« â†’ ãƒ¡ãƒ¢ â†’ å ´æ‰€/é›†åˆï¼‰
    const panelInner = `
      <div class="scFullTitle">${it.title || ""}</div>
      ${memoText ? `<div class="scMemo">${memoText}</div>` : ``}
      ${(placeTxt || meetTxt) ? `<div class="scMeta">${[placeTxt, meetTxt].filter(Boolean).join("ã€€")}</div>` : ``}
    `;
  
    return `
      <div class="card scheduleCard" data-seg="${segNorm || 'both'}">
        <!-- 1è¡Œç›®ï¼šå·¦=åŒºåˆ† / å³=ç¨®åˆ¥ -->
        <div class="scTop">
          ${segLabel ? `<span class="seg-badge ${segNorm==='adult'?'seg-adult':segNorm==='child'?'seg-child':'seg-both'}">${segLabel}</span>` : ``}
          ${kindText ? `<span class="scKind">${kindText}</span>` : ``}
        </div>
  
        <!-- 2è¡Œç›®ï¼šæ—¥ä»˜ + ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ1è¡Œçœç•¥ï¼‰ -->
        <button type="button" class="scTitleBtn" aria-expanded="false">
          <span class="scDate">${dateText}</span>
          <span class="scTitle">${it.title || ""}</span>
          <span class="scCaret" aria-hidden="true">âˆ¨</span>
        </button>
  
        <!-- 3è¡Œç›®ä»¥é™ï¼šæŠ˜ã‚ŠãŸãŸã¿ï¼ˆãƒ•ãƒ«ã‚¿ã‚¤ãƒˆãƒ«/ãƒ¡ãƒ¢/@å ´æ‰€ãƒ»é›†åˆï¼‰ -->
        <div class="scPanel" hidden>${panelInner}</div>
      </div>`;
  }
  window.renderSchedulesView = function(list){
    if (!Array.isArray(list) || list.length===0) {
      return `<div class="listEmpty">è©²å½“ã™ã‚‹äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
    }
    return list.map(renderScheduleCard).join("");
  };

  function exposeSegFilterIfNeeded(){
    if (typeof updateSegFilterUI === "function") updateSegFilterUI();
  }

  // ===== ãƒ­ãƒ¼ã‚«ãƒ«å†æç”»ï¼ˆUIã®é¸æŠã ã‘ã§å³æ™‚ãƒ•ã‚£ãƒ«ã‚¿ï¼‰ =====
  function renderSchedulesLocal(){
  const box = $("#schedulesBox");

  // ã¾ã åˆå›å–å¾—å‰ãªã‚‰å¾…æ©Ÿè¡¨ç¤º
  if (!Array.isArray(state.schedulesRaw) || state.schedulesRaw.length === 0){
    box.innerHTML = `èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­ï¼ˆã€Œå†å–å¾—ã€ã‚’æŠ¼ã™ã¨èª­ã¿è¾¼ã¿ã¾ã™ï¼‰`;
    return;
  }

  const base = state.schedulesRaw.slice();

  // â† ã“ã“ã‚’å …ç‰¢ã«ï¼ˆdaysSel ã§ã¯ãªã days ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ç®—å‡ºï¼‰
  const selDaysEl = document.getElementById('selDays');
  const days = Number(selDaysEl && selDaysEl.value ? selDaysEl.value : 60) || 60;

  const kindSel = document.getElementById('selKind')?.value || "";

  // 1) æœŸé–“
  const today = new Date(); today.setHours(0,0,0,0);
  const until = addDays(today, days);
  let arr = base.filter(it=>{
    const d = parseYmdStrictLocal(it.ymd || it.date);
    return d && d >= today && d <= until;
  });

  // 2) ç¨®åˆ¥
  if (kindSel){
    arr = arr.filter(it => String(it.kind||"").trim() === kindSel);
  }

  // 3) ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒºåˆ†ï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ‰€å±ã§çµã‚Šè¾¼ã¿ï¼‰
  const segSet = getMemberSegSet();
  arr = arr.filter(it => {
    const evSeg = it.segment || it.segmentCode || it.targetSegment || it.attendSegment || "";
    return eventVisibleForUser(evSeg, segSet, /* includeBoth */ true);
  });

  // 4) ä¸¡æ–¹æ‰€å±ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã€UIåŒºåˆ†ãƒ•ã‚£ãƒ«ã‚¿
  if (segSet && segSet.size > 0 && userHasBoth()){
  const uiSeg = $("#selSeg")?.value || "";
  if (uiSeg){
    arr = arr.filter(it => {
      const code = normSeg(it.segment || it.segmentCode || it.targetSegment || it.attendSegment || "");
      return code === uiSeg || code === "both";
    });
  }
}

  state.schedules = arr;
  box.innerHTML = window.renderSchedulesView(state.schedules);
}

  // ===== åˆå› or å†å–å¾—æ™‚ã ã‘ API ã‚’å©ã =====
  window.renderSchedules = async function(initial=false){
    const box = $("#schedulesBox");

    try{
      if (initial){
        box.innerHTML = `èª­ã¿è¾¼ã¿ä¸­â€¦ <span class="spinner"></span>`;
        exposeSegFilterIfNeeded();
        loadFilters();

        // API ã‹ã‚‰æœ€æ–°ã‚’1å›å–å¾—ã—ã¦ã€ç”Ÿã®é…åˆ—ã‚’ä¿æŒ
        const daysSel = Number($("#selDays").value || 60);
        const kindSel = $("#selKind").value || "";
        // åˆå›ã¯åºƒã‚ã®æ—¥æ•°ã§å…¨ä»¶ã‚’å–å¾—ï¼ˆä¾‹: 180æ—¥ï¼‰ã€‚ç¨®åˆ¥ã‚‚ä»˜ã‘ãªã„
        const url = `?schedules=1&days=180`;
        const r = await api(url);
        if (r.status !== "ok" || !Array.isArray(r.schedules)) {
          box.innerHTML = `<span class="err">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>`;
          return;
        }
        // â˜… ç”Ÿãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒï¼ˆä»¥å¾Œã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
        state.schedulesRaw = r.schedules.slice();
      }
      // å–å¾—æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ UI å€¤ã§ãƒ•ã‚£ãƒ«ã‚¿ã—ã¦æç”»
      renderSchedulesLocal();

    }catch(err){
      box.innerHTML = `<span class="err">ã‚¨ãƒ©ãƒ¼: ${err.message||err}</span>`;
    }
  };

  // äº’æ›ï¼šå¤–éƒ¨ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®šãŒã‚ã‚Œã°ã“ã¡ã‚‰
  window.loadSchedules = function(){ window.renderSchedules(false); };

  window.copyIcsFeed = async function(){
    const ipt = $("#icsFeedUrl");
    if (!ipt) return;
    try {
      ipt.select();
      if (window.isSecureContext && navigator?.clipboard?.writeText) {
        await navigator.clipboard.writeText(ipt.value);
      } else {
        // éHTTPSã‚„å¤ã„ç’°å¢ƒå‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const ta = document.createElement('textarea');
        ta.value = ipt.value;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
      }
      alert("è³¼èª­URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    } catch (e) {
      console.error(e);
      alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
    }
  };

  // ===== UIæ“ä½œã§å³åæ˜ ï¼ˆã“ã“ã§ãƒã‚¤ãƒ³ãƒ‰ï¼‰ =====
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('selDays')?.addEventListener('change', () => { renderSchedulesLocal(); saveFilters(); });
    document.getElementById('selKind')?.addEventListener('change', () => { renderSchedulesLocal(); saveFilters(); });
    document.getElementById('selSeg') ?.addEventListener('change', () => { renderSchedulesLocal(); saveFilters(); });
    // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¿ãƒƒãƒ—ã§é–‹é–‰ï¼ˆãƒªãƒ³ã‚¯ã¯é™¤å¤–ï¼‰
    document.getElementById('schedulesBox')?.addEventListener('click', (e)=>{
      // ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã¯é–‹é–‰ã—ãªã„
      if (e.target.closest('a')) return;
    
      const card  = e.target.closest('.scheduleCard');
      if (!card) return;
    
      const btn   = card.querySelector('.scTitleBtn');
      const panel = card.querySelector('.scPanel');
      const caret = card.querySelector('.scCaret');
      if (!btn || !panel || !caret) return;
    
      const expanded = card.getAttribute('data-expanded') === 'true';
      // åˆ‡ã‚Šæ›¿ãˆ
      card.setAttribute('data-expanded', String(!expanded));
      btn.setAttribute('aria-expanded', String(!expanded));
      panel.hidden = expanded;                 // trueâ†’éš ã™ / falseâ†’è¡¨ç¤º
      caret.textContent = expanded ? 'âˆ¨' : 'âˆ§'; // çŸ¢å°ã‚’æ–‡å­—ã§åˆ‡ã‚Šæ›¿ãˆ
    });
  });
})();
// ===== ä»Šå¾Œã®äºˆå®šï¼ˆSchedulesï¼‰ v5 END =====

/* ===== äºˆå®šç™»éŒ²ï¼ˆç®¡ç†è€…ï¼‰ ===== */
// ç¨®åˆ¥å¤‰æ›´ã«å¿œã˜ã¦ UI ã‚’åˆ¶å¾¡ï¼ˆç·´ç¿’=é›†åˆå ´æ‰€/é…ä¿¡ãƒ•ãƒ©ã‚°/ç· åˆ‡æ—¥ã‚‚ç„¡åŠ¹åŒ–ï¼‰
function adminTypeChangeAdapt(){
  const t = $("#ad_type").value;
  const meetAt     = $("#ad_meetAt");
  const meetPlace  = $("#ad_meetPlace");
  const attend     = $("#ad_attendTarget");
  const deadline   = $("#ad_deadline");
  const flagSel    = $("#ad_flag");
  const hm         = $("#ad_hm");
  const place      = $("#ad_place");

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹ã§è§¦ã£ãŸã‚‰ã€Œè‡ªå‹•å…¥åŠ›ãƒ•ãƒ©ã‚°ã€ã‚’è§£é™¤
  hm?.addEventListener('input',   ()=> hm.dataset.autofilled   = "0", { once:true });
  place?.addEventListener('input',()=> place.dataset.autofilled= "0", { once:true });

  // â˜… è¿½åŠ ï¼šå‡ºæ¬ å¯¾è±¡ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè§¦ã£ãŸã‹ã‚’è¨˜éŒ²ï¼ˆ1å›ã ã‘ï¼‰
  if (attend && !attend.__touchBound){
    attend.addEventListener('change', () => { attend.dataset.touched = "1"; }, { once:true });
    attend.__touchBound = true;
  }
  
  if (t === "ç·´ç¿’"){
    // ç„¡åŠ¹åŒ–ï¼ˆè‰²ã¯CSSã§çµ±ä¸€ï¼‰
    $("#ad_meetAt").value    = "";  meetAt.disabled    = true;
    $("#ad_meetPlace").value = "";  meetPlace.disabled = true;
    attend.value = "N";             attend.disabled    = true;
    $("#ad_deadline").value  = "";  deadline.disabled  = true;
    updateFlagOptions({ type:t, forceN:true, disable:true });

    // â˜… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè‡ªå‹•å…¥åŠ›ï¼ˆæœªå…¥åŠ›ã®ã¨ãã ã‘ï¼‰
    if (hm && !hm.value){
      hm.value = "17:15";
      hm.dataset.autofilled = "1";
    }
    if (place && !place.value){
      place.value = "è—¤å¡šå°å­¦æ ¡ä½“è‚²é¤¨";
      place.dataset.autofilled = "1";
    }

  } else if (t === "ç™ºè¡¨"){
    meetAt.disabled    = false;
    meetPlace.disabled = false;
    attend.disabled    = false;
    deadline.disabled  = false;
    updateFlagOptions({ type:t, forceN:false, disable:false });

    // â˜… è¿½åŠ ï¼šæ–°è¦ä½œæˆæ™‚ã®ã¿ã€ã‹ã¤æœªã‚¿ãƒƒãƒãªã‚‰ Y ã‚’æ—¢å®šã‚»ãƒƒãƒˆ
    if (typeof adminMode !== "undefined" && adminMode === "create" &&
        attend && attend.dataset.touched !== "1"){
      attend.value = "Y";
    }

    // â˜… ç·´ç¿’ä»¥å¤–ã«æˆ»ã—ãŸã¨ãï¼šè‡ªå‹•å…¥åŠ›ã ã£ãŸåˆ†ã ã‘ã‚¯ãƒªã‚¢
    if (hm?.dataset.autofilled === "1"){ hm.value = ""; }
    if (place?.dataset.autofilled === "1"){ place.value = ""; }
    if (hm) hm.dataset.autofilled = "0";
    if (place) place.dataset.autofilled = "0";

  } else { // ãã®ä»–
    meetAt.disabled    = false;
    meetPlace.disabled = false;
    attend.value       = "N";
    attend.disabled    = true;
    deadline.disabled  = false;
    updateFlagOptions({ type:t, forceN:true, disable:true });

    // â˜… åŒä¸Šï¼šè‡ªå‹•å…¥åŠ›ã ã£ãŸåˆ†ã ã‘ã‚¯ãƒªã‚¢
    if (hm?.dataset.autofilled === "1"){ hm.value = ""; }
    if (place?.dataset.autofilled === "1"){ place.value = ""; }
    if (hm) hm.dataset.autofilled = "0";
    if (place) place.dataset.autofilled = "0";
  }
}
// é…ä¿¡ãƒ•ãƒ©ã‚°é¸æŠè‚¢ã®å·®ã—æ›¿ãˆï¼ˆæ–°è¦=Y/Nã®ã¿ã€ç·¨é›†=Y/S/D/Nï¼‰/ éç™ºè¡¨ã¯Nå›ºå®š
function updateFlagOptions({ type, forceN=false, disable=false }){
  const sel = $("#ad_flag");
  const cur = sel.value || "N";
  sel.innerHTML = ""; // ã„ã£ãŸã‚“ç©ºã«

  const opt = (v, label)=> {
    const o = document.createElement("option");
    o.value = v; o.textContent = label;
    sel.appendChild(o);
  };

  if (type === "ç™ºè¡¨" && !forceN){
    if (adminMode === "create"){
      opt("N","N");
      opt("Y","Yï¼ˆåˆå›é…ä¿¡å¯¾è±¡ï¼‰");
    }else{
      opt("N","N");
      opt("Y","Yï¼ˆåˆå›é…ä¿¡å¯¾è±¡ï¼‰");
      opt("S","Sï¼ˆåˆå›é…ä¿¡æ¸ˆï¼‰");
      opt("D","Dï¼ˆç· åˆ‡è¶…é/ç· åˆ‡åœæ­¢ï¼‰");
    }
  }else{
    opt("N","N");
  }

  const allowed = Array.from(sel.options).map(o=>o.value);
  sel.value = allowed.includes(cur) ? cur : "N";
  sel.disabled = !!disable;
}

function enterAdminCreateMode(){
  adminMode = "create";
  adminEditingId = "";
  $("#adminFormTitle").textContent = "æ–°è¦ç™»éŒ²";
  $("#adminEditingId").style.display = "none";
  $("#btnAdminSubmit").textContent = "æ–°è¦ç™»éŒ²";
  $("#ad_title").value = "";
  $("#ad_type").value = "";
  $("#ad_ymd").value = "";
  $("#ad_hm").value = "";
  $("#ad_place").value = "";
  $("#ad_meetAt").value = "";
  $("#ad_meetPlace").value = "è—¤å¡šå°å­¦æ ¡";
  $("#ad_attendTarget").value = "N";
  $("#ad_deadline").value = "";
  $("#ad_publish").value = "Yes";
  $("#ad_status").value = "active";
  $("#ad_status").disabled = true;  // â˜… è¿½åŠ ï¼šæ–°è¦ã¯ç·¨é›†ä¸å¯ã«
  $("#ad_flag").innerHTML = `<option value="N" selected>N</option><option value="Y">Yï¼ˆåˆå›é…ä¿¡å¯¾è±¡ï¼‰</option>`;
  $("#ad_flag").value = "N";

  // â˜… â‘¤ å¯¾è±¡åŒºåˆ†ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼å­ã©ã‚‚ï¼ˆæ˜ç¤ºï¼‰
  $("#ad_segment").value = "å­ã©ã‚‚";

  adminTypeChangeAdapt();
  logAdmin("");
}
function fillAdminFormFromItem(it){
  adminMode = "edit";
  adminEditingId = it.id || "";
  $("#adminFormTitle").textContent = `ç·¨é›†ï¼š${adminEditingId}`;
  $("#adminEditingId").style.display = "";
  $("#adminEditingId").textContent = `ID: ${adminEditingId}`;
  $("#btnAdminSubmit").textContent = "ä¿å­˜";

  $("#ad_title").value = it.title || "";
  $("#ad_type").value  = it.type || "";
  $("#ad_ymd").value   = toDateInputFromYmdSlash(it.ymd || "");
  $("#ad_hm").value    = it.hm || "";
  $("#ad_place").value = it.place || "";
  $("#ad_meetAt").value = it.meetAt || "";
  $("#ad_meetPlace").value = it.meetPlace || "";
  $("#ad_attendTarget").value = (it.attendTarget||"N");
  $("#ad_deadline").value = toDateInputFromYmdSlash(it.deadline || "");
  $("#ad_publish").value = it.publish || "Yes";
  $("#ad_status").value  = it.status  || "active";
  $("#ad_status").disabled = false; // â˜… è¿½åŠ ï¼šç·¨é›†æ™‚ã¯ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’æœ‰åŠ¹åŒ–
  $("#ad_segment").value = it.segment || "å­ã©ã‚‚";

  adminTypeChangeAdapt();
  $("#ad_flag").value = it.flag || "N";
  if (![...$("#ad_flag").options].map(o=>o.value).includes($("#ad_flag").value)){
    $("#ad_flag").value = "N";
  }
  logAdmin("");
}
async function adminSubmit(){
  try{
    if (!state.isAdmin){ alert("ç®¡ç†è€…ã®ã¿åˆ©ç”¨ã§ãã¾ã™"); return; }
    logAdmin("");

    const type  = $("#ad_type").value.trim();
    let   title = $("#ad_title").value.trim();
    const ymdIn = $("#ad_ymd").value.trim();   // yyyy-mm-dd
    const hm    = $("#ad_hm").value.trim();
    const place = $("#ad_place").value.trim();
    const meetAt= $("#ad_meetAt").value.trim();
    const meetPl= $("#ad_meetPlace").value.trim();
    const attT  = $("#ad_attendTarget").value.trim().toUpperCase();
    const dlIn  = $("#ad_deadline").value.trim();
    const pub   = $("#ad_publish").value.trim();
    const st = (adminMode === "create") ? "active" : $("#ad_status").value.trim();
    const segRaw = $("#ad_segment").value.trim(); // â† è¿½åŠ 
    let seg = segRaw;
    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¡¨è¨˜ã‚†ã‚Œã‚’æ­£ã™ï¼ˆã‚¹ãƒ—ã‚·å´ï¼šå­ã©ã‚‚/å¤§äºº/ä¸¡æ–¹ ã‚’æƒ³å®šï¼‰
    if (seg.includes("å¤§äºº")) seg = "å¤§äºº";
    else if (seg.includes("å­ã©ã‚‚") || seg.includes("å­ä¾›")) seg = "å­ã©ã‚‚";
    else if (seg.includes("ä¸¡æ–¹")) seg = "ä¸¡æ–¹";

    if (!title || !type || !ymdIn){ throw new Error("ã‚¿ã‚¤ãƒˆãƒ«/ç¨®åˆ¥/å…¬æ¼”æ—¥ã¯å¿…é ˆã§ã™"); }

    // â‘£-2 å¤§äººã®éƒ¨ãªã‚‰ã‚¿ã‚¤ãƒˆãƒ«å…ˆé ­ã«ã€å¤§äººã®éƒ¨ã€‘ã‚’å¿…ãšä»˜ä¸ï¼ˆç¨®åˆ¥å•ã‚ãšï¼‰
    if (seg === "å¤§äºº" && !title.startsWith("ã€å¤§äººã®éƒ¨ã€‘")){
      title = `ã€å¤§äººã®éƒ¨ã€‘${title}`;
    }

    if (type === "ç™ºè¡¨"){
      const flag = $("#ad_flag").value.trim();
      const allowed = (adminMode==="create") ? ["Y","N"] : ["Y","S","D","N"];
      if (!flag || !allowed.includes(flag)){
        throw new Error(adminMode==="create"
          ? "é…ä¿¡ãƒ•ãƒ©ã‚°ã¯ Y ã¾ãŸã¯ N ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆç™ºè¡¨/æ–°è¦ï¼‰"
          : "é…ä¿¡ãƒ•ãƒ©ã‚°ã¯ Y/S/D/N ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ï¼ˆç™ºè¡¨/ç·¨é›†ï¼‰"
        );
      }
    }

    let meetAtSend = meetAt, meetPlSend = meetPl, attSend = attT, dlSend = dlIn;
    if (type==="ç·´ç¿’"){
      meetAtSend = ""; meetPlSend = ""; attSend = "N"; dlSend = "";
    }
    if (type!=="ç™ºè¡¨"){ attSend = "N"; }

    const ymd = toYmdSlashFromDateInput(ymdIn);
    const dl  = dlSend ? toYmdSlashFromDateInput(dlSend) : "";

    $("#btnAdminSubmit").disabled = true;
    $("#btnAdminSubmit").textContent = (adminMode==="edit" ? "ä¿å­˜ä¸­â€¦" : "ç™»éŒ²ä¸­â€¦");

    // â˜… é€ä¿¡ï¼š&segment= ã‚’å¸¸ã«ä»˜ä¸
    let urlBase = `?adminUpsertSchedule=1&lineId=${esc(state.lineId)}`
      + `&type=${esc(type)}&title=${esc(title)}&ymd=${esc(ymd)}`
      + (hm?`&hm=${esc(hm)}`:"")
      + (place?`&place=${esc(place)}`:"")
      + (meetAtSend?`&meetAt=${esc(meetAtSend)}`:"")
      + (meetPlSend?`&meetPlace=${esc(meetPlSend)}`:"")
      + `&attendTarget=${esc(attSend)}`
      + (dl?`&deadline=${esc(dl)}`:"")
      + `&publish=${esc(pub)}&status=${esc(st)}`
      + `&segment=${esc(seg)}`;

    let res;
    if (adminMode === "create"){
      // flag ã¯ç™ºè¡¨ã®ã¿æœ‰åŠ¹
      if (type==="ç™ºè¡¨"){
        const flag = $("#ad_flag").value.trim();
        urlBase += `&flag=${esc(flag)}`;
      } else {
        urlBase += `&flag=N`;
      }
      res = await api(urlBase);
      if (res.status!=="ok") throw new Error(res.message||"ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ");
      alert(`ç™»éŒ²ã—ã¾ã—ãŸï¼ˆID: ${res.id || "(ä¸æ˜)"}ï¼‰`);
      enterAdminCreateMode();
      await adminListFetch();

    } else {
      if (!adminEditingId){ throw new Error("ç·¨é›†å¯¾è±¡IDãŒä¸æ­£ã§ã™"); }
      const url = urlBase + `&id=${esc(adminEditingId)}`
        + (type==="ç™ºè¡¨" ? `&flag=${esc($("#ad_flag").value.trim())}` : `&flag=N`);
      res = await api(url);
      if (res.status!=="ok") throw new Error(res.message||"ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      await adminListFetch();
    }
  }catch(err){
    logAdmin(err.message || String(err));
  }finally{
    $("#btnAdminSubmit").disabled = false;
    $("#btnAdminSubmit").textContent = (adminMode==="edit" ? "ä¿å­˜" : "æ–°è¦ç™»éŒ²");
  }
}
 async function adminListFetch(){
  try{
    const top = document.getElementById('adminListBoxTop');
    if (top) top.innerHTML = `èª­ã¿è¾¼ã¿ä¸­â€¦ <span class="spinner"></span>`;

    const days = Number($("#ad_days").value || 60);
    const r = await api(`?adminListSchedules=1&lineId=${esc(state.lineId)}&days=${esc(days)}`);

    if (r.status !== "ok" || !Array.isArray(r.items)){
      if (top) top.innerHTML = `<span class="err">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</span>`;
      return;
    }
    if (r.items.length === 0){
      if (top) top.innerHTML = `<div class="listEmpty">è©²å½“ã™ã‚‹äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }

    // æ­£è¦åŒ–ã—ã¦ã€Œç”Ÿé…åˆ—ã€ã‚’ä¿æŒï¼ˆã“ã“ã§ã¯ãƒ•ã‚£ãƒ«ã‚¿ã—ãªã„ï¼‰
    const raw = r.items.map(raw => ({
      id: raw.id || "",
      type: raw.type || "",
      title: raw.title || "",
      ymd: raw.ymd || "",
      hm: raw.hm || "",
      place: raw.place || "",
      meetAt: raw.meetAt || "",
      meetPlace: raw.meetPlace || "",
      attendTarget: raw.attendTarget || "N",
      deadline: raw.deadline || "",
      publish: raw.publish || "No",
      status: raw.status || "archived",
      flag: raw.flag || "N",
      segment: raw.segment || raw.targetSegment || raw.attendSegment || ""
    }));
    // ... ä¸€è¦§ã® innerHTML ã‚’æ›´æ–°ã—ãŸç›´å¾Œ
    window.setupAdminAccordion?.();
    // â˜… ç”Ÿé…åˆ—ã‚’ä¿å­˜ï¼ˆä¸Šæ›¸ãç¦æ­¢ï¼šã“ã®é…åˆ—ã‚’å¸¸ã«åŸºæº–ã«ã™ã‚‹ï¼‰
    state.adminItemsRaw = raw;

    // ç·¨é›†ç”¨ãƒãƒƒãƒ—ã¯ã€Œå…¨ä»¶ã€ã‹ã‚‰ä½œã‚‹ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«çµã‚Šè¾¼ã¿å¾Œã‚‚ç·¨é›†ã§ãã‚‹ã‚ˆã†ã«ï¼‰
    adminItemsMap = {};
    raw.forEach(it => { adminItemsMap[String(it.id)] = it; });

    // ç¾åœ¨ã®UIå€¤ã§ãƒ­ãƒ¼ã‚«ãƒ«æç”»
    adminListRenderLocal();

  }catch(err){
    const msg = `<span class="err">ã‚¨ãƒ©ãƒ¼ï¼š${err.message||err}</span>`;
    const topEl = document.getElementById('adminListBoxTop');
    if (topEl) topEl.innerHTML = msg;
  }
}
 function adminListRenderLocal(){
  const top = document.getElementById('adminListBoxTop');
  if (!top) return;

  // ã¾ã fetchã—ã¦ãªã„å ´åˆã®ã‚¬ãƒ¼ãƒ‰
  const base = Array.isArray(state.adminItemsRaw) ? state.adminItemsRaw.slice() : [];
  if (base.length === 0){
    top.innerHTML = `<div class="listEmpty">èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­ï¼ˆã€Œä¸€è¦§ã‚’å–å¾—ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</div>`;
    return;
  }

  const days = Number($("#ad_days").value || 60);
  const segFilter = $("#ad_seg_filter")?.value || "";

  // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä»Šæ—¥ã€œdaysï¼‰
  const today = new Date(); today.setHours(0,0,0,0);
  const until = new Date(today.getTime()); until.setDate(until.getDate()+days);

  const ymdToDate = (s)=>{
    const m = String(s||"").match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
    if (!m) return null;
    const d = new Date(+m[1], +m[2]-1, +m[3]); d.setHours(0,0,0,0);
    return isNaN(d) ? null : d;
  };

  // â˜… base ã‚’å…ƒã«ãƒ­ãƒ¼ã‚«ãƒ«çµã‚Šè¾¼ã¿
  let viewItems = base.filter(it=>{
    const d = ymdToDate(it.ymd);
    return d && d >= today && d <= until;
  });

  if (segFilter){
    viewItems = viewItems.filter(it => normSeg(it.segment) === segFilter);
  }

  // ä¸¦ã³é †ï¼ˆç¾è¡Œã¨åŒã˜ã‚­ãƒ¼ï¼‰
  const ymdKey = (s) => {
    const t = String(s || "").replace(/-/g, "/");
    const m = t.match(/^(\d{4})\/(\d{2})\/(\d{2})$/);
    return m ? `${m[1]}${m[2]}${m[3]}` : "99999999";
  };
  const hmKey = (s) => {
    const m = String(s || "").match(/^(\d{1,2}):(\d{2})$/);
    return m ? `${String(m[1]).padStart(2,'0')}${m[2]}` : "9999";
  };
  viewItems.sort((a,b)=>
    ymdKey(a.ymd).localeCompare(ymdKey(b.ymd)) ||
    hmKey(a.hm).localeCompare(hmKey(b.hm)) ||
    String(a.title||"").localeCompare(String(b.title||"")) ||
    String(a.id||"").localeCompare(String(b.id||""))
  );

  // HTMLï¼ˆadminItemsMap ã¯å…¨ä»¶åˆ†ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾ä½¿ãˆã‚‹ï¼‰
  const html = viewItems.length
    ? viewItems.map(it => `
      <div class="card" data-seg="${normSeg(it.segment||'')||'both'}">
        <div><b>${it.ymd}${it.hm?` ${it.hm}`:""}</b> @ ${it.place||""}</div>
        <div class="small">${dispSeg(normSeg(it.segment||""))}ï½œ${it.type||""}ï¼š${it.title||""}</div>
        <div class="small muted">å‡ºæ¬ å¯¾è±¡:${it.attendTarget||"N"} / æœŸé™:${it.deadline||"(ãªã—)"} / å…¬é–‹:${it.publish||"No"} / çŠ¶æ…‹:${it.status||"archived"} / é…ä¿¡:${it.flag||"N"}</div>
        <div class="row" style="margin-top:8px; justify-content:flex-end;">
          <button class="btn btn-ghost btn-sm btn-compact btn-edit" type="button"
                  onclick="adminEdit(adminItemsMap['${String(it.id)}'])">ç·¨é›†</button>
        </div>
      </div>
    `).join("")
    : `<div class="listEmpty">è©²å½“ã™ã‚‹äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>`;

  top.innerHTML = html;
}
function adminEdit(obj){
  // ã¾ãšã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’ç¢ºå®Ÿã«é–‰ã˜ã‚‹
  window.closeAdminAccordion?.();

  // ãƒ•ã‚©ãƒ¼ãƒ ã¸åæ˜ 
  fillAdminFormFromItem(obj);

  // ãƒšãƒ¼ã‚¸å…ˆé ­ã§ã¯ãªãç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®è¦‹å‡ºã—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  document.getElementById('adminFormTitle')
    ?.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

<!-- ã“ã“ã‹ã‚‰ç½®ãæ›ãˆï¼ˆç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆï¼šè»½é‡ãƒ¡ã‚¿â†’è©³ç´°ï¼‰ -->
  // è¿½åŠ ã®çŠ¶æ…‹
  state.reportMeta = [];          // è»½é‡ä¸€è¦§ï¼ˆrowsç„¡ã—ï¼‰
  state.reportCache = {};         // id -> è©³ç´°ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  state.reportDetailMap = {};     // æ—¢å­˜ renderReport() äº’æ›ã‚­ãƒ£ãƒƒã‚·ãƒ¥

  const adminReport = {
    mounted: false,

    // â‘  ãƒ¡ã‚¿ã‚’å–å¾—ã—ã¦ã‚»ãƒ¬ã‚¯ãƒˆã«æµã—è¾¼ã‚€
    async loadMeta(){
      const sel = document.querySelector("#repEvent");
      if (!sel) return;
      sel.disabled = true;
      sel.innerHTML = `<option value="">ï¼ˆèª­ã¿è¾¼ã¿ä¸­â€¦ï¼‰</option>`;
      try {
        // â† èªå¯ç”¨ã« id ã‚’ä»˜ã‘ã‚‹ï¼ˆå¿…è¦ãªã‚‰ admin=1 ã‚‚ï¼‰
        const r = await api(`?attendanceReport=1&meta=1&lineId=${esc(state.lineId)}&admin=1`);
    
        if (r?.status === "ok" && Array.isArray(r.list)) {
          state.reportMeta = r.list;
          sel.innerHTML = `<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>` +
            r.list.map(e=>{
              const label = `${e.ymd || ""}${e.time ? " " + e.time : ""}  ${e.title || ""}`;
              return `<option value="${e.id}">${label}</option>`;
            }).join("");
        } else {
          const msg = r?.message || "ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ";
          console.error("meta error:", r);
          sel.innerHTML = `<option value="">å–å¾—ã‚¨ãƒ©ãƒ¼</option>`;
          document.querySelector("#repBox")?.replaceChildren(
            document.createTextNode(`ã‚¨ãƒ©ãƒ¼: ${msg}`)
          );
        }
      } catch (e) {
        console.error(e);
        sel.innerHTML = `<option value="">å–å¾—ã‚¨ãƒ©ãƒ¼</option>`;
        document.querySelector("#repBox")?.replaceChildren(
          document.createTextNode(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message || e}`)
        );
      } finally {
        sel.disabled = false;
      }
    },
       
    // â‘¡ ã‚»ãƒ¬ã‚¯ãƒˆå¤‰æ›´â†’ãã®1ä»¶ã ã‘è©³ç´°å–å¾—â†’renderReport ã‚’å‘¼ã¶
    async onChange(){
      const id  = document.querySelector("#repEvent")?.value || "";
      const box = document.querySelector("#repBox");
      if (!id){ if (box) box.textContent = "å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
    
      if (state.reportCache[id]) {
        state.report = [ state.reportCache[id] ];
        renderReport();
        return;
      }
    
      if (box) box.innerHTML = `èª­ã¿è¾¼ã¿ä¸­â€¦ <span class="spinner"></span>`;
      try{
        // åŸºæœ¬ã¯ lineId ã‚’ä»˜ã‘ãšå…¨ä»¶ã‚’å–ã‚Šã«è¡Œã
        let r = await api(`?attendanceReport=1&eventId=${encodeURIComponent(id)}&detail=1`);
        // ã‚µãƒ¼ãƒå´ã®èªå¯è¦ä»¶ã§ã‚¨ãƒ©ãƒ¼ãªã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (r?.status === "error") {
          r = await api(`?attendanceReport=1&eventId=${encodeURIComponent(id)}&detail=1&lineId=${esc(state.lineId)}&admin=1`);
        }
    
        const payload = r.detail || (r.status === "ok" ? r : null);
        if (!payload){
          const msg = r?.message || "äºˆæœŸã›ã¬å¿œç­”";
          console.error("detail error:", r);
          if (box) box.textContent = `ã‚¨ãƒ©ãƒ¼: ${msg}`;
          return;
        }
    
        state.reportCache[id] = payload; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        state.report = [ payload ];
        renderReport();
      } catch(e){
        console.error(e);
        if (box) box.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message || e}`;
      }
    },

    // åˆæœŸé…ç·š
    mount(){
      if (this.mounted) return;
      this.mounted = true;
      document.querySelector("#repEvent")?.addEventListener("change", ()=>this.onChange());
      // â† å®ŸHTMLã¯ #btnReportReload ãªã®ã§ã“ã¡ã‚‰ã«åˆã‚ã›ã¾ã™
      document.querySelector("#btnReportReload")?.addEventListener("click", ()=>this.loadMeta());
    }
  };

  // ç”»é¢ã‚’é–‹ã„ãŸã¨ãã«å‘¼ã¶
  // ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆåˆæœŸåŒ–ï¼ˆå…¬æ¼”ãƒ¡ã‚¿ä¸€è¦§ã®å–å¾—ï¼†ã‚»ãƒ¬ã‚¯ãƒˆæ›´æ–°ï¼‰
    async function initAdminReportPage(){
      if (!state.isAdmin){
        document.getElementById('repBox').textContent = 'æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
        return;
      }
      const repBox = document.getElementById('repBox');
      const sel    = document.getElementById('repEvent');
      repBox.textContent = 'å…¬æ¼”ä¸€è¦§ã‚’å–å¾—ä¸­â€¦';
    
      try{
        const meta = await api(`?attendanceReport=1&meta=1&lineId=${esc(state.lineId)}&admin=1`);
        if (meta?.status !== 'ok') throw new Error(meta?.message || 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
    
        const list = Array.isArray(meta.list) ? meta.list :
                     Array.isArray(meta.meta) ? meta.meta : [];
        state.reportMeta = list;
    
        const prev = sel?.value || '';
        sel.innerHTML = '<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>' + list.map(e => {
          const id    = String(e.id || e.eventId || e.eid || '');
          const date  = e.ymd || e.date || '';
          const time  = e.hm || e.time || '';
          const title = e.title || e.name || '';
          return `<option value="${id}">${date}${time ? ` ${time}`:''}ï½œ${title}</option>`;
        }).join('');
    
        if (prev && Array.from(sel.options).some(o => o.value === prev)) sel.value = prev;
    
        repBox.textContent = sel.value ? 'èª­ã¿è¾¼ã¿ä¸­â€¦' : 'å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„';
        if (sel.value) renderReport();  // ç›´å‰ã®é¸æŠãŒæ®‹ã£ã¦ã„ã‚Œã°è‡ªå‹•æç”»
      }catch(e){
        repBox.textContent = e.message || String(e);
      }
    }
<!-- ã“ã“ã¾ã§ç½®ãæ›ãˆ -->
  
// ===== ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆå†èª­è¾¼ï¼ˆäº’æ›ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼‰ =====
window.reportReload = function(){ initAdminReportPage(); };
  
  // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šstate.report ã‹ã‚‰ã‚»ãƒ¬ã‚¯ãƒˆã‚’å…¨é¢å†æç”» ---
  function drawEventSelectFromReport(){
    if (!selEvent) return;
    selEvent.innerHTML = `<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>`;

    const items = (state.report || []).slice().sort((a,b)=>
      String(a.ymd||"").localeCompare(String(b.ymd||"")) ||
      String(a.time||"").localeCompare(String(b.time||"")) ||
      String(a.title||"").localeCompare(String(b.title||""))
    );

    for (const e of items){
      const opt = document.createElement("option");
      // â˜… id / eventId ã®ã©ã¡ã‚‰ã§ã‚‚OKã«
      opt.value = String(e.id ?? e.eventId ?? "");
      opt.textContent = `${e.ymd || ""}${e.time ? " " + e.time : ""}  ${e.title || ""}`;
      selEvent.appendChild(opt);
    }
    selEvent.disabled = false;
  }

    /* ===== å‡ºæ¬ çµæœä¸€è¦§ï¼ˆç®¡ç†è€…ï¼‰ 1æšã‚«ãƒ¼ãƒ‰ç‰ˆ ===== */
    function fmtYmd(s){
      const m = String(s||'').match(/^(\d{4})[\/\-](\d{2})[\/\-](\d{2})$/);
      if (!m) return String(s||'');
      const d = new Date(+m[1], +m[2]-1, +m[3]);
      const yo = 'æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ'[d.getDay()];
      return `${m[1]}/${m[2]}/${m[3]}ï¼ˆ${yo}ï¼‰`;
    }
    function fmtTime(s){
      const m = String(s||'').match(/^(\d{1,2}):(\d{2})/);
      if (m) return `${String(+m[1]).padStart(2,'0')}:${m[2]}`;
      const d = new Date(s||'');
      return isNaN(d) ? '' : `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
    }
    function fmtDateTime(dt){
      if (!dt) return '';
      // æœŸå¾…ã•ã‚Œã‚‹ã‚­ãƒ¼ã«åºƒãå¯¾å¿œ
      const v = (dt.updatedAt||dt.answeredAt||dt.timestamp||dt.at||'').toString();
      if (v && !isNaN(new Date(v))) {
        const d = new Date(v);
        const z = n => String(n).padStart(2,'0');
        return `${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
      }
      return String(v||'');
    }
    function mapSeg(raw){
      const s = String(raw||'');
      if (s.includes('å¤§äºº')) return {cls:'seg-adult', label:'å¤§äººã®éƒ¨'};
      if (s.includes('å­'))   return {cls:'seg-child', label:'å­ã©ã‚‚ã®éƒ¨'};
      if (s.includes('ä¸¡'))   return {cls:'seg-both',  label:'ä¸¡æ–¹'};
      return {cls:'', label:''};
    }
    function acceptingBadge(accepting){
      const v = String(accepting||'').toLowerCase();
      if (v==='open' || v==='å—ä»˜ä¸­') return `<span class="badge-status open">å—ä»˜ä¸­</span>`;
      if (v==='closed' || v==='ç· åˆ‡' || v==='ç· ã‚åˆ‡ã‚Š' || v==='ç· åˆ‡æ¸ˆ') return `<span class="badge-status closed">ç· åˆ‡</span>`;
      return '';
    }
    function groupByAttend(detail){
      // APIå·®ç•°ã«å¼·ãï¼šyes/no/maybe/na ã‹ã€flat list ã‚’å—ã‘ã‚‹
      const groups = { yes:[], no:[], maybe:[], na:[] };
      const push = (k, it) => { if (it) groups[k].push(it); };
      if (Array.isArray(detail.yes) || Array.isArray(detail.no) || Array.isArray(detail.maybe) || Array.isArray(detail.na)){
        ['yes','no','maybe','na'].forEach(k => (detail[k]||[]).forEach(x=>push(k,x)));
      } else {
        const list = detail.list || detail.members || detail.rows || [];
        list.forEach(it=>{
          const a = (it.attend||it.answer||'').trim();
          if (a==='å‚åŠ ') push('yes', it);
          else if (a==='æ¬ å¸­') push('no', it);
          else if (a==='æœªå®š') push('maybe', it);
          else push('na', it);
        });
      }
      return groups;
    }
    function labelFor(k){ return k==='yes'?'å‚åŠ ':k==='no'?'æ¬ å¸­':k==='maybe'?'æœªå®š':'æœªå›ç­”'; }

/* ===== ç®¡ç†ãƒ¬ãƒãƒ¼ãƒˆï¼šãƒ¡ã‚¿å–å¾— â†’ 1ä»¶è©³ç´° â†’ æç”»ï¼ˆå …ç‰¢ç‰ˆï¼‰ ===== */
(function(){
  if (window.__AdminReportV__ >= 2) return;
  window.__AdminReportV__ = 2;

  // é…åˆ—æŠ½å‡ºï¼šrows/list/answers/data/â€¦ã®ã©ã‚Œã‹æœ€åˆã«è¦‹ã¤ã‹ã£ãŸé…åˆ—ã‚’è¿”ã™
  function pickRows(p){
    if (!p) return [];
    const cands = [
      p.rows, p.list, p.answers, p.data, p.members, p.records,
      (Array.isArray(p.detail) ? p.detail : null),
      (p.report && Array.isArray(p.report.rows) ? p.report.rows : null),
      (p.report && Array.isArray(p.report.list) ? p.report.list : null),
    ];
    for (const c of cands) if (Array.isArray(c)) return c;
    return [];
  }
  // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSS/å´©ã‚Œé˜²æ­¢ï¼‰
  function h(s){
    return String(s ?? '').replace(/[&<>"']/g, m => (
      { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]
    ));
  }
  // è¡Œã®æ­£è¦åŒ–
  function mapRow(x){
    const name   = x.name ?? x.member ?? x.performerName ?? x.performer ?? '';
    const raw    = x.answer ?? x.attend ?? x.attendStatus ?? x.status ?? '';
    const attend = ['å‚åŠ ','æ¬ å¸­','æœªå®š','æœªå›ç­”'].includes(String(raw).trim())
      ? String(raw).trim()
      : (String(raw || '').trim() || 'æœªå›ç­”');
    const at     = x.updatedAt ?? x.updated ?? x.time ?? x.ts ?? '';
    const seg    = x.segment ?? x.seg ?? x.category ?? '';
    // â–¼ ã‚³ãƒ¡ãƒ³ãƒˆå€™è£œï¼ˆã‚µãƒ¼ãƒå·®ç•°ã‚’åºƒã‚ã«å¸åï¼‰
    const comment = x.comment ?? x.eventComment ?? x.memo ?? x.note ?? x.remarks ?? x.remark ?? x.Comment ?? x['ã‚³ãƒ¡ãƒ³ãƒˆ'] ?? '';
    return { name, attend, at, seg, comment };
  }
  // --- â‘¡ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸Šã‚ãŸã‚Šã«è¿½åŠ  ---
  function repFormatAt(at){
    if (!at) return "";
    const d = new Date(at);
    if (isNaN(d)) return `å›ç­”ï¼š${String(at)}`;
    const z = n => String(n).padStart(2,"0");
    return `å›ç­”ï¼š${d.getFullYear()}/${z(d.getMonth()+1)}/${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
  }
  function badgeCls(att){
    return att==='å‚åŠ ' ? 'yes' : att==='æ¬ å¸­' ? 'no' : att==='æœªå®š' ? 'maybe' : 'na';
  }
  // å‡ºæ¬ çµæœã®æç”»ï¼ˆ#repEvent ã® value ã‚’ eventId ã¨ã¿ãªã—ã¦å–å¾—ï¼‰
  async function renderReport(){
    const lid = encodeURIComponent(state.lineId || "");
    const sel = document.getElementById('repEvent');
    const box = document.getElementById('repBox');
    const id  = sel?.value || '';
    if (!id){ if (box) box.textContent = 'å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
  
    box.innerHTML = 'çµæœã‚’å–å¾—ä¸­â€¦ <span class="spinner"></span>';
  
    // 1) eventId ã§å–å¾—
    let resp;
    try{
      resp = await api(`?attendanceReport=1&eventId=${encodeURIComponent(id)}&detail=1&admin=1&lineId=${lid}`);
    }catch(e){ console.error('fetch error(eventId):', e); }
  
    let payload = resp && (resp.detail || resp);
    let list    = pickRows(payload);
  
    // 2) ã†ã¾ãå–ã‚Œãªã‘ã‚Œã° id ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    if (!(resp?.status === 'ok') || list.length === 0){
      try{
        const r2 = await api(`?attendanceReport=1&id=${encodeURIComponent(id)}&detail=1&admin=1&lineId=${lid}`);
        const p2 = r2 && (r2.detail || r2);
        const l2 = pickRows(p2);
        if (r2?.status === 'ok' && l2.length){
          resp = r2; payload = p2; list = l2;
        }
      }catch(e){ console.error('fallback fetch error(id):', e); }
    }
  
    if (!(resp?.status === 'ok')){
      box.textContent = resp?.message || 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
      console.warn('report resp:', resp);
      return;
    }
  
    // â˜… å®¶æ—ãƒ•ã‚£ãƒ«ã‚¿ã¯ä¸€åˆ‡ã—ãªã„ï¼ˆ= å…¨å“¡è¡¨ç¤ºï¼‰
    const rows = list.map(mapRow);
  
    // ===== ã“ã“ã‹ã‚‰ï¼šæœªå›ç­”ã®åˆæˆï¼ˆroster ãŒæ–‡å­—åˆ—é…åˆ—ã§ã‚‚OKï¼‰ =====
    const normName = s => String(s||'').replace(/\u3000/g,' ').replace(/\s+/g,' ').trim();
  
    // å›ç­”æ¸ˆã¿ã®åå‰é›†åˆï¼ˆæ­£è¦åŒ–ï¼‰
    const answered = new Set(rows.map(r => normName(r.name)).filter(Boolean));
  
    // å€™è£œåï¼ˆrosterå„ªå…ˆã€‚ç„¡ã‘ã‚Œã° members / candidates ã‹ã‚‰åå‰æ¬„ã‚’æ‹¾ã†ï¼‰
    let candidates = [];
    if (Array.isArray(payload?.roster)) {
      // GAS å´ã¯ roster ã‚’ ["æ°å", ...] ã§è¿”ã™æƒ³å®š
      candidates = payload.roster.map(normName).filter(Boolean);
    } else if (Array.isArray(payload?.members)) {
      candidates = payload.members
        .map(m => normName(m?.name ?? m?.member ?? m?.performerName ?? ''))
        .filter(Boolean);
    } else if (Array.isArray(payload?.candidates)) {
      candidates = payload.candidates
        .map(m => normName(m?.name ?? m?.member ?? m?.performerName ?? ''))
        .filter(Boolean);
    }
  
    // æœªå›ç­” = å€™è£œ âˆ’ å›ç­”æ¸ˆã¿
    const naRows = candidates
      .filter(nm => !answered.has(nm))
      .map(nm => ({ name: nm, attend: 'æœªå›ç­”', at: '', seg: '' }));
  
    // rows ã‚’æœªå›ç­”ã§æ‹¡å¼µ
    const rowsAll = rows.concat(naRows);
    // ===== ã“ã“ã¾ã§ =====
  
    // ãƒ•ã‚£ãƒ«ã‚¿
    const f = document.getElementById('repAttend')?.value || '';
    const view = rowsAll.filter(r => !f || (f === 'æœªå›ç­”' ? r.attend === 'æœªå›ç­”' : r.attend === f));
  
    // é›†è¨ˆ
    const cnt = {
      yes:   rowsAll.filter(r => r.attend === 'å‚åŠ ').length,
      no:    rowsAll.filter(r => r.attend === 'æ¬ å¸­').length,
      maybe: rowsAll.filter(r => r.attend === 'æœªå®š').length,
      na:    rowsAll.filter(r => r.attend === 'æœªå›ç­”').length,
      all:   rowsAll.length
    };
  
    // ãƒ˜ãƒƒãƒ€æƒ…å ±
    const title = payload.title || payload.eventTitle || payload.name || '';
    const date  = payload.ymd   || payload.date || '';
    const time  = payload.hm    || payload.time || '';
    const place = payload.place || payload.venue || '';
    // accepting ãŒæ¥ã¦ã„ã‚Œã°ãã‚Œã‚’å„ªå…ˆï¼ˆ'closed' ãªã‚‰ç· åˆ‡ï¼‰
    const open = (typeof payload.accepting !== 'undefined')
      ? (String(payload.accepting).toLowerCase() !== 'closed')
      : ((payload.isOpen ?? payload.open ?? payload.status === 'open') ? true : false);
  
    const head = `
      <div class="repHeader">
        <!-- 1è¡Œç›®ï¼šã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ -->
        <div class="repLine">
          <div class="repLeft">
            <span class="repTitle">${title || '(ç„¡é¡Œ)'}</span>
          </div>
        </div>
    
        <!-- 2è¡Œç›®ï¼šæ—¥æ™‚ãƒ»@å ´æ‰€ï¼ˆå·¦ï¼‰ï¼å—ä»˜ä¸­ãƒãƒƒã‚¸ï¼ˆå³ï¼‰ -->
        <div class="repLine repHeadRow">
          <div class="repLeft">
            <span>${date}${time ? ` ${time}` : ''}</span>
            ${place ? `<span class="repPlace"> @${place}</span>` : ''}
          </div>
          <div class="repRight">
            <span class="badge-status ${open ? 'open' : 'closed'}">${open ? 'å—ä»˜ä¸­' : 'ç· åˆ‡'}</span>
          </div>
        </div>
      </div>`;

    // å‡ºæ¬ ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼ˆç”»é¢ãƒ•ã‚£ãƒ«ã‚¿ã‚’åæ˜ ã—ãŸ view ã‚’å¯¾è±¡ã«ï¼‰
    const by = { 'å‚åŠ ':[], 'æœªå®š':[], 'æ¬ å¸­':[], 'æœªå›ç­”':[] };
    view.forEach(r => (by[r.attend] ? by[r.attend] : by['æœªå›ç­”']).push(r));
    
    // è¡¨ç¤ºé †ã€‚ãƒ•ã‚£ãƒ«ã‚¿ãŒã‹ã‹ã£ã¦ã„ã‚‹æ™‚ã¯ãã®ã‚°ãƒ«ãƒ¼ãƒ—ã ã‘å‡ºã™
    const order = (f ? [f] : ['å‚åŠ ','æœªå®š','æ¬ å¸­','æœªå›ç­”']);
    
    const body = order.map(k=>{
      const arr = by[k] || [];
      if (!arr.length) return "";
      return `
        <div class="repGroup">
          <div class="repGroupHead">
            <span class="badge-att ${badgeCls(k)}">${k}</span>
            <span class="repCount">${arr.length}å</span>
          </div>
         ${arr.map(p => `
          <div class="repPersonRow">
            <div class="repName">${h(p.name)}</div>
            <div class="repAt">${
              (p.comment && `<span class="repComment">${h(String(p.comment).trim())}</span>`)
              || repFormatAt(p.at)
              || ''
            }</div>
          </div>
        `).join("")}
        </div>
      `;
    }).join("") || `<div class="repNA">è©²å½“è€…ãŒã„ã¾ã›ã‚“</div>`;
    // â–² ã“ã“ã¾ã§ç½®æ›
    
    repBox.innerHTML = `<div class="repCard">${head}${body}</div>`;
  }

  // å…¬æ¼”ãƒ¡ã‚¿ï¼ˆã‚»ãƒ¬ã‚¯ãƒˆã®é¸æŠè‚¢ï¼‰ã‚’å–å¾—ã—ã¦ #repEvent ã‚’åŸ‹ã‚ã‚‹
  async function loadReportMeta(){
    const sel = document.getElementById('repEvent');
    const box = document.getElementById('repBox');
    if (!sel) return;
  
    // å¤ã„ãƒ¡ã‚¿ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢ï¼ˆå¤±æ•—æ™‚ã®å–ã‚Šé•ãˆé˜²æ­¢ï¼‰
    state.reportMeta = [];
  
    sel.disabled = true;
    sel.innerHTML = `<option value="">ï¼ˆèª­ã¿è¾¼ã¿ä¸­â€¦ï¼‰</option>`;
    try{
      // èªå¯ã®éƒ½åˆã§ lineId/admin ã‚’ä»˜ã‘ã¦å–å¾—
      const r = await api(`?attendanceReport=1&meta=1&lineId=${encodeURIComponent(state.lineId)}&admin=1`);
      if (r?.status === 'ok' && Array.isArray(r.list)){
        // â˜… ã“ã“ã§ä¿å­˜
        state.reportMeta = r.list;
  
        const opts = r.list.map(e=>{
          // value ã¯ eventId ã‚’æœ€å„ªå…ˆï¼ˆãªã‘ã‚Œã° id/eidï¼‰
          const id = String(e.eventId ?? e.eventID ?? e.event_id ?? e.id ?? e.eid ?? '');
          const label = `${e.ymd || e.date || ''}${e.time ? ' ' + e.time : ''}  ${e.title || e.name || ''}`;
          return `<option value="${id}">${label}</option>`;
        }).join('');
        sel.innerHTML = `<option value="">ï¼ˆé¸æŠã—ã¦ãã ã•ã„ï¼‰</option>` + opts;
      }else{
        const msg = r?.message || 'ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸ';
        console.error('meta error:', r);
        sel.innerHTML = `<option value="">å–å¾—ã‚¨ãƒ©ãƒ¼</option>`;
        if (box) box.textContent = `ã‚¨ãƒ©ãƒ¼: ${msg}`;
      }
    }catch(e){
      console.error(e);
      sel.innerHTML = `<option value="">å–å¾—ã‚¨ãƒ©ãƒ¼</option>`;
      if (box) box.textContent = `é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message || e}`;
    }finally{
      sel.disabled = false;
    }
  }

  // ç”»é¢ã‚’é–‹ã„ãŸç›´å¾Œ/å†å–å¾—ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã¶
  async function initAdminReportPage(){
    await loadReportMeta();
    const box = document.getElementById('repBox');
    if (box) box.textContent = 'å…¬æ¼”ã‚’é¸æŠã—ã¦ãã ã•ã„';
  }

  // æ—¢å­˜ãƒãƒ³ãƒ‰ãƒ©ã¨ã¤ãªãŒã‚‹ã‚ˆã†ã«å…¬é–‹
  window.renderReport = renderReport;
  window.initAdminReportPage = initAdminReportPage;
  window.reportReload = function(){ initAdminReportPage(); };
})();

</script> 
  
<script>
// ===== èµ·å‹• =====
document.addEventListener('DOMContentLoaded', () => {
  try { init(); } catch (e) { console.error(e); }
});
</script>
